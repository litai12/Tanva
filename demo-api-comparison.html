<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI API é€Ÿåº¦å¯¹æ¯”æµ‹è¯•</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.25);
        }
        button:disabled {
            cursor: wait;
            background: #cbd5f5;
            box-shadow: none;
            transform: none;
        }
        .result {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .image-result {
            text-align: center;
            margin: 20px 0;
        }
        .image-result img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .debug-info h3 {
            margin-top: 0;
            color: #495057;
        }
        .api-config {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .api-config h3 {
            margin-top: 0;
            color: #495057;
        }
        .comparison-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comparison-card h4 {
            margin-top: 0;
            color: #495057;
        }
        .timing-breakdown {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ AI API é€Ÿåº¦å¯¹æ¯”æµ‹è¯•</h1>
        <p>å¯¹æ¯”ä¸åŒAPIæä¾›å•†çš„å“åº”é€Ÿåº¦å’Œæ€§èƒ½è¡¨ç°</p>
        
        <div class="api-config">
            <h3>ğŸ“‹ APIé…ç½®è¯´æ˜</h3>
            <ul>
                <li><strong>Google ç›´è” API</strong>: ğŸ”‘ å·²é…ç½®çœŸå®Keyï¼Œå¯èƒ½é‡åˆ°CORSé—®é¢˜</li>
                <li><strong>147 API</strong>: ğŸ”‘ å·²æ›´æ–°ä¸ºæ–°çš„æœ‰æ•ˆKeyï¼Œæ¨èç”¨äºæµ‹è¯•</li>
                <li><strong>é…·çˆ± API</strong>: ğŸ”‘ å·²é¢„è®¾Keyï¼Œä½¿ç”¨Bearerè®¤è¯ï¼Œç¨³å®šæ€§è¾ƒå¥½</li>
            </ul>
            <p style="color: #28a745; font-weight: bold;">
                âœ… æ‰€æœ‰API Keyå·²é¢„è®¾ï¼Œé€‰æ‹©æä¾›å•†å³å¯ç›´æ¥æµ‹è¯•
            </p>
            <p style="color: #dc3545; font-weight: bold;">
                âš ï¸ å¦‚æœGoogleç›´è”APIå¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨147APIæˆ–é…·çˆ±APIè¿›è¡Œæµ‹è¯•
            </p>
        </div>
        
        <form id="testForm">
            <div class="form-group">
                <label for="apiProvider">é€‰æ‹©APIæä¾›å•†:</label>
                <select id="apiProvider" required>
                    <option value="google">Google ç›´è” API</option>
                    <option value="147api">147 API</option>
                    <option value="kuai">é…·çˆ± API</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input type="password" id="apiKey" placeholder="è‡ªåŠ¨å¡«å……é¢„è®¾API Key" required readonly style="background-color: #f8f9fa;">
                <small style="color: #6c757d; font-size: 12px;">
                    ğŸ’¡ å·²é¢„è®¾å¸¸ç”¨API Keyï¼Œé€‰æ‹©å¯¹åº”æä¾›å•†å³å¯ä½¿ç”¨
                </small>
            </div>
            
            <div class="form-group">
                <label for="prompt">æç¤ºè¯:</label>
                <textarea id="prompt" placeholder="è¾“å…¥å›¾åƒç”Ÿæˆæç¤ºè¯" required>ç”»ä¸€åªå¯çˆ±çš„æ©˜çŒ«ï¼Œæˆ´ç€å¤ªç©ºå¤´ç›”ï¼Œåœ¨æœˆçƒæ¼«æ­¥</textarea>
            </div>
            
            <div class="form-group">
                <label for="aspectRatio">é•¿å®½æ¯”:</label>
                <select id="aspectRatio">
                    <option value="auto">è‡ªåŠ¨</option>
                    <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                    <option value="3:4">3:4 ç«–å±</option>
                    <option value="4:3">4:3 æ¨ªå±</option>
                    <option value="9:16">9:16 æ‰‹æœºç«–å±</option>
                    <option value="16:9">16:9 å®½å±</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="imageOnly">å“åº”æ¨¡å¼:</label>
                <select id="imageOnly">
                    <option value="false">å›¾åƒ + æ–‡æœ¬</option>
                    <option value="true">ä»…å›¾åƒ</option>
                </select>
            </div>
            
            <button type="submit" id="generateBtn">å¼€å§‹æµ‹è¯•</button>
        </form>
        
        <div style="margin: 20px 0; text-align: center;">
            <button id="testAllBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: auto; padding: 12px 30px;">
                ğŸš€ åŒæ—¶æµ‹è¯•æ‰€æœ‰API
            </button>
        </div>
        
        <div id="result" class="result"></div>
        <div id="imageResult" class="image-result"></div>
        <div id="debugInfo" class="debug-info" style="display: none;"></div>
        
        <div class="comparison-results" id="comparisonResults" style="display: none;">
            <div class="comparison-card">
                <h4>Google ç›´è” API</h4>
                <div id="googleResult">æœªæµ‹è¯•</div>
                <div id="googleDetails" class="timing-breakdown" style="display: none;"></div>
            </div>
            <div class="comparison-card">
                <h4>147 API</h4>
                <div id="147apiResult">æœªæµ‹è¯•</div>
                <div id="147apiDetails" class="timing-breakdown" style="display: none;"></div>
            </div>
            <div class="comparison-card">
                <h4>é…·çˆ± API</h4>
                <div id="kuaiResult">æœªæµ‹è¯•</div>
                <div id="kuaiDetails" class="timing-breakdown" style="display: none;"></div>
            </div>
        </div>
        
        <div id="performanceAnalysis" class="api-config" style="display: none;">
            <h3>ğŸ“Š æ€§èƒ½åˆ†æ</h3>
            <div id="analysisContent"></div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';

        const form = document.getElementById('testForm');
        const resultDiv = document.getElementById('result');
        const imageResultDiv = document.getElementById('imageResult');
        const debugInfoDiv = document.getElementById('debugInfo');
        const generateBtn = document.getElementById('generateBtn');
        const testAllBtn = document.getElementById('testAllBtn');
        const comparisonResults = document.getElementById('comparisonResults');

        // APIé…ç½®
        const apiConfigs = {
            google: {
                name: 'Google ç›´è” API',
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models',
                model: 'gemini-2.5-flash-image',
                authType: 'key',
                apiKey: 'AIzaSyDUKP60M4YLpyyStCOvntwDtPX0zvl5F64'
            },
            '147api': {
                name: '147 API',
                baseUrl: 'https://api1.147ai.com/v1beta/models',
                model: 'gemini-2.5-flash-image',
                authType: 'sk',
                apiKey: 'sk-WBd9sGus7I68Wwl9ivwfIBP148GzuF7ypLISfdUqlW5Ipj5P'
            },
            kuai: {
                name: 'é…·çˆ± API',
                baseUrl: 'https://apis.kuai.host/v1beta/models',
                model: 'gemini-2.5-flash-image-preview',
                authType: 'bearer',
                apiKey: 'sk-YO5bqpHjJ7zcm2iuukjsybBEKn9roLMrH4wLFYu15TBhY5lt'
            }
        };

        // APIæä¾›å•†åˆ‡æ¢æ—¶è‡ªåŠ¨å¡«å……API Key
        document.getElementById('apiProvider').addEventListener('change', function() {
            const selectedProvider = this.value;
            const apiKeyInput = document.getElementById('apiKey');
            const config = apiConfigs[selectedProvider];
            
            if (config && config.apiKey) {
                apiKeyInput.value = config.apiKey;
                console.log(`ğŸ”‘ å·²è‡ªåŠ¨å¡«å…… ${config.name} çš„API Key`);
            }
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¡«å……ç¬¬ä¸€ä¸ªAPIçš„Key
        document.addEventListener('DOMContentLoaded', function() {
            const firstProvider = document.getElementById('apiProvider').value;
            const apiKeyInput = document.getElementById('apiKey');
            const config = apiConfigs[firstProvider];
            
            if (config && config.apiKey) {
                apiKeyInput.value = config.apiKey;
                console.log(`ğŸ”‘ å·²è‡ªåŠ¨å¡«å…… ${config.name} çš„API Key`);
            }
        });

        function buildAuthorizationHeader(apiKey, authType) {
            if (!apiKey) {
                throw new Error('API Key ä¸èƒ½ä¸ºç©º');
            }
            
            switch (authType) {
                case 'key':
                    return apiKey; // Googleç›´è”ä½¿ç”¨keyå‚æ•°
                case 'sk':
                    return apiKey.replace(/^Bearer\s+/i, '').trim(); // 147APIä½¿ç”¨sk-æ ¼å¼
                case 'bearer':
                    if (/^Bearer\s+/i.test(apiKey)) {
                        return apiKey;
                    }
                    return `Bearer ${apiKey}`; // é…·çˆ±APIä½¿ç”¨Beareræ ¼å¼
                default:
                    return apiKey;
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const apiProvider = document.getElementById('apiProvider').value;
            const prompt = document.getElementById('prompt').value;
            const aspectRatio = document.getElementById('aspectRatio').value;
            const imageOnly = document.getElementById('imageOnly').value === 'true';

            // ä½¿ç”¨é¢„è®¾çš„API Key
            const config = apiConfigs[apiProvider];
            const apiKey = config.apiKey;

            if (!apiKey || apiKey.includes('xxxxxxxx')) {
                showResult(`è¯·å…ˆé…ç½® ${config.name} çš„æœ‰æ•ˆAPI Key`, 'error');
                return;
            }

            try {
                generateBtn.disabled = true;
                showResult(`æ­£åœ¨æµ‹è¯• ${apiConfigs[apiProvider].name}...`, 'loading');
                imageResultDiv.innerHTML = '';
                debugInfoDiv.style.display = 'none';

                const config = apiConfigs[apiProvider];
                const startTime = Date.now();
                const timings = {
                    start: startTime,
                    requestBuild: 0,
                    networkStart: 0,
                    networkEnd: 0,
                    parseStart: 0,
                    parseEnd: 0,
                    imageLoad: 0
                };

                let result;

                if (apiProvider === 'google') {
                    result = await testGoogleAPI(apiKey, prompt, aspectRatio, imageOnly, timings);
                } else {
                    result = await testHTTPAPI(config, apiKey, prompt, aspectRatio, imageOnly, timings);
                }

                timings.parseEnd = Date.now();
                const totalDuration = ((timings.parseEnd - timings.start) / 1000).toFixed(2);

                if (result.imageData) {
                    showResult(`${config.name} æµ‹è¯•æˆåŠŸï¼(æ€»è€—æ—¶: ${totalDuration}ç§’)`, 'success');
                    
                    // æ˜¾ç¤ºå›¾åƒ
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${result.imageData}`;
                    img.alt = 'ç”Ÿæˆçš„å›¾åƒ';
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '8px';
                    img.style.marginTop = '10px';
                    
                    img.onload = () => {
                        timings.imageLoad = Date.now();
                        const imageLoadDuration = timings.imageLoad - timings.parseEnd;
                        const totalTime = ((timings.imageLoad - timings.start) / 1000).toFixed(2);
                        
                        console.log(`ğŸ–¼ï¸ ${config.name} å›¾åƒåŠ è½½å®Œæˆï¼Œæ€»è€—æ—¶: ${totalTime}ç§’`);
                        
                        // è¾“å‡ºè¯¦ç»†çš„æ—¶é—´åˆ†æ
                        console.log(`ğŸ“Š ${config.name} è¯¦ç»†æ—¶é—´åˆ†æ:`, {
                            'è¯·æ±‚æ„å»º': `${timings.requestBuild - timings.start}ms`,
                            'ç½‘ç»œè¯·æ±‚': `${timings.networkEnd - timings.networkStart}ms`,
                            'å“åº”è§£æ': `${timings.parseEnd - timings.parseStart}ms`,
                            'å›¾åƒåŠ è½½': `${imageLoadDuration}ms`,
                            'æ€»è€—æ—¶': `${totalTime}ç§’`
                        });

                        // æ›´æ–°å¯¹æ¯”ç»“æœ
                        updateComparisonResult(apiProvider, {
                            success: true,
                            totalTime: totalTime,
                            networkTime: timings.networkEnd - timings.networkStart,
                            imageLoadTime: imageLoadDuration,
                            timings: timings
                        });
                    };
                    
                    imageResultDiv.appendChild(img);
                } else if (result.textResponse) {
                    showResult(`${config.name} æ–‡æœ¬å“åº”: ${result.textResponse} (æ€»è€—æ—¶: ${totalDuration}ç§’)`, 'success');
                } else {
                    showResult(`${config.name} æœªè¿”å›å›¾åƒæˆ–æ–‡æœ¬æ•°æ®`, 'error');
                }

            } catch (error) {
                console.error(`${apiConfigs[apiProvider].name} æµ‹è¯•å¤±è´¥:`, error);
                
                let errorMessage = error.message;
                if (apiProvider === '147api' && error.message.includes('æ— æ•ˆçš„ä»¤ç‰Œ')) {
                    errorMessage = '147API Keyå·²å¤±æ•ˆï¼Œè¯·è·å–æ–°çš„API Key';
                }
                
                showResult(`${apiConfigs[apiProvider].name} æµ‹è¯•å¤±è´¥: ${errorMessage}`, 'error');
                
                // æ›´æ–°å¯¹æ¯”ç»“æœ
                updateComparisonResult(apiProvider, {
                    success: false,
                    error: errorMessage
                });
            } finally {
                generateBtn.disabled = false;
            }
        });

        // åŒæ—¶æµ‹è¯•æ‰€æœ‰API
        testAllBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('prompt').value;
            const aspectRatio = document.getElementById('aspectRatio').value;
            const imageOnly = document.getElementById('imageOnly').value === 'true';

            // æ£€æŸ¥æ‰€æœ‰API Keyæ˜¯å¦å·²é…ç½®
            const missingKeys = [];
            Object.keys(apiConfigs).forEach(provider => {
                const config = apiConfigs[provider];
                if (!config.apiKey || config.apiKey.includes('xxxxxxxx')) {
                    missingKeys.push(config.name);
                }
            });

            if (missingKeys.length > 0) {
                showResult(`è¯·å…ˆé…ç½®ä»¥ä¸‹APIçš„Key: ${missingKeys.join(', ')}`, 'error');
                return;
            }

            testAllBtn.disabled = true;
            testAllBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            showResult('æ­£åœ¨åŒæ—¶æµ‹è¯•æ‰€æœ‰API...', 'loading');
            imageResultDiv.innerHTML = '';
            comparisonResults.style.display = 'grid';

            // é‡ç½®æ‰€æœ‰ç»“æœ
            document.getElementById('googleResult').innerHTML = 'â³ æµ‹è¯•ä¸­...';
            document.getElementById('147apiResult').innerHTML = 'â³ æµ‹è¯•ä¸­...';
            document.getElementById('kuaiResult').innerHTML = 'â³ æµ‹è¯•ä¸­...';

            const testPromises = [];

            // æµ‹è¯•Google API
            testPromises.push(
                testSingleAPI('google', prompt, aspectRatio, imageOnly)
                    .catch(error => ({ provider: 'google', error: error.message }))
            );

            // æµ‹è¯•147API
            testPromises.push(
                testSingleAPI('147api', prompt, aspectRatio, imageOnly)
                    .catch(error => ({ provider: '147api', error: error.message }))
            );

            // æµ‹è¯•é…·çˆ±API
            testPromises.push(
                testSingleAPI('kuai', prompt, aspectRatio, imageOnly)
                    .catch(error => ({ provider: 'kuai', error: error.message }))
            );

            try {
                const results = await Promise.allSettled(testPromises);
                
                let successCount = 0;
                let fastestTime = Infinity;
                let fastestProvider = '';

                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.success) {
                        successCount++;
                        if (result.value.totalTime < fastestTime) {
                            fastestTime = result.value.totalTime;
                            fastestProvider = result.value.provider;
                        }
                    }
                });

                if (successCount > 0) {
                    showResult(`æµ‹è¯•å®Œæˆï¼${successCount}/3 ä¸ªAPIæˆåŠŸï¼Œæœ€å¿«çš„æ˜¯ ${apiConfigs[fastestProvider].name} (${fastestTime}ç§’)`, 'success');
                } else {
                    showResult('æ‰€æœ‰APIæµ‹è¯•éƒ½å¤±è´¥äº†', 'error');
                }
            } catch (error) {
                showResult('æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
            } finally {
                testAllBtn.disabled = false;
                testAllBtn.textContent = 'ğŸš€ åŒæ—¶æµ‹è¯•æ‰€æœ‰API';
            }
        });

        async function testSingleAPI(provider, prompt, aspectRatio, imageOnly) {
            const config = apiConfigs[provider];
            const apiKey = config.apiKey;
            const startTime = Date.now();
            const timings = {
                start: startTime,
                requestBuild: 0,
                networkStart: 0,
                networkEnd: 0,
                parseStart: 0,
                parseEnd: 0,
                imageLoad: 0
            };

            let result;

            if (provider === 'google') {
                result = await testGoogleAPI(apiKey, prompt, aspectRatio, imageOnly, timings);
            } else {
                result = await testHTTPAPI(config, apiKey, prompt, aspectRatio, imageOnly, timings);
            }

            timings.parseEnd = Date.now();
            const totalDuration = ((timings.parseEnd - timings.start) / 1000).toFixed(2);

            if (result.imageData) {
                updateComparisonResult(provider, {
                    success: true,
                    totalTime: totalDuration,
                    networkTime: timings.networkEnd - timings.networkStart,
                    imageLoadTime: 0, // ç®€åŒ–å¤„ç†
                    timings: timings
                });
                return { provider, success: true, totalTime: parseFloat(totalDuration) };
            } else if (result.textResponse) {
                updateComparisonResult(provider, {
                    success: true,
                    totalTime: totalDuration,
                    networkTime: timings.networkEnd - timings.networkStart,
                    imageLoadTime: 0,
                    timings: timings
                });
                return { provider, success: true, totalTime: parseFloat(totalDuration) };
            } else {
                throw new Error('æœªè¿”å›å›¾åƒæˆ–æ–‡æœ¬æ•°æ®');
            }
        }

        async function testGoogleAPI(apiKey, prompt, aspectRatio, imageOnly, timings) {
            try {
                console.log('ğŸ”§ åˆå§‹åŒ–Google GenAIå®¢æˆ·ç«¯...');
                const initStart = Date.now();
                const genAI = new GoogleGenAI({ apiKey });
                const initTime = Date.now() - initStart;
                console.log(`âš¡ SDKåˆå§‹åŒ–è€—æ—¶: ${initTime}ms`);
                
                // ä¼˜åŒ–é…ç½® - å‡å°‘ä¸å¿…è¦çš„å®‰å…¨è®¾ç½®
                const config = {
                    safetySettings: [
                        { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                        { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                        { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
                        { category: 'HARM_CATEGORY_CIVIC_INTEGRITY', threshold: 'BLOCK_NONE' }
                    ]
                };

                // å¼ºåˆ¶åªç”Ÿæˆå›¾åƒï¼Œé¿å…æ–‡æœ¬å¤„ç†
                config.responseModalities = ['Image'];

                if (aspectRatio && aspectRatio !== 'auto') {
                    config.imageConfig = { aspectRatio };
                }

                timings.requestBuild = Date.now();
                console.log(`â±ï¸ Google API è¯·æ±‚æ„å»ºè€—æ—¶: ${timings.requestBuild - timings.start}ms`);
                console.log('ğŸ” Google API é…ç½®:', config);

                timings.networkStart = Date.now();
                console.log('ğŸŒ å¼€å§‹Google APIè°ƒç”¨...');
                
                // ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
                const stream = await genAI.models.generateContentStream({
                    model: 'gemini-2.5-flash-image',
                    contents: prompt,
                    config: config
                });

                let imageData = null;
                let textResponse = '';
                let chunkCount = 0;
                let firstChunkTime = 0;
                let lastChunkTime = 0;

                console.log('ğŸ“¦ å¼€å§‹å¤„ç†æµå¼å“åº”...');
                for await (const chunk of stream) {
                    chunkCount++;
                    if (firstChunkTime === 0) {
                        firstChunkTime = Date.now();
                        console.log(`âš¡ é¦–ä¸ªæ•°æ®å—åˆ°è¾¾æ—¶é—´: ${firstChunkTime - timings.networkStart}ms`);
                    }
                    lastChunkTime = Date.now();
                    
                    console.log(`ğŸ“¦ æ”¶åˆ°ç¬¬${chunkCount}ä¸ªæ•°æ®å—ï¼Œå¤§å°: ${JSON.stringify(chunk).length} å­—ç¬¦`);
                    
                    if (chunk?.candidates?.[0]?.content?.parts) {
                        for (const part of chunk.candidates[0].content.parts) {
                            if (part.text) {
                                textResponse += part.text;
                                console.log('ğŸ“ æ–‡æœ¬éƒ¨åˆ†:', part.text);
                            }
                            if (part.inlineData?.data) {
                                imageData = part.inlineData.data;
                                console.log('ğŸ–¼ï¸ å›¾åƒæ•°æ®é•¿åº¦:', imageData.length, 'bytes');
                                console.log('ğŸ–¼ï¸ å›¾åƒæ•°æ®é¢„è§ˆ:', imageData.substring(0, 50) + '...');
                            }
                        }
                    }
                }

                timings.networkEnd = Date.now();
                timings.parseStart = timings.networkEnd;
                
                console.log(`ğŸ“¡ Google API ç½‘ç»œè¯·æ±‚å®Œæˆï¼Œæ€»è€—æ—¶: ${timings.networkEnd - timings.networkStart}ms`);
                console.log(`âš¡ é¦–ä¸ªæ•°æ®å—å»¶è¿Ÿ: ${firstChunkTime - timings.networkStart}ms`);
                console.log(`ğŸ“¦ æ€»å…±æ”¶åˆ° ${chunkCount} ä¸ªæ•°æ®å—`);
                console.log(`â±ï¸ æµå¼å¤„ç†è€—æ—¶: ${lastChunkTime - firstChunkTime}ms`);

                return { imageData, textResponse };
            } catch (error) {
                console.error('âŒ Google API è°ƒç”¨å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('Load failed sending request')) {
                    throw new Error('Google API ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORSé—®é¢˜æˆ–API Keyæ— æ•ˆã€‚å»ºè®®ä½¿ç”¨ä»£ç†APIï¼ˆ147APIæˆ–é…·çˆ±APIï¼‰');
                } else if (error.message.includes('API key')) {
                    throw new Error('Google API Key æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯');
                } else {
                    throw new Error(`Google API è°ƒç”¨å¤±è´¥: ${error.message}`);
                }
            }
        }

        async function testHTTPAPI(config, apiKey, prompt, aspectRatio, imageOnly, timings) {
            const body = {
                contents: [
                    {
                        role: 'user',
                        parts: [{ text: prompt }]
                    }
                ],
                generationConfig: {
                    responseModalities: imageOnly ? ['IMAGE'] : ['TEXT', 'IMAGE']
                },
                safetySettings: [
                    { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
                    { category: 'HARM_CATEGORY_CIVIC_INTEGRITY', threshold: 'BLOCK_NONE' }
                ]
            };

            if (aspectRatio && aspectRatio !== 'auto') {
                body.generationConfig.imageConfig = { aspectRatio };
            }

            timings.requestBuild = Date.now();
            console.log(`â±ï¸ ${config.name} è¯·æ±‚æ„å»ºè€—æ—¶: ${timings.requestBuild - timings.start}ms`);

            const url = `${config.baseUrl}/${config.model}:generateContent`;
            timings.networkStart = Date.now();
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': buildAuthorizationHeader(apiKey, config.authType),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            timings.networkEnd = Date.now();
            console.log(`ğŸ“¡ ${config.name} ç½‘ç»œè¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${timings.networkEnd - timings.networkStart}ms`);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            timings.parseStart = Date.now();
            console.log(`ğŸ“¡ ${config.name} APIå“åº”:`, data);

            const candidate = data?.candidates?.[0];
            const parts = candidate?.content?.parts || [];
            
            let imageData = null;
            let textResponse = '';

            parts.forEach((part, index) => {
                if (part.text) {
                    textResponse += part.text;
                }
                if (part.inlineData?.data) {
                    imageData = part.inlineData.data;
                }
            });

            return { imageData, textResponse };
        }

        function updateComparisonResult(provider, result) {
            const resultDiv = document.getElementById(`${provider}Result`);
            const detailsDiv = document.getElementById(`${provider}Details`);
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div style="color: green; font-weight: bold;">âœ… æˆåŠŸ</div>
                    <div>æ€»è€—æ—¶: ${result.totalTime}ç§’</div>
                `;
                
                if (result.timings) {
                    const timings = result.timings;
                    detailsDiv.innerHTML = `
                        <strong>è¯¦ç»†æ—¶é—´åˆ†æ:</strong><br>
                        â€¢ SDKåˆå§‹åŒ–: ${timings.requestBuild - timings.start}ms<br>
                        â€¢ ç½‘ç»œè¯·æ±‚: ${timings.networkEnd - timings.networkStart}ms<br>
                        â€¢ å“åº”è§£æ: ${timings.parseEnd - timings.parseStart}ms<br>
                        â€¢ å›¾åƒåŠ è½½: ${result.imageLoadTime || 0}ms<br>
                        <strong>æ€§èƒ½è¯„åˆ†:</strong> ${getPerformanceScore(result.totalTime)}
                    `;
                    detailsDiv.style.display = 'block';
                }
            } else {
                resultDiv.innerHTML = `
                    <div style="color: red; font-weight: bold;">âŒ å¤±è´¥</div>
                    <div style="color: red;">${result.error}</div>
                `;
                detailsDiv.style.display = 'none';
            }
            comparisonResults.style.display = 'grid';
            
            // æ˜¾ç¤ºæ€§èƒ½åˆ†æ
            updatePerformanceAnalysis();
        }
        
        function getPerformanceScore(totalTime) {
            if (totalTime < 3) return 'ğŸš€ æå¿«';
            if (totalTime < 5) return 'âš¡ å¾ˆå¿«';
            if (totalTime < 8) return 'âœ… æ­£å¸¸';
            if (totalTime < 12) return 'ğŸŒ è¾ƒæ…¢';
            return 'âŒ å¾ˆæ…¢';
        }
        
        function updatePerformanceAnalysis() {
            const analysisDiv = document.getElementById('performanceAnalysis');
            const analysisContent = document.getElementById('analysisContent');
            
            const results = [];
            ['google', '147api', 'kuai'].forEach(provider => {
                const resultDiv = document.getElementById(`${provider}Result`);
                const text = resultDiv.textContent;
                if (text.includes('æˆåŠŸ')) {
                    const timeMatch = text.match(/æ€»è€—æ—¶: ([\d.]+)ç§’/);
                    if (timeMatch) {
                        results.push({
                            provider: apiConfigs[provider].name,
                            time: parseFloat(timeMatch[1])
                        });
                    }
                }
            });
            
            if (results.length > 0) {
                results.sort((a, b) => a.time - b.time);
                const fastest = results[0];
                const slowest = results[results.length - 1];
                const speedDiff = ((slowest.time - fastest.time) / fastest.time * 100).toFixed(1);
                
                analysisContent.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>ğŸ† æœ€å¿«:</strong> ${fastest.provider} (${fastest.time}ç§’)<br>
                        <strong>ğŸŒ æœ€æ…¢:</strong> ${slowest.provider} (${slowest.time}ç§’)<br>
                        <strong>ğŸ“Š é€Ÿåº¦å·®å¼‚:</strong> ${speedDiff}%
                    </div>
                    <div style="font-size: 12px; color: #6c757d;">
                        ğŸ’¡ å¦‚æœGoogleç›´è”APIæ¯”ä»£ç†APIæ…¢å¾ˆå¤šï¼Œå¯èƒ½æ˜¯CORSé™åˆ¶æˆ–ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„
                    </div>
                `;
                analysisDiv.style.display = 'block';
            }
        }

        function showResult(message, type) {
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
        }

        function showDebugInfo(info) {
            debugInfoDiv.innerHTML = '<h3>è°ƒè¯•ä¿¡æ¯:</h3><pre>' + JSON.stringify(info, null, 2) + '</pre>';
            debugInfoDiv.style.display = 'block';
        }
    </script>
</body>
</html>
