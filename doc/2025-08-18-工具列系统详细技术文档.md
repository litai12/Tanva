# 2025-08-18 工具列系统详细技术文档

## 概述

本文档详细分析智绘画板应用的工具列系统实现，包括工具状态管理、绘图模式切换、交互控制、UI组件设计等核心技术细节。

## 工具列系统核心实现

### 1. 工具状态管理系统 (stores/toolStore.ts)

#### 工具类型定义
```typescript
// toolStore.ts:6
export type DrawMode = 'select' | 'free' | 'rect' | 'circle' | 'polyline' | 'text' | 'image' | '3d-model' | 'screenshot';
```

#### 工具状态接口
```typescript
// toolStore.ts:8-25
interface ToolState {
  // 当前激活工具
  drawMode: DrawMode;
  
  // 绘图属性
  currentColor: string;
  strokeWidth: number;
  isEraser: boolean;
  
  // 操作方法
  setDrawMode: (mode: DrawMode) => void;
  setCurrentColor: (color: string) => void;
  setStrokeWidth: (width: number) => void;
  toggleEraser: () => void;
  
  // 快捷切换工具
  nextDrawingTool: () => void;
}
```

#### 绘图工具循环系统
```typescript
// toolStore.ts:28
const DRAWING_TOOLS: DrawMode[] = ['free', 'rect', 'circle', 'polyline'];
```

**工具切换逻辑**:
- 支持快捷键循环切换绘图工具
- 切换到绘图模式时自动关闭橡皮擦
- 保持工具状态的逻辑一致性

### 2. 工具列UI组件 (components/toolbar/ToolBar.tsx)

#### 组件架构设计

**悬浮工具栏**:
```typescript
// ToolBar.tsx:145-152
<div
  className={`fixed top-1/2 transform -translate-y-1/2 flex flex-col items-center gap-3 px-2 py-3 rounded-lg bg-white/95 backdrop-blur-sm shadow-lg border border-gray-200/50 z-[1000] transition-all duration-300 ${
    showLayerPanel ? 'left-[295px]' : 'left-2'
  }`}
>
```

**特性**:
- 固定在画布左侧，垂直居中布局
- 毛玻璃效果背景 (`backdrop-blur-sm`)
- 响应式位置调整（根据图层面板状态）
- 高层级 z-index (1000) 确保始终可见

#### 工具分组架构

##### 2.1 选择工具 - 独立按钮
```typescript
// ToolBar.tsx:154-162
<Button
  variant={drawMode === 'select' ? 'default' : 'outline'}
  size="sm"
  className="px-2 py-2 h-8 w-8 mb-2"
  onClick={() => setDrawMode('select')}
  title="选择模式"
>
  <DashedSelectIcon className="w-4 h-4" />
</Button>
```

**特点**:
- 独立于其他工具的顶级工具
- 虚线框图标表示选择功能
- 优先级最高，独占一行

##### 2.2 绘制工具分组 - 悬停展开设计
```typescript
// ToolBar.tsx:165-233
<div className="relative group">
  {/* 主按钮 - 显示当前绘制模式 */}
  <Button variant={...} onClick={...}>
    {/* 动态图标显示当前工具 */}
  </Button>

  {/* 悬停展开的绘制工具菜单 */}
  <div className="absolute left-full top-1/2 transform -translate-y-1/2 ml-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out z-[1001]">
    {/* 四个绘制工具按钮 */}
  </div>
</div>
```

**交互特性**:
- **主按钮显示当前工具**: 图标随当前绘制模式动态变化
- **悬停展开**: CSS Group Hover 实现无JavaScript的展开效果
- **智能切换**: 点击主按钮时的智能工具切换逻辑
- **层级管理**: 展开菜单使用更高的 z-index (1001)

##### 2.3 属性控制区域

**颜色选择器**:
```typescript
// ToolBar.tsx:238-244
<input
  type="color"
  value={currentColor}
  onChange={(e) => setCurrentColor(e.target.value)}
  disabled={isEraser}
  className="w-6 h-6 rounded border border-gray-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
/>
```

**自定义垂直滑块组件**:
```typescript
// ToolBar.tsx:55-126
const VerticalSlider: React.FC<{
  value: number;
  min: number;
  max: number;
  onChange: (value: number) => void;
  disabled?: boolean;
}> = ({ value, min, max, onChange, disabled = false }) => {
  // 鼠标拖拽逻辑
  // 位置计算和视觉反馈
}
```

**滑块特性**:
- **垂直方向**: 顶部为最大值，底部为最小值
- **实时反馈**: 拖拽过程中实时更新数值
- **视觉进度**: 蓝色填充显示当前值位置
- **范围限制**: 1-20像素线宽范围
- **禁用状态**: 橡皮擦模式下自动禁用

##### 2.4 独立工具区域
```typescript
// ToolBar.tsx:265-309
<div className="flex flex-col items-center gap-2">
  {/* 文字工具 */}
  {/* 图片工具 */}
  {/* 3D模型工具 */}
  {/* 截图工具 */}
</div>
```

##### 2.5 功能工具区域
```typescript
// ToolBar.tsx:314-342
<div className="flex flex-col items-center gap-2">
  {/* 橡皮擦工具 */}
  {/* 清理画布按钮 */}
</div>
```

### 3. 绘图控制系统 (components/canvas/DrawingController.tsx)

#### 绘图模式处理架构

##### 3.1 图层管理系统
```typescript
// DrawingController.tsx:44-63
const ensureDrawingLayer = useCallback(() => {
  let drawingLayer = drawingLayerRef.current;
  
  // 如果图层不存在或已被删除，创建新的绘图图层
  if (!drawingLayer || (drawingLayer as any).isDeleted) {
    drawingLayer = new paper.Layer();
    drawingLayer.name = "drawing";
    drawingLayerRef.current = drawingLayer;
    
    // 确保绘图图层在网格图层之上
    const gridLayer = paper.project.layers.find(layer => layer.name === "grid");
    if (gridLayer) {
      drawingLayer.insertAbove(gridLayer);
    }
  }
  
  // 激活绘图图层
  drawingLayer.activate();
  return drawingLayer;
}, []);
```

**图层层级管理**:
- **网格图层**: 最底层，提供参考网格
- **绘图图层**: 中间层，包含所有绘制内容
- **交互图层**: 最顶层，处理选择和控制点

##### 3.2 自由绘制模式实现
```typescript
// DrawingController.tsx:66-80
const startFreeDraw = useCallback((point: paper.Point) => {
  ensureDrawingLayer(); // 确保在正确的图层中绘制
  pathRef.current = new paper.Path();
  
  if (isEraser) {
    // 橡皮擦模式：红色虚线表示擦除轨迹
    pathRef.current.strokeColor = new paper.Color('#ff6b6b');
    pathRef.current.strokeWidth = strokeWidth * 1.5; // 稍微粗一点
    pathRef.current.dashArray = [5, 5]; // 虚线效果
    pathRef.current.opacity = 0.7;
  } else {
    // 普通绘制模式
    pathRef.current.strokeColor = new paper.Color(currentColor);
    pathRef.current.strokeWidth = strokeWidth;
  }
}, [/* deps */]);
```

**绘制模式特性**:
- **普通绘制**: 使用用户选择的颜色和线宽
- **橡皮擦模式**: 红色虚线预览，实际执行删除操作
- **实时预览**: 绘制过程中提供即时视觉反馈

#### 3D模型和图片上传系统

##### 3.3 3D模型管理
```typescript
// DrawingController.tsx:32-41
const [model3DInstances, setModel3DInstances] = useState<Array<{
  id: string;
  modelData: Model3DData;
  bounds: { x: number; y: number; width: number; height: number };
  isSelected: boolean;
}>>([]);
```

**3D模型特性**:
- **GLB格式支持**: 通过Three.js加载和渲染
- **交互控制**: 选择、移动、调整大小
- **坐标系集成**: 与Paper.js坐标系统无缝集成

##### 3.4 图片管理系统
```typescript
// DrawingController.tsx:24-30
const [imageInstances, setImageInstances] = useState<Array<{
  id: string;
  imageData: { id: string; src: string; fileName?: string };
  bounds: { x: number; y: number; width: number; height: number };
  isSelected: boolean;
}>>([]);
```

**图片处理特性**:
- **多格式支持**: JPEG, PNG, WebP等
- **自适应显示**: object-fit: contain 保持宽高比
- **精确控制**: 基于实际图片边界的控制点

### 4. 工具图标系统

#### 自定义SVG图标
```typescript
// ToolBar.tsx:8-45
const LineIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" className={className}>
    <line x1="2" y1="8" x2="14" y2="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
  </svg>
);

const DashedSelectIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" className={className}>
    <rect x="3" y="3" width="10" height="10" stroke="currentColor" strokeWidth="1.5" strokeDasharray="2 2" fill="none" />
  </svg>
);

const CircleIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" className={className}>
    <circle cx="8" cy="8" r="6" stroke="currentColor" strokeWidth="1.5" fill="none" />
  </svg>
);

const PolylineIcon: React.FC<{ className?: string }> = ({ className }) => (
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" className={className}>
    <path d="M2 12 L6 4 L10 8 L14 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none" />
    <circle cx="2" cy="12" r="1.5" fill="currentColor" />
    <circle cx="6" cy="4" r="1" fill="currentColor" />
    <circle cx="10" cy="8" r="1" fill="currentColor" />
    <circle cx="14" cy="2" r="1.5" fill="currentColor" />
  </svg>
);
```

**图标设计原则**:
- **一致的尺寸**: 16x16 viewBox统一规格
- **响应式颜色**: 使用 currentColor 跟随父元素
- **清晰的语义**: 每个工具都有独特且直观的图标
- **视觉层次**: 通过线宽和填充区分重要性

## 工具详细功能文档

### 1. 选择工具 (select)

#### 功能描述
选择工具是画布的默认交互模式，用于选择、移动和调整现有图元。

#### 技术实现
- **图元选择**: 点击图元进行单选
- **多选支持**: Ctrl+点击实现多选（待实现）
- **变换控制**: 显示选择框和控制点
- **交互优先级**: 最高优先级，覆盖其他交互

#### 视觉标识
- **图标**: 虚线选择框 (DashedSelectIcon)
- **状态**: 激活时按钮高亮
- **光标**: 默认指针样式

### 2. 自由绘制工具 (free)

#### 功能描述
自由绘制工具允许用户在画布上进行手绘，创建连续的曲线路径。

#### 技术实现
```typescript
// DrawingController.tsx:66-80
const startFreeDraw = useCallback((point: paper.Point) => {
  ensureDrawingLayer();
  pathRef.current = new paper.Path();
  
  if (isEraser) {
    // 橡皮擦模式设置
    pathRef.current.strokeColor = new paper.Color('#ff6b6b');
    pathRef.current.strokeWidth = strokeWidth * 1.5;
    pathRef.current.dashArray = [5, 5];
    pathRef.current.opacity = 0.7;
  } else {
    // 普通绘制设置
    pathRef.current.strokeColor = new paper.Color(currentColor);
    pathRef.current.strokeWidth = strokeWidth;
  }
}, [isEraser, currentColor, strokeWidth, ensureDrawingLayer]);
```

#### 绘制流程
1. **mousedown**: 创建新路径，设置起始点
2. **mousemove**: 添加路径点，实时显示轨迹
3. **mouseup**: 完成路径，添加到绘图图层

#### 属性控制
- **颜色**: 通过颜色选择器设置
- **线宽**: 1-20像素范围，垂直滑块控制
- **橡皮擦模式**: 切换到删除模式

#### 视觉标识
- **图标**: 直线图标 (LineIcon)
- **预览**: 实时显示绘制轨迹
- **反馈**: 橡皮擦模式显示红色虚线

### 3. 矩形工具 (rect)

#### 功能描述
矩形工具用于绘制规则的矩形图形，支持正方形约束。

#### 技术实现
- **起始点记录**: mousedown时记录起始坐标
- **实时预览**: mousemove时显示矩形轮廓
- **约束绘制**: Shift键约束为正方形（待实现）
- **路径创建**: 使用Paper.js Rectangle API

#### 绘制算法
```typescript
// 矩形路径创建逻辑
const createRectangle = (startPoint: paper.Point, endPoint: paper.Point) => {
  const rect = new paper.Rectangle(startPoint, endPoint);
  const path = new paper.Path.Rectangle(rect);
  path.strokeColor = new paper.Color(currentColor);
  path.strokeWidth = strokeWidth;
  return path;
};
```

#### 视觉标识
- **图标**: 方形框线图标 (Square from lucide-react)
- **预览**: 动态矩形轮廓
- **约束**: Shift键显示正方形提示

### 4. 圆形工具 (circle)

#### 功能描述
圆形工具用于绘制圆形和椭圆形图形，支持圆形约束。

#### 技术实现
- **中心半径模式**: 从中心点向外扩展
- **对角模式**: 基于对角矩形绘制椭圆
- **约束绘制**: Shift键约束为正圆
- **实时预览**: 显示当前圆形状态

#### 绘制算法
```typescript
// 圆形路径创建逻辑
const createCircle = (center: paper.Point, radius: number) => {
  const circle = new paper.Path.Circle(center, radius);
  circle.strokeColor = new paper.Color(currentColor);
  circle.strokeWidth = strokeWidth;
  return circle;
};
```

#### 视觉标识
- **图标**: 圆形轮廓图标 (CircleIcon)
- **预览**: 动态圆形轮廓
- **约束**: Shift键显示正圆提示

### 5. 多段线工具 (polyline)

#### 功能描述
多段线工具用于绘制由多个直线段连接的复杂路径，支持闭合路径。

#### 技术实现
- **点击添加**: 每次点击添加新的路径点
- **实时连线**: 显示当前点到鼠标的连接线
- **路径闭合**: 双击或回到起始点闭合路径
- **撤销点**: Backspace删除最后一个点

#### 交互流程
1. **首次点击**: 开始多段线，设置起始点
2. **后续点击**: 添加线段点，扩展路径
3. **鼠标移动**: 显示预览线段
4. **完成绘制**: 双击或ESC键完成

#### 视觉标识
- **图标**: 多段线路径图标 (PolylineIcon)
- **节点**: 圆形标记显示路径点
- **预览**: 虚线显示下一段线
- **起终点**: 较大圆形标记起始和结束点

### 6. 文本工具 (text)

#### 功能描述
文本工具用于在画布上添加和编辑文本内容。

#### 技术实现
- **点击定位**: 点击画布确定文本位置
- **内联编辑**: 直接在画布上编辑文本
- **字体控制**: 字体系列、大小、样式设置
- **文本样式**: 颜色、对齐方式等属性

#### 编辑模式
- **创建模式**: 点击创建新文本框
- **编辑模式**: 双击现有文本进入编辑
- **选择模式**: 单击选择文本对象

#### 视觉标识
- **图标**: 文本字母T图标 (Type from lucide-react)
- **编辑框**: 文本边界和光标
- **控制点**: 文本框调整手柄

### 7. 图片工具 (image)

#### 功能描述
图片工具用于在画布上添加和管理图片资源，支持多种图片格式。

#### 技术实现架构
```typescript
// ImageContainer.tsx - 图片容器组件
interface ImageContainerProps {
  imageData: ImageData;
  bounds: { x: number; y: number; width: number; height: number };
  isSelected?: boolean;
  onSelect?: () => void;
  onMove?: (newPosition: { x: number; y: number }) => void;
  onResize?: (newBounds: { x: number; y: number; width: number; height: number }) => void;
}
```

#### 文件处理流程
1. **文件选择**: 点击工具触发文件选择对话框
2. **格式验证**: 支持 JPEG, PNG, WebP, GIF 等格式
3. **大小限制**: 最大10MB文件大小限制
4. **Base64转换**: 转换为Data URL格式存储
5. **坐标转换**: Paper.js坐标到屏幕坐标转换

#### 交互控制
- **选择状态**: 边框高亮和控制点显示
- **移动操作**: 拖拽边框区域移动图片
- **大小调整**: 拖拽角部控制点调整尺寸
- **宽高比保持**: object-fit: contain 保持原始比例

#### 视觉反馈
```typescript
// 选中状态的边框显示
{isSelected && (
  <div
    className="border-area"
    style={{
      position: 'absolute',
      top: 0, left: 0,
      width: '100%', height: '100%',
      border: '2px solid #3b82f6',
      cursor: 'move',
      zIndex: 5
    }}
  />
)}
```

#### 控制点系统
- **四角控制点**: 对角调整大小
- **固定点逻辑**: 拖拽时对角固定
- **最小尺寸**: 100px最小宽高限制
- **精确对齐**: 控制点与边框角点精确对齐

### 8. 3D模型工具 (3d-model)

#### 功能描述
3D模型工具用于在画布上添加和管理3D GLB/GLTF模型，提供三维可视化功能。

#### 技术架构
```typescript
// Model3DViewer.tsx - Three.js渲染器
import { Canvas } from '@react-three/fiber';
import { OrbitControls, useGLTF } from '@react-three/drei';
import * as THREE from 'three';

interface Model3DViewerProps {
  modelData: Model3DData;
  width: number;
  height: number;
  isSelected?: boolean;
}
```

#### 3D渲染系统
```typescript
// 3D模型组件实现
function Model3D({ modelPath, onLoaded }: { 
  modelPath: string; 
  onLoaded?: (boundingBox: THREE.Box3) => void;
}) {
  const meshRef = useRef<THREE.Group>(null);
  const { scene } = useGLTF(modelPath);
  const [autoScale, setAutoScale] = useState<[number, number, number]>([1, 1, 1]);

  useEffect(() => {
    if (meshRef.current && scene) {
      // 克隆场景避免修改原始对象
      const clonedScene = scene.clone();
      
      // 计算模型包围盒
      const box = new THREE.Box3().setFromObject(clonedScene);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      // 模型居中
      clonedScene.position.sub(center);

      // 自动缩放适配显示区域
      const maxSize = 2.5;
      const maxDimension = Math.max(size.x, size.y, size.z);
      const scaleFactor = Math.min(maxSize / maxDimension, 1);
      
      setAutoScale([scaleFactor, scaleFactor, scaleFactor]);
      
      if (meshRef.current) {
        meshRef.current.clear();
        meshRef.current.add(clonedScene);
      }
    }
  }, [scene, onLoaded]);

  return (
    <group ref={meshRef} scale={autoScale}>
      {/* 场景对象在useEffect中动态添加 */}
    </group>
  );
}
```

#### 文件格式支持
- **GLB格式**: 二进制GLTF文件
- **GLTF格式**: JSON格式3D文件
- **文件大小**: 最大50MB限制
- **自动优化**: 模型自动缩放和居中

#### 交互控制系统
```typescript
// OrbitControls配置
{isSelected && (
  <OrbitControls
    enablePan={false}          // 禁用平移
    enableZoom={true}          // 启用缩放
    enableRotate={true}        // 启用旋转
    enableDamping={true}       // 启用阻尼
    dampingFactor={0.05}       // 阻尼系数
    minDistance={1}            // 最小距离
    maxDistance={20}           // 最大距离
    autoRotate={false}         // 禁用自动旋转
    rotateSpeed={1}            // 旋转速度
    zoomSpeed={1.2}            // 缩放速度
    mouseButtons={{
      LEFT: THREE.MOUSE.ROTATE,
      MIDDLE: THREE.MOUSE.DOLLY,
      RIGHT: THREE.MOUSE.ROTATE
    }}
  />
)}
```

#### 光照系统
```typescript
// 多重光照设置
<ambientLight intensity={0.8} />
<directionalLight 
  position={[10, 10, 10]} 
  intensity={1.2}
  castShadow
  shadow-mapSize-width={2048}
  shadow-mapSize-height={2048}
/>
<directionalLight 
  position={[-10, 5, 5]} 
  intensity={0.8} 
/>
<pointLight 
  position={[0, 10, 0]} 
  intensity={0.5} 
/>
```

#### 视觉状态
- **未选中**: 透明背景，无边框
- **选中状态**: 浅蓝色背景，蓝色边框
- **加载状态**: 旋转加载指示器
- **错误状态**: 红色错误提示信息

### 9. 截图工具 (screenshot)

#### 功能描述
截图工具用于捕获画布内容并导出为图片文件。

#### 技术实现
- **画布捕获**: 将Paper.js画布内容转换为图片
- **区域选择**: 支持选择特定区域截图
- **格式选择**: PNG, JPEG格式导出
- **质量控制**: 可调节图片质量和分辨率

#### 截图流程
1. **区域选择**: 拖拽选择截图区域
2. **内容渲染**: 渲染选定区域内容
3. **格式转换**: Canvas转换为Blob
4. **文件下载**: 触发浏览器下载

#### 视觉标识
- **图标**: 相机图标 (Camera from lucide-react)
- **选择框**: 虚线矩形选择区域
- **预览**: 实时显示截图区域

### 10. 橡皮擦工具 (eraser)

#### 功能描述
橡皮擦工具用于删除已绘制的图元，支持精确擦除。

#### 技术实现
```typescript
// toggleEraser实现逻辑
toggleEraser: () => {
  const { isEraser } = get();
  if (isEraser) {
    // 关闭橡皮擦模式
    set({ isEraser: false });
  } else {
    // 开启橡皮擦并切换到自由绘制模式
    set({ isEraser: true, drawMode: 'free' });
  }
}
```

#### 擦除机制
- **路径删除**: 检测路径与擦除轨迹的相交
- **视觉预览**: 红色虚线显示擦除轨迹
- **即时反馈**: 实时删除相交的图元
- **精确控制**: 基于实际接触区域判断

#### 擦除算法
```typescript
// 擦除检测逻辑
const performErase = (erasePath: paper.Path) => {
  const allItems = paper.project.activeLayer.children;
  
  for (let item of allItems) {
    if (item instanceof paper.Path && item !== erasePath) {
      // 检测路径相交
      const intersections = item.getIntersections(erasePath);
      if (intersections.length > 0) {
        item.remove(); // 删除相交的路径
      }
    }
  }
  
  // 删除擦除轨迹本身
  erasePath.remove();
};
```

#### 视觉反馈
- **擦除轨迹**: 红色虚线 (#ff6b6b)
- **线宽加粗**: strokeWidth * 1.5
- **透明度**: 0.7透明度
- **虚线样式**: [5, 5] 虚线数组

### 11. 清空画布功能

#### 功能描述
清空画布功能用于删除画布上的所有图元，重置到初始状态。

#### 安全机制
```typescript
// 确认对话框
<Button
  onClick={() => {
    if (window.confirm('确定要清空画布吗？此操作将删除所有图元，不可撤销。')) {
      onClearCanvas();
    }
  }}
  className="hover:bg-red-50 hover:border-red-200 hover:text-red-600"
>
  <Trash2 className="w-4 h-4" />
</Button>
```

#### 清理范围
- **绘图图层**: 删除所有绘制的路径
- **图片实例**: 清除所有图片组件
- **3D模型**: 清除所有3D模型实例
- **文本对象**: 删除所有文本元素

#### 视觉警告
- **红色提示**: 悬停时红色高亮显示危险性
- **确认对话框**: 防止误操作的二次确认
- **不可撤销**: 明确提示操作的不可逆性

## 性能优化策略

### 1. 状态管理优化

#### Zustand持久化
```typescript
// toolStore.ts:82-92
persist(
  (set, get) => ({ /* store implementation */ }),
  {
    name: 'tool-settings',
    // 只持久化必要的状态，排除临时状态
    partialize: (state) => ({
      drawMode: state.drawMode,
      currentColor: state.currentColor,
      strokeWidth: state.strokeWidth,
      // 不持久化 isEraser (通常是临时的)
    }),
  }
)
```

#### 选择器优化
```typescript
// 性能优化：导出常用的选择器
export const useCurrentTool = () => useToolStore((state) => state.drawMode);
export const useDrawingProps = () => useToolStore((state) => ({
  currentColor: state.currentColor,
  strokeWidth: state.strokeWidth,
  isEraser: state.isEraser,
}));
export const useToolActions = () => useToolStore((state) => ({
  setDrawMode: state.setDrawMode,
  setCurrentColor: state.setCurrentColor,
  setStrokeWidth: state.setStrokeWidth,
  toggleEraser: state.toggleEraser,
  nextDrawingTool: state.nextDrawingTool,
}));
```

### 2. 渲染性能优化

#### 图层分离策略
- **网格图层**: 静态背景，最底层
- **绘图图层**: 用户绘制内容，中间层
- **交互图层**: 控制点和选择框，最顶层

#### 事件处理优化
```typescript
// 防抖和节流处理
const updateValue = useCallback(
  debounce((e: MouseEvent | React.MouseEvent) => {
    // 滑块值更新逻辑
  }, 16), // 60fps
  []
);
```

### 3. 内存管理

#### Paper.js对象清理
```typescript
// 图层生命周期管理
useEffect(() => {
  return () => {
    // 组件卸载时清理Paper.js对象
    if (drawingLayerRef.current) {
      drawingLayerRef.current.removeChildren();
      drawingLayerRef.current.remove();
    }
  };
}, []);
```

#### 3D模型资源管理
- **场景克隆**: 避免原始模型被修改
- **纹理释放**: 及时释放WebGL资源
- **几何体优化**: 自动LOD和压缩

## 扩展性设计

### 1. 工具插件系统

#### 工具注册机制
```typescript
// 未来扩展：工具注册系统
interface ToolPlugin {
  id: string;
  name: string;
  icon: React.ComponentType;
  handler: ToolHandler;
  config?: ToolConfig;
}

const registerTool = (plugin: ToolPlugin) => {
  // 动态注册新工具
};
```

### 2. 自定义工具开发

#### 工具开发接口
```typescript
// 工具开发基类
abstract class BaseTool {
  abstract onMouseDown(event: paper.MouseEvent): void;
  abstract onMouseMove(event: paper.MouseEvent): void;
  abstract onMouseUp(event: paper.MouseEvent): void;
  abstract getIcon(): React.ComponentType;
  abstract getName(): string;
}
```

### 3. 快捷键系统

#### 键盘映射
```typescript
// 快捷键配置
const KEYBOARD_SHORTCUTS = {
  'KeyS': 'select',
  'KeyF': 'free',
  'KeyR': 'rect', 
  'KeyC': 'circle',
  'KeyP': 'polyline',
  'KeyT': 'text',
  'KeyI': 'image',
  'KeyE': 'toggle-eraser',
  'Space': 'next-drawing-tool'
};
```

## 故障排除和调试

### 1. 常见问题

#### 工具切换失败
- **原因**: 状态管理中间件异常
- **解决**: 检查Zustand store配置
- **调试**: 使用Redux DevTools监控状态变化

#### 绘制无响应
- **原因**: Paper.js图层未正确激活
- **解决**: 调用ensureDrawingLayer()
- **调试**: 检查paper.project.activeLayer

#### 3D模型加载失败
- **原因**: 文件格式不支持或文件损坏
- **解决**: 验证GLB文件完整性
- **调试**: 查看Three.js控制台错误

### 2. 性能监控

#### 渲染性能
```typescript
// 性能监控钩子
const usePerformanceMonitor = () => {
  useEffect(() => {
    const observer = new PerformanceObserver((list) => {
      const entries = list.getEntries();
      entries.forEach((entry) => {
        if (entry.entryType === 'measure') {
          console.log(`${entry.name}: ${entry.duration}ms`);
        }
      });
    });
    
    observer.observe({ entryTypes: ['measure'] });
    
    return () => observer.disconnect();
  }, []);
};
```

#### 内存使用
```typescript
// 内存监控
const monitorMemory = () => {
  if ('memory' in performance) {
    const memory = (performance as any).memory;
    console.log({
      usedJSHeapSize: memory.usedJSHeapSize,
      totalJSHeapSize: memory.totalJSHeapSize,
      jsHeapSizeLimit: memory.jsHeapSizeLimit
    });
  }
};
```

## 未来发展规划

### 1. 新工具计划
- **文字工具增强**: 富文本编辑、字体管理
- **形状工具扩展**: 多边形、星形、箭头等
- **测量工具**: 距离、角度、面积测量
- **标注工具**: 文字标注、尺寸标注

### 2. 协作功能
- **实时协作**: 多用户同时编辑
- **版本控制**: 操作历史和回滚
- **云端同步**: 跨设备状态同步

### 3. AI集成
- **智能识别**: 手绘图形自动识别
- **自动优化**: 路径平滑和优化
- **内容建议**: 基于上下文的工具建议

---

**文档维护**: 随工具系统更新及时更新本文档
**技术支持**: 详细的API文档和示例代码
**社区贡献**: 开放工具插件开发接口