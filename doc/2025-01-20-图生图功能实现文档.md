# Google Gemini 图生图功能实现文档

## 概述

基于Google Gemini 2.5 Flash Image (Nano Banana) API实现了完整的图生图（Image-to-Image）功能，让用户可以通过AI对现有图像进行编辑和修改。

## 功能特性

### 1. 多种图像输入方式

- **从画布选择**：工具栏新增AI编辑图像按钮，自动检测选中的图像
- **图层面板右键**：在图层面板中右键点击图像项，选择"AI编辑图像"
- **直接上传**：在AI对话框中点击图片上传按钮，选择本地图像文件

### 2. 智能编辑工作流

- **源图像预览**：上传后显示源图像缩略图，用户可随时移除
- **动态提示词**：根据是否有源图像，自动调整输入提示文字
- **对话式编辑**：支持多轮对话，可基于同一图像进行多次编辑
- **历史记录**：聊天历史中同时显示源图像和编辑结果

### 3. 自动画布集成

- **无缝添加**：编辑完成的图像自动添加到画布坐标原点
- **命名规则**：自动生成文件名格式 `ai_edited_{prompt}_{timestamp}.png`
- **图层管理**：编辑后的图像作为新图层项添加到图层面板

## 技术实现

### 核心API调用

基于Google Gemini API的JavaScript实现：

```javascript
const result = await this.genAI.models.generateContent({
  model: "gemini-2.5-flash-image-preview",
  contents: [
    { text: `Edit this image based on the following instruction: ${prompt}` },
    {
      inlineData: {
        mimeType: 'image/jpeg',
        data: base64ImageData
      }
    }
  ]
});
```

### 关键组件修改

1. **aiChatStore.ts**
   - 新增 `sourceImageForEditing` 状态
   - 新增 `editImage` 方法
   - 新增 `setSourceImageForEditing` 方法
   - 扩展 `ChatMessage` 接口支持 `sourceImageData`

2. **AIChatDialog.tsx**
   - 新增图片上传按钮和文件选择器
   - 新增源图像预览区域
   - 智能发送逻辑（自动判断文本生图或图生图）
   - 增强聊天历史显示（同时显示源图像和结果）

3. **LayerPanel.tsx**
   - 新增上下文菜单组件
   - 为图像项添加右键菜单功能
   - 新增AI编辑图像选项

4. **ToolBar.tsx**
   - 新增AI编辑图像工具按钮
   - 智能检测选中图像或打开上传对话框

### 新增组件

- **context-menu.tsx**：通用上下文菜单组件，支持图标和禁用状态

## 用户使用流程

### 场景1：编辑画布中的现有图像

1. 用户在画布中选择一个图像
2. 点击工具栏的"AI编辑图像"按钮（紫色魔法棒图标）
3. AI对话框自动打开并显示选中图像的预览
4. 用户输入编辑指令，如"把这张图片的背景改成蓝天白云"
5. 系统调用Gemini API进行图像编辑
6. 编辑后的图像自动添加到画布

### 场景2：从图层面板编辑图像

1. 用户在图层面板中找到想要编辑的图像
2. 右键点击图像项
3. 从上下文菜单中选择"AI编辑图像"
4. 后续流程同场景1

### 场景3：上传新图像进行编辑

1. 用户点击AI对话框中的图片上传按钮
2. 选择本地图像文件
3. 图像预览显示在对话框中
4. 用户输入编辑指令
5. 系统进行图像编辑并添加到画布

## 技术优势

### 1. 基于Google Gemini API

- **高质量编辑**：使用最新的Gemini 2.5 Flash Image模型
- **多种编辑能力**：支持添加、删除、修改元素，改变风格等
- **自然语言控制**：用户可以用自然语言描述编辑需求

### 2. 无缝集成

- **复用现有架构**：充分利用现有的图像上传和画布管理系统
- **统一体验**：编辑后的图像与普通上传图像具有相同的管理方式
- **保持一致性**：UI风格和交互模式与现有功能保持一致

### 3. 智能化工作流

- **自动检测模式**：根据是否有源图像自动切换文本生图/图生图模式
- **上下文感知**：提示文字和按钮状态根据当前状态动态调整
- **错误处理**：完善的错误提示和异常处理机制

## 配置要求

确保在环境变量中设置Google Gemini API密钥：

```bash
VITE_GOOGLE_GEMINI_API_KEY=your_api_key_here
```

## 成本估算

根据Gemini原生图片生成定价：
- 每张图片：1,290个token
- 价格：$30/100万token
- 单次编辑成本：约 $0.039

## 后续优化建议

1. **批量编辑**：支持同时编辑多张图像
2. **编辑历史**：保存图像的编辑历史链
3. **预设模板**：提供常用编辑指令的快捷模板
4. **高级选项**：支持更多Gemini API参数调整
5. **本地缓存**：缓存编辑结果减少重复API调用

## 更新时间

2025-01-20
