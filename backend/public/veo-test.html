<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VEO è§†é¢‘ç”Ÿæˆæµ‹è¯•</title>
  <link rel="icon" href="data:,">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2rem;
      background: linear-gradient(90deg, #00d4ff, #7b2cbf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #a0a0a0;
    }
    select, input, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #00d4ff;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .model-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .model-card {
      padding: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .model-card:hover {
      border-color: rgba(0, 212, 255, 0.5);
      background: rgba(0, 212, 255, 0.1);
    }
    .model-card.selected {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.2);
    }
    .model-card h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #fff;
    }
    .model-card p {
      font-size: 12px;
      color: #a0a0a0;
    }
    .model-card .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      margin-top: 8px;
    }
    .badge-fast {
      background: #22c55e;
      color: #fff;
    }
    .badge-quality {
      background: #7b2cbf;
      color: #fff;
    }
    .badge-image {
      background: #f59e0b;
      color: #fff;
    }
    .image-input-group {
      display: none;
    }
    .image-input-group.visible {
      display: block;
    }
    button {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(90deg, #00d4ff, #7b2cbf);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .result-section {
      display: none;
    }
    .result-section.visible {
      display: block;
    }
    .status {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .status-loading {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.5);
    }
    .status-success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.5);
    }
    .status-error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .video-container {
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    video {
      width: 100%;
      display: block;
    }
    .links {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .links a {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #00d4ff;
      text-decoration: none;
      transition: background 0.3s;
    }
    .links a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .raw-content {
      margin-top: 16px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    .toggle-raw {
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #a0a0a0;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 12px;
      width: auto;
    }
    .hint {
      margin-top: 6px;
      font-size: 12px;
      color: #a0a0a0;
    }
    .api-info {
      font-size: 12px;
      color: #a0a0a0;
      text-align: center;
      margin-top: 20px;
    }
    @media (max-width: 600px) {
      .model-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ VEO è§†é¢‘ç”Ÿæˆæµ‹è¯•</h1>

    <div class="card">
      <div class="form-group">
        <label for="apiBase">API Baseï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="apiBase" placeholder="http://localhost:4000 æˆ– https://your-domain.com">
        <div class="hint">å¦‚æœç”¨ file:// æ‰“å¼€æœ¬é¡µï¼Œè¯·å¡«å†™åç«¯åœ°å€ï¼›åŒæºæ‰“å¼€å¯ç›´æ¥ä½¿ç”¨å½“å‰ç«™ç‚¹ã€‚</div>
      </div>

      <div class="form-group">
        <label>é€‰æ‹©æ¨¡å‹</label>
        <div class="model-cards">
          <div class="model-card selected" data-model="veo3-fast">
            <h3>VEO3 Fast</h3>
            <p>æ–‡å­—å¿«é€Ÿç”Ÿæˆè§†é¢‘</p>
            <span class="badge badge-fast">å¿«é€Ÿ</span>
          </div>
          <div class="model-card" data-model="veo3-pro">
            <h3>VEO3 Pro</h3>
            <p>æ–‡å­—ç”Ÿæˆé«˜è´¨é‡è§†é¢‘</p>
            <span class="badge badge-quality">é«˜è´¨é‡</span>
          </div>
          <div class="model-card" data-model="veo3-pro-frames">
            <h3>VEO3 Pro Frames</h3>
            <p>å›¾ç‰‡+æ–‡å­—ç”Ÿæˆè§†é¢‘</p>
            <span class="badge badge-image">æ”¯æŒå«å›¾</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="prompt">è§†é¢‘æè¿° (Prompt)</label>
        <textarea id="prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹ï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„çŒ«å’ªåœ¨è‰åœ°ä¸Šå¥”è·‘ï¼Œé˜³å…‰æ˜åªšï¼Œç”»é¢æ¸©é¦¨"></textarea>
      </div>

      <div class="form-group image-input-group" id="imageInputGroup">
        <label for="imageUrl">å‚è€ƒå›¾ç‰‡ URL (ä»… veo3-pro-frames æ¨¡å¼)</label>
        <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
      </div>

      <button class="btn-primary" id="generateBtn" onclick="generateVideo()">
        ç”Ÿæˆè§†é¢‘
      </button>
    </div>

    <div class="card result-section" id="resultSection">
      <h2 style="margin-bottom: 16px;">ç”Ÿæˆç»“æœ</h2>

      <div class="status" id="statusBox">
        <span class="spinner"></span>
        <span id="statusText">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</span>
      </div>

      <div class="video-container" id="videoContainer" style="display: none;">
        <video id="videoPlayer" controls></video>
      </div>

      <div class="links" id="linksContainer" style="display: none;">
        <a href="#" id="watchLink" target="_blank">â–¶ï¸ åœ¨çº¿è§‚çœ‹</a>
        <a href="#" id="downloadLink" target="_blank">â¬ ä¸‹è½½è§†é¢‘</a>
      </div>

      <button class="toggle-raw" onclick="toggleRawContent()">æ˜¾ç¤º/éšè—åŸå§‹å“åº”</button>
      <div class="raw-content" id="rawContent" style="display: none;"></div>
    </div>

    <p class="api-info">
      å½“å‰ API: <span id="apiEndpointText"></span><br>
      åç«¯ä¸Šæ¸¸: https://api1.147ai.com/v1/chat/completions<br>
      API ç«¯ç‚¹: POST /api/public/ai/veo/generate<br>
      æ”¯æŒæ¨¡å‹: veo3-fast | veo3-pro | veo3-pro-frames
    </p>
  </div>

  <script>
    let selectedModel = 'veo3-fast';
    const API_PATH = '/api/public/ai/veo/generate';

    function normalizeBaseUrl(value) {
      const trimmed = (value || '').trim();
      if (!trimmed) return '';
      try {
        const url = new URL(trimmed);
        if (url.protocol === 'http:' || url.protocol === 'https:') {
          return url.origin;
        }
        return '';
      } catch {
        const scheme = /^(localhost|127\.0\.0\.1|0\.0\.0\.0)(:\d+)?$/i.test(trimmed) ? 'http' : 'https';
        return `${scheme}://${trimmed}`.replace(/\/$/, '');
      }
    }

    function getInferredBase() {
      const origin = location.origin;
      // Safari åœ¨ file:// åœºæ™¯ä¸‹å¯èƒ½è¿”å› "file://"
      if (origin && origin !== 'null' && !origin.startsWith('file:')) {
        return origin;
      }
      return 'http://localhost:4000';
    }

    const apiBaseInput = document.getElementById('apiBase');
    const apiEndpointText = document.getElementById('apiEndpointText');

    function getApiBase() {
      return normalizeBaseUrl(apiBaseInput.value) || getInferredBase();
    }

    function updateApiInfo() {
      apiEndpointText.textContent = `${getApiBase()}${API_PATH}`;
    }

    // åˆå§‹åŒ– API Baseï¼šquery > localStorage > inferred
    const params = new URLSearchParams(location.search);
    const baseFromQuery = params.get('apiBase') || params.get('base');
    const baseFromStorage = localStorage.getItem('veo_api_base');
    const initialBase = baseFromQuery || baseFromStorage || getInferredBase();
    const normalizedInitialBase = normalizeBaseUrl(initialBase) || getInferredBase();
    apiBaseInput.value = normalizedInitialBase;
    localStorage.setItem('veo_api_base', normalizedInitialBase);
    updateApiInfo();

    apiBaseInput.addEventListener('change', () => {
      const normalizedBase = getApiBase();
      apiBaseInput.value = normalizedBase;
      localStorage.setItem('veo_api_base', normalizedBase);
      updateApiInfo();
    });

    // æ¨¡å‹é€‰æ‹©
    document.querySelectorAll('.model-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedModel = card.dataset.model;

        // æ˜¾ç¤º/éšè—å›¾ç‰‡è¾“å…¥
        const imageGroup = document.getElementById('imageInputGroup');
        if (selectedModel === 'veo3-pro-frames') {
          imageGroup.classList.add('visible');
        } else {
          imageGroup.classList.remove('visible');
        }
      });
    });

    async function generateVideo() {
      const prompt = document.getElementById('prompt').value.trim();
      const imageUrl = document.getElementById('imageUrl').value.trim();
      const btn = document.getElementById('generateBtn');
      const resultSection = document.getElementById('resultSection');
      const statusBox = document.getElementById('statusBox');
      const statusText = document.getElementById('statusText');
      const videoContainer = document.getElementById('videoContainer');
      const linksContainer = document.getElementById('linksContainer');
      const rawContent = document.getElementById('rawContent');

      if (!prompt) {
        alert('è¯·è¾“å…¥è§†é¢‘æè¿°');
        return;
      }

      if (selectedModel === 'veo3-pro-frames' && !imageUrl) {
        alert('veo3-pro-frames æ¨¡å¼éœ€è¦æä¾›å‚è€ƒå›¾ç‰‡ URL');
        return;
      }

      // é‡ç½® UI
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> ç”Ÿæˆä¸­...';
      resultSection.classList.add('visible');
      statusBox.className = 'status status-loading';
      statusText.textContent = 'æ­£åœ¨ç”Ÿæˆè§†é¢‘ï¼Œè¯·ç¨å€™...';
      videoContainer.style.display = 'none';
      linksContainer.style.display = 'none';
      rawContent.style.display = 'none';

      try {
        const body = {
          prompt,
          model: selectedModel,
        };

        if (selectedModel === 'veo3-pro-frames' && imageUrl) {
          body.referenceImageUrl = imageUrl;
        }

        // ä½¿ç”¨åç«¯å…¬å¼€ API åœ°å€ï¼ˆæ— éœ€è®¤è¯ï¼‰
        const response = await fetch(`${getApiBase()}${API_PATH}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify(body),
        });

        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { success: false, error: text };
        }
        rawContent.textContent = JSON.stringify(data, null, 2);

        if (data.success && (data.videoUrl || data.downloadUrl)) {
          statusBox.className = 'status status-success';
          statusText.textContent = 'âœ… è§†é¢‘ç”ŸæˆæˆåŠŸï¼';

          const videoUrl = data.videoUrl || data.downloadUrl;

          // æ˜¾ç¤ºè§†é¢‘
          const videoPlayer = document.getElementById('videoPlayer');
          videoPlayer.src = videoUrl;
          videoContainer.style.display = 'block';

          // æ˜¾ç¤ºé“¾æ¥
          if (data.videoUrl) {
            document.getElementById('watchLink').href = data.videoUrl;
          }
          if (data.downloadUrl) {
            document.getElementById('downloadLink').href = data.downloadUrl;
          }
          linksContainer.style.display = 'flex';
        } else {
          statusBox.className = 'status status-error';
          statusText.textContent = 'âŒ ' + (data.error || 'ç”Ÿæˆå¤±è´¥');

          if (data.rawContent) {
            rawContent.textContent = data.rawContent;
            rawContent.style.display = 'block';
          }
        }
      } catch (error) {
        statusBox.className = 'status status-error';
        statusText.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ç”Ÿæˆè§†é¢‘';
      }
    }

    function toggleRawContent() {
      const rawContent = document.getElementById('rawContent');
      rawContent.style.display = rawContent.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>
</html>
