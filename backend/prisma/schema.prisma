generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ApiUsageRecord {
  id               String   @id
  userId           String
  serviceType      String
  serviceName      String
  provider         String
  model            String?
  creditsUsed      Int
  inputTokens      Int?
  outputTokens     Int?
  inputImageCount  Int?
  outputImageCount Int?
  requestParams    Json?
  responseStatus   String
  errorMessage     String?
  processingTime   Int?
  ipAddress        String?
  userAgent        String?
  createdAt        DateTime @default(now())
  User             User     @relation(fields: [userId], references: [id])

  @@index([provider])
  @@index([responseStatus])
  @@index([serviceType])
  @@index([userId, createdAt])
}

model CreditAccount {
  id                String              @id
  userId            String              @unique
  balance           Int                 @default(0)
  totalEarned       Int                 @default(0)
  totalSpent        Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  lastDailyRewardAt DateTime?
  User              User                @relation(fields: [userId], references: [id])
  CreditTransaction CreditTransaction[]
}

model CreditPackage {
  id           String   @id
  name         String
  credits      Int
  price        Decimal  @db.Decimal(10, 2)
  bonusCredits Int      @default(0)
  description  String?
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
}

model CreditPricing {
  id               String   @id
  serviceType      String   @unique
  serviceName      String
  provider         String
  creditsPerCall   Int
  description      String?
  isActive         Boolean  @default(true)
  maxInputTokens   Int?
  maxContextLength Int?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime
}

model CreditTransaction {
  id            String        @id
  accountId     String
  type          String
  amount        Int
  balanceBefore Int
  balanceAfter  Int
  description   String
  apiUsageId    String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  CreditAccount CreditAccount @relation(fields: [accountId], references: [id])

  @@index([accountId, createdAt])
  @@index([type])
}

model GlobalImageHistory {
  id                String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId            String
  imageUrl          String
  prompt            String?
  sourceType        String
  sourceProjectId   String?
  sourceProjectName String?
  metadata          Json?
  createdAt         DateTime @default(now())
  User              User     @relation(fields: [userId], references: [id])

  @@index([sourceType])
  @@index([userId, createdAt(sort: Desc)])
}

model InvitationCode {
  id                   String                 @id
  code                 String                 @unique
  status               String                 @default("active")
  maxUses              Int                    @default(1)
  usedCount            Int                    @default(0)
  inviterUserId        String?
  metadata             Json?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  User                 User?                  @relation(fields: [inviterUserId], references: [id])
  InvitationRedemption InvitationRedemption[]

  @@index([status])
}

model InvitationRedemption {
  id                                            String         @id
  codeId                                        String
  inviteeUserId                                 String
  inviterUserId                                 String?
  metadata                                      Json?
  createdAt                                     DateTime       @default(now())
  InvitationCode                                InvitationCode @relation(fields: [codeId], references: [id])
  User_InvitationRedemption_inviteeUserIdToUser User           @relation("InvitationRedemption_inviteeUserIdToUser", fields: [inviteeUserId], references: [id])
  User_InvitationRedemption_inviterUserIdToUser User?          @relation("InvitationRedemption_inviterUserIdToUser", fields: [inviterUserId], references: [id])

  @@index([codeId])
  @@index([inviteeUserId])
}

model Project {
  id             String   @id
  userId         String
  name           String
  ossPrefix      String
  mainKey        String
  thumbnailUrl   String?
  contentVersion Int      @default(1)
  contentJson    Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  User           User     @relation(fields: [userId], references: [id])
}

model PublicTemplate {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  category       String?
  description    String?
  tags           String[]
  thumbnail      String?
  templateData   Json     @default("{}")
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdBy      String?
  updatedBy      String?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @db.Timestamptz(6)
  thumbnailSmall String?

  @@index([category], map: "idx_publictemplate_category")
  @@index([thumbnailSmall], map: "idx_publictemplate_thumbnailsmall")
}

model RefreshToken {
  id        String   @id
  userId    String
  tokenHash String
  userAgent String?
  ip        String?
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])

  @@index([userId, isRevoked])
}

model SystemSetting {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  metadata    Json?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model User {
  id                                                            String                 @id
  email                                                         String?                @unique
  phone                                                         String                 @unique
  passwordHash                                                  String
  name                                                          String?
  avatarUrl                                                     String?
  role                                                          String                 @default("user")
  status                                                        String                 @default("active")
  googleCustomApiKey                                            String?
  googleKeyMode                                                 String                 @default("official")
  googleOfficialVerified                                        Boolean                @default(false)
  googleOfficialVerifiedAt                                      DateTime?
  lastLoginAt                                                   DateTime?
  createdAt                                                     DateTime               @default(now())
  updatedAt                                                     DateTime
  invitedById                                                   String?
  ApiUsageRecord                                                ApiUsageRecord[]
  CreditAccount                                                 CreditAccount?
  GlobalImageHistory                                            GlobalImageHistory[]
  InvitationCode                                                InvitationCode[]
  InvitationRedemption_InvitationRedemption_inviteeUserIdToUser InvitationRedemption[] @relation("InvitationRedemption_inviteeUserIdToUser")
  InvitationRedemption_InvitationRedemption_inviterUserIdToUser InvitationRedemption[] @relation("InvitationRedemption_inviterUserIdToUser")
  Project                                                       Project[]
  RefreshToken                                                  RefreshToken[]
  User                                                          User?                  @relation("UserToUser", fields: [invitedById], references: [id])
  other_User                                                    User[]                 @relation("UserToUser")
}

/// This table has subclasses and requires additional setup for migrations. Visit https://pris.ly/d/table-inheritance for more info.
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model postgres_log {
  log_time               DateTime? @db.Timestamptz(3)
  user_name              String?
  database_name          String?
  process_id             Int?
  connection_from        String?
  session_id             String
  session_line_num       BigInt
  command_tag            String?
  session_start_time     DateTime? @db.Timestamptz(6)
  virtual_transaction_id String?
  transaction_id         BigInt?
  error_severity         String?
  sql_state_code         String?
  message                String?
  detail                 String?
  hint                   String?
  internal_query         String?
  internal_query_pos     Int?
  context                String?
  query                  String?
  query_pos              Int?
  location               String?
  application_name       String?
  backend_type           String?
  leader_pid             Int?
  query_id               BigInt?

  @@ignore
}
