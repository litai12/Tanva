# 变更提案: paper_image_select_return_home

## 元信息
```yaml
类型: 修复
方案类型: implementation
优先级: P1
状态: 草稿
创建: 2026-01-22
```

---

## 1. 需求

### 背景
从项目返回首页后再进入项目，Paper 画布上的图片偶现无法点击/选中，导致无法进行拖拽、缩放等操作；刷新页面后恢复正常。

### 目标
- 返回首页再进入项目后，Paper 图片始终可选中且可操作
- 不依赖刷新即可恢复交互
- 不影响 Flow/其它画布元素的正常交互

### 约束条件
```yaml
时间约束: 无
性能约束: 无新增明显卡顿
兼容性约束: 保持现有浏览器兼容范围
业务约束: 无
```

### 验收标准
- [ ] 从项目返回首页，再进入同一项目后，任意 Paper 图片可稳定选中并执行移动/缩放等操作
- [ ] 画布刷新、切换项目、首次进入等场景不受影响，Flow 交互正常

---

## 2. 方案

### 技术方案
1) 在画布进入/恢复时对 Paper 项目做一致性检查：若存在 Raster/图片组但图片实例或选择区域未恢复，则触发一次重建与选择元素补齐。
2) 命中检测以当前 `paper.view.element` 为准，避免 Canvas 复用/重建后坐标转换不一致导致 hitTest 失败。
3) 校验 Flow Overlay 的指针事件拦截策略，仅在 Flow UI 启用且当前处于 Flow 交互区时拦截，避免误阻画布点击。

### 影响范围
```yaml
涉及模块:
  - frontend-canvas: 画布初始化、选择命中、实例重建
  - frontend-flow: FlowOverlay 指针事件策略（若验证为拦截问题）
预计变更文件: 3-5
```

### 风险评估
| 风险 | 等级 | 应对 |
|------|------|------|
| 反复重建导致闪烁或性能回退 | 中 | 仅在检测到缺失状态时触发重建，且加节流/单次保护 |
| Flow 层事件策略调整影响 Flow 操作 | 中 | 仅在 Flow UI 禁用或非 Flow 区域时放行，增加回归手动验证 |

---

## 3. 技术设计（可选）

> 不涉及架构/接口变更

---

## 4. 核心场景

### 场景: 返回首页再进入项目后可选中图片
**模块**: Canvas / Paper 交互
**条件**: 在项目内点击“返回首页”，再进入同一项目
**行为**: 点击/拖拽任意图片
**结果**: 图片可选中并正常操作，不需要刷新

---

## 5. 技术决策

### paper_image_select_return_home#D001: 以“缺失检测 + 兜底重建”修复回到项目后图片不可选问题
**日期**: 2026-01-22
**状态**: ✅采纳
**背景**: 现象为偶现，疑似初始化/恢复时序导致选择元素或实例未恢复
**选项分析**:
| 选项 | 优点 | 缺点 |
|------|------|------|
| A: 强制每次进入都全量重建 | 简单直接 | 可能增加刷新/闪烁成本 |
| B: 缺失检测后按需重建 | 降低无谓重建 | 需要更谨慎的检测逻辑 |
**决策**: 选择方案B
**理由**: 兼顾稳定性与性能，避免不必要的全量重建
**影响**: `frontend/src/components/canvas/DrawingController.tsx`、`frontend/src/utils/paperCoords.ts`、`frontend/src/components/flow/FlowOverlay.tsx`
