# Tanva ECS éƒ¨ç½²å¿«é€Ÿæ£€æŸ¥æ¸…å•

## ğŸ“ éƒ¨ç½²å‰æ£€æŸ¥

### ä¿¡æ¯å‡†å¤‡æ¸…å•

```
â–¡ è®°å½•ECSå…¬ç½‘IPåœ°å€: ___________________
â–¡ è·å–SSHå¯†é’¥å¯¹æ–‡ä»¶ (.pem): ___________________
â–¡ å‡†å¤‡å¥½ä½ çš„åŸŸå: ___________________
â–¡ è·å–Google Gemini API Key: ___________________
â–¡ GitHubä»“åº“URL: ___________________
```

### æœ¬åœ°ä»£ç å‡†å¤‡

```bash
# åœ¨æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œè¿™äº›å‘½ä»¤
cd ~/Documents/Development/dev/Tanva

# ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤
git status
# åº”è¯¥æ˜¾ç¤º: nothing to commit, working tree clean

# æ¨é€ä»£ç åˆ°è¿œç¨‹ä»“åº“
git push origin oss

# æŸ¥çœ‹æœ€åçš„æäº¤
git log --oneline -5
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ ä»£ç å·²æäº¤
â–¡ ä»£ç å·²æ¨é€åˆ°è¿œç¨‹
â–¡ åˆ†æ”¯åç§°: oss æˆ– main
```

---

## ğŸš€ éƒ¨ç½²æ‰§è¡Œæ­¥éª¤

### ç¬¬1æ­¥: SSHè¿æ¥åˆ°ECS (5åˆ†é’Ÿ)

**ä½ éœ€è¦çš„ä¿¡æ¯:**
- ECSå…¬ç½‘IP: `47.106.140.227`
- å¯†é’¥æ–‡ä»¶ä½ç½®: `~/.ssh/your-key-pair.pem`

**æ‰§è¡Œå‘½ä»¤:**
```bash
# å°†å¯†é’¥æ–‡ä»¶æ”¾åˆ°æ­£ç¡®ä½ç½®
cp ~/Downloads/your-key-pair.pem ~/.ssh/
chmod 600 ~/.ssh/your-key-pair.pem

# SSHè¿æ¥åˆ°ECS
ssh -i ~/.ssh/your-key-pair.pem ubuntu@47.106.140.227
```

**éªŒè¯è¿æ¥æˆåŠŸ:**
```
â–¡ çœ‹åˆ°å‘½ä»¤æç¤ºç¬¦: ubuntu@i-bp1...~$
â–¡ è¿è¡Œ: lsb_release -a (éªŒè¯Ubuntuç‰ˆæœ¬)
â–¡ è¿è¡Œ: df -h (éªŒè¯ç£ç›˜ç©ºé—´ >20GB)
```

---

### ç¬¬2æ­¥: å‡†å¤‡éƒ¨ç½²è„šæœ¬ (2åˆ†é’Ÿ)

åœ¨æœ¬åœ°æœºå™¨ä¸Šï¼š

```bash
# è¿›å…¥Tanvaç›®å½•
cd ~/Documents/Development/dev/Tanva

# æŸ¥çœ‹éƒ¨ç½²è„šæœ¬å·²åˆ›å»º
ls -la deploy-to-ecs.sh

# ä½¿ç”¨SCPä¸Šä¼ è„šæœ¬åˆ°ECS
scp -i ~/.ssh/your-key-pair.pem deploy-to-ecs.sh ubuntu@47.106.140.227:~/
```

éªŒè¯è„šæœ¬ä¸Šä¼ æˆåŠŸï¼š
```
â–¡ çœ‹åˆ°æ–‡ä»¶ä¼ è¾“å®Œæˆæ¶ˆæ¯
```

---

### ç¬¬3æ­¥: æ‰§è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ (15-20åˆ†é’Ÿ)

åœ¨ECSä¸Šè¿è¡Œï¼š

```bash
# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
bash ~/deploy-to-ecs.sh

# è„šæœ¬ä¼šæ˜¾ç¤ºè¿›åº¦ä¿¡æ¯:
# [1/10] Updating system packages...
# [2/10] Installing Node.js...
# ... ç­‰ç­‰
```

**è„šæœ¬æ‰§è¡Œå®Œæˆåï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯:**

```
æ•°æ®åº“ä¿¡æ¯:
- Database User: tanva_user
- Database Password: _________________ (ä¿å­˜å¥½ï¼)
- Database Name: tanva

è¾“å‡ºçš„è¯´æ˜:
- PostgreSQLå·²é…ç½®
- Nginxå·²é…ç½®
- PM2å·²å¯åŠ¨
```

éªŒè¯è„šæœ¬å®Œæˆï¼š
```
â–¡ çœ‹åˆ° "Deployment Configuration Complete!" æ¶ˆæ¯
â–¡ çœ‹åˆ°å®Œæ•´çš„"Next Steps"è¯´æ˜
```

---

### ç¬¬4æ­¥: é…ç½®ç¯å¢ƒå˜é‡ (3åˆ†é’Ÿ)

#### 4a. ç¼–è¾‘æœåŠ¡ç«¯ç¯å¢ƒæ–‡ä»¶

åœ¨ECSä¸Šè¿è¡Œï¼š

```bash
sudo nano /home/ubuntu/tanva/server/.env.production
```

**éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†:**

æ‰¾åˆ°è¿™ä¸€è¡Œï¼š
```env
DATABASE_URL="postgresql://tanva_user:YOUR_DB_PASSWORD@localhost:5432/tanva?schema=public"
```

æ›¿æ¢ `YOUR_DB_PASSWORD` ä¸ºè„šæœ¬è¾“å‡ºçš„å¯†ç ã€‚

æ‰¾åˆ°è¿™ä¸€è¡Œï¼š
```env
GOOGLE_GEMINI_API_KEY=your_gemini_api_key_here
```

æ›¿æ¢ä¸ºä½ çš„å®é™…API Keyã€‚

æ‰¾åˆ°è¿™ä¸¤è¡Œï¼š
```env
CORS_ORIGIN=https://your-domain.com,https://www.your-domain.com
```

æ›¿æ¢ `your-domain.com` ä¸ºä½ çš„å®é™…åŸŸåï¼ˆå¦‚: `tai.tanva.tgtai.com`ï¼‰

**ä¿å­˜æ–‡ä»¶:**
- æŒ‰ `Ctrl + O` (ä¿å­˜)
- æŒ‰ `Enter` (ç¡®è®¤æ–‡ä»¶å)
- æŒ‰ `Ctrl + X` (é€€å‡º)

éªŒè¯ï¼š
```bash
cat /home/ubuntu/tanva/server/.env.production
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ DATABASE_URL åŒ…å«æ­£ç¡®çš„å¯†ç 
â–¡ GOOGLE_GEMINI_API_KEY åŒ…å«ä½ çš„API Key
â–¡ CORS_ORIGIN åŒ…å«ä½ çš„åŸŸå
```

#### 4b. ç¼–è¾‘å‰ç«¯ç¯å¢ƒæ–‡ä»¶

```bash
sudo nano /home/ubuntu/tanva/.env.production
```

æ›¿æ¢æ‰€æœ‰çš„ `your-domain.com` ä¸ºä½ çš„å®é™…åŸŸåï¼ˆå¦‚: `tai.tanva.tgtai.com`ï¼‰

**ä¿å­˜æ–‡ä»¶:**
- æŒ‰ `Ctrl + O`
- æŒ‰ `Enter`
- æŒ‰ `Ctrl + X`

éªŒè¯ï¼š
```bash
cat /home/ubuntu/tanva/.env.production
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ VITE_API_BASE åŒ…å«æ­£ç¡®çš„åŸŸå
â–¡ VITE_API_URL åŒ…å«æ­£ç¡®çš„åŸŸå
```

---

### ç¬¬5æ­¥: æ›´æ–°Nginxé…ç½® (2åˆ†é’Ÿ)

```bash
sudo nano /etc/nginx/sites-available/tanva
```

æ›¿æ¢æ‰€æœ‰çš„ `your-domain.com` ä¸ºä½ çš„å®é™…åŸŸåã€‚

ä¾‹å¦‚ï¼Œæ‰¾åˆ°è¿™è¡Œï¼š
```nginx
server_name your-domain.com www.your-domain.com;
```

æ”¹ä¸ºï¼š
```nginx
server_name tai.tanva.tgtai.com www.tai.tanva.tgtai.com;
```

**ä¿å­˜æ–‡ä»¶:**
- æŒ‰ `Ctrl + O`
- æŒ‰ `Enter`
- æŒ‰ `Ctrl + X`

**æµ‹è¯•Nginxé…ç½®ï¼š**
```bash
sudo nginx -t
# åº”è¯¥çœ‹åˆ°: nginx: the configuration file syntax is ok
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ Nginxé…ç½®æµ‹è¯•é€šè¿‡
â–¡ server_name å·²æ›´æ–°ä¸ºä½ çš„åŸŸå
```

---

### ç¬¬6æ­¥: é…ç½®DNSè®°å½• (ç­‰å¾…DNSç”Ÿæ•ˆ 5-30åˆ†é’Ÿ)

ç™»å½•ä½ çš„åŸŸåæœåŠ¡å•†æ§åˆ¶å°ï¼ˆå¦‚é˜¿é‡Œäº‘åŸŸåæœåŠ¡ã€Cloudflareç­‰ï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹Aè®°å½•ï¼š

**å¦‚æœä½ çš„åŸŸåæ˜¯ `tai.tanva.tgtai.com`:**

| ä¸»æœºè®°å½• | è®°å½•å€¼ (å…¬ç½‘IP) | è®°å½•ç±»å‹ | TTL |
|---------|----------------|---------|-----|
| tai | 47.106.140.227 | A | 600 |

æˆ–è€… (å¦‚æœä½¿ç”¨www)ï¼š

| ä¸»æœºè®°å½• | è®°å½•å€¼ (å…¬ç½‘IP) | è®°å½•ç±»å‹ | TTL |
|---------|----------------|---------|-----|
| www.tai | 47.106.140.227 | A | 600 |

éªŒè¯DNSç”Ÿæ•ˆï¼š
```bash
# åœ¨æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œï¼ˆéœ€è¦ç­‰å¾…DNSç”Ÿæ•ˆï¼‰
nslookup tai.tanva.tgtai.com
# åº”è¯¥è¿”å›: 47.106.140.227
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ DNSè®°å½•å·²æ·»åŠ åˆ°åŸŸåæœåŠ¡å•†
â–¡ DNSå·²ç”Ÿæ•ˆï¼ˆnslookupè¿”å›æ­£ç¡®IPï¼‰
```

---

### ç¬¬7æ­¥: å¯åŠ¨æœåŠ¡ (2åˆ†é’Ÿ)

åœ¨ECSä¸Šè¿è¡Œï¼š

```bash
# å¯åŠ¨Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# æ£€æŸ¥PM2æ˜¯å¦å·²è¿è¡Œ
pm2 status
# åº”è¯¥çœ‹åˆ°: tanva-server ONLINE

# å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œå¯åŠ¨å®ƒ
cd /home/ubuntu/tanva/server
pm2 start /home/ubuntu/tanva/ecosystem.config.js
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ Nginxå·²å¯åŠ¨: sudo systemctl status nginx (active)
â–¡ PM2å·²å¯åŠ¨: pm2 status (tanva-server ONLINE)
â–¡ PostgreSQLå·²è¿è¡Œ: sudo systemctl status postgresql (active)
```

---

### ç¬¬8æ­¥: é…ç½®SSLè¯ä¹¦ (5åˆ†é’Ÿ)

âš ï¸ **é‡è¦:** DNSå¿…é¡»å·²ç”Ÿæ•ˆæ‰èƒ½æ‰§è¡Œæ­¤æ­¥éª¤ï¼

åœ¨ECSä¸Šè¿è¡Œï¼š

```bash
# å®‰è£…Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦ï¼ˆå°† tai.tanva.tgtai.com æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåï¼‰
sudo certbot certonly --nginx -d tai.tanva.tgtai.com -d www.tai.tanva.tgtai.com
```

**æŒ‰ç…§æç¤ºï¼š**
1. è¾“å…¥ä½ çš„é‚®ç®±åœ°å€
2. åŒæ„æœåŠ¡æ¡æ¬¾ (è¾“å…¥: `y`)
3. æ˜¯å¦åˆ†äº«é‚®ç®± (è¾“å…¥: `n` æˆ– `y`)

**éªŒè¯è¯ä¹¦åˆ›å»ºæˆåŠŸï¼š**
```bash
ls -la /etc/letsencrypt/live/tai.tanva.tgtai.com/
# åº”è¯¥çœ‹åˆ°: fullchain.pem å’Œ privkey.pem
```

**æ›´æ–°Nginxé…ç½®ä¸­çš„è¯ä¹¦è·¯å¾„ï¼š**

```bash
sudo nano /etc/nginx/sites-available/tanva
```

æ‰¾åˆ°ï¼š
```nginx
ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
```

æ”¹ä¸ºï¼ˆä½¿ç”¨ä½ çš„å®é™…åŸŸåï¼‰ï¼š
```nginx
ssl_certificate /etc/letsencrypt/live/tai.tanva.tgtai.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/tai.tanva.tgtai.com/privkey.pem;
```

**ä¿å­˜æ–‡ä»¶å¹¶é‡å¯Nginxï¼š**
```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx

# å¯ç”¨è‡ªåŠ¨ç»­æœŸ
sudo systemctl enable certbot.timer
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ è¯ä¹¦æ–‡ä»¶å·²åˆ›å»º
â–¡ Nginxé…ç½®å·²æ›´æ–°
â–¡ Nginxé…ç½®æµ‹è¯•é€šè¿‡
â–¡ Nginxå·²é‡å¯
```

---

### ç¬¬9æ­¥: éªŒè¯éƒ¨ç½² (5åˆ†é’Ÿ)

#### åœ¨ECSä¸ŠéªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
pm2 status
sudo systemctl status nginx
sudo systemctl status postgresql

# æµ‹è¯•æœ¬åœ°API
curl http://localhost:4000/health
# åº”è¯¥è¿”å›200çŠ¶æ€ç 
```

#### åœ¨æœ¬åœ°æœºå™¨ä¸ŠéªŒè¯

```bash
# æµ‹è¯•HTTPSè¿æ¥ï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
curl -v https://tai.tanva.tgtai.com
# åº”è¯¥çœ‹åˆ°: < HTTP/2 200

# æˆ–åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
# https://tai.tanva.tgtai.com
# åº”è¯¥çœ‹åˆ°:
# âœ… ç»¿è‰²é” ğŸ”’
# âœ… Tanvaåº”ç”¨åŠ è½½
# âœ… æ— HTTPSè­¦å‘Š
```

#### æµ‹è¯•APIç«¯ç‚¹

```bash
# æµ‹è¯•å·¥å…·é€‰æ‹©ç«¯ç‚¹
curl -X POST https://tai.tanva.tgtai.com/api/ai/tool-selection \
  -H "Content-Type: application/json" \
  -d '{"prompt": "ç”Ÿæˆä¸€ä¸ªç¾ä¸½çš„æ—¥è½"}'

# åº”è¯¥è¿”å›ç±»ä¼¼:
# {"selectedTool": "generateImage", "parameters": {"prompt": "..."}}
```

æ£€æŸ¥æ¸…å•ï¼š
```
â–¡ pm2 status æ˜¾ç¤º tanva-server ONLINE
â–¡ Nginx æ˜¾ç¤º active (running)
â–¡ æµè§ˆå™¨è®¿é—®åº”ç”¨æ˜¾ç¤ºUI
â–¡ HTTPSé”æ˜¾ç¤ºç»¿è‰²
â–¡ APIç«¯ç‚¹è¿”å›200çŠ¶æ€ç 
```

---

## âŒ é‡åˆ°é—®é¢˜ï¼Ÿ

### å¿«é€Ÿè¯Šæ–­

```bash
# 1. æ£€æŸ¥æ‰€æœ‰æœåŠ¡
pm2 status
sudo systemctl status nginx
sudo systemctl status postgresql

# 2. æŸ¥çœ‹æ—¥å¿—
pm2 logs tanva-server
sudo tail -f /var/log/nginx/error.log

# 3. æµ‹è¯•è¿æ¥
curl -v http://localhost:4000/health

# 4. æ£€æŸ¥é…ç½®
cat /home/ubuntu/tanva/server/.env.production
```

### å¸¸è§é—®é¢˜

| é—®é¢˜ | æ£€æŸ¥é¡¹ | è§£å†³æ–¹æ¡ˆ |
|------|--------|--------|
| 502 Bad Gateway | Nginx â†’ åç«¯ | æ£€æŸ¥PM2æ˜¯å¦è¿è¡Œ, `pm2 restart tanva-server` |
| æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ | DATABASE_URL | æ£€æŸ¥.envæ–‡ä»¶ä¸­å¯†ç æ˜¯å¦æ­£ç¡® |
| SSLè¯ä¹¦é”™è¯¯ | Let's Encrypt | æ£€æŸ¥DNSæ˜¯å¦ç”Ÿæ•ˆ, è¿è¡Œ `nslookup` |
| CORSé”™è¯¯ | CORS_ORIGIN | æ›´æ–°.envä¸­çš„CORS_ORIGIN, é‡å¯åç«¯ |
| APIè¶…æ—¶ | ç½‘ç»œ | æ£€æŸ¥å®‰å…¨ç»„æ˜¯å¦å…è®¸443/80ç«¯å£ |

æŸ¥çœ‹ **ALIYUN_ECS_DEPLOYMENT_GUIDE.md** çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†è·å–æ›´è¯¦ç»†çš„å¸®åŠ©ã€‚

---

## âœ… éƒ¨ç½²å®Œæˆæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹æƒ…å†µï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼š

```
â–¡ è®¿é—® https://tai.tanva.tgtai.com æ˜¾ç¤ºTanvaåº”ç”¨
â–¡ HTTPSé”ç»¿è‰²æ˜¾ç¤º ğŸ”’
â–¡ æ§åˆ¶å°æ²¡æœ‰é”™è¯¯æ¶ˆæ¯
â–¡ AIèŠå¤©åŠŸèƒ½æ­£å¸¸
â–¡ pm2 status æ˜¾ç¤º ONLINE
â–¡ å“åº”æ—¶é—´ <2ç§’
```

---

## ğŸ“š å®Œæ•´æ–‡æ¡£

- è¯¦ç»†æ­¥éª¤: **ALIYUN_ECS_DEPLOYMENT_GUIDE.md**
- éƒ¨ç½²è„šæœ¬: **deploy-to-ecs.sh**
- æ—¥å¸¸ç»´æŠ¤: **ALIYUN_ECS_DEPLOYMENT_GUIDE.md** çš„æ—¥å¸¸ç»´æŠ¤éƒ¨åˆ†

---

## éœ€è¦å¸®åŠ©?

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹å¯¹åº”çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. æ”¶é›†æ—¥å¿—: `pm2 logs`, `sudo tail -f /var/log/nginx/error.log`
3. éªŒè¯æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„å€¼
4. æ£€æŸ¥å®‰å…¨ç»„è§„åˆ™
5. ç¡®è®¤DNSå·²ç”Ÿæ•ˆ

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸš€
