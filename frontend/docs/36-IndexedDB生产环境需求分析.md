# IndexedDB 生产环境需求分析

## 📊 当前项目存储架构

### 现有存储方案

1. **IndexedDB**（有限使用）
   - 仅用于用户模板存储（`templateStore.ts`）
   - 存储模板配置数据，非大文件

2. **localStorage**（主要本地存储）
   - 图像历史记录（`imageHistoryStore.ts`）- 仅存储 URL，不存储 base64
   - 个人库资源（`personalLibraryStore.ts`）- 过滤大 base64 数据
   - AI 聊天会话（`aiChatStore.ts`）- 迁移 base64 到 OSS
   - 其他 Zustand 状态持久化
   - **配额限制**：通常 5-10MB，已有降级机制

3. **内存缓存**
   - `ImageUrlCacheService` - URL 缓存（30分钟 TTL，最多 100 条）
   - 临时状态缓存

4. **云端存储**
   - **PostgreSQL**：项目数据、用户数据、元数据
   - **阿里云 OSS**：图像资源、文件资源
   - 自动保存机制

## 🔍 问题分析

### localStorage 的局限性

1. **存储容量限制**
   - 浏览器通常限制 5-10MB
   - 项目已有配额超限处理（`storageUtils.ts`），但会降级到内存存储
   - 内存存储：刷新后丢失

2. **数据丢失风险**
   - 配额超限时降级到内存，刷新后数据丢失
   - 用户可能丢失未同步的临时数据

3. **性能问题**
   - localStorage 是同步 API，可能阻塞主线程
   - 大量数据序列化/反序列化开销

### 当前数据特点

1. **图像数据量大**
   - AI 生成的图像（base64 可能几 MB）
   - 图像历史记录（最多 50 条）
   - 临时图像缓存

2. **需要离线访问**
   - 用户可能需要在弱网环境下工作
   - 已生成的图像需要快速访问

3. **临时数据需要持久化**
   - 草稿状态
   - 未保存的编辑
   - 临时缓存

## ✅ 生产环境是否需要 IndexedDB？

### **建议：需要，但分阶段实施**

## 🎯 IndexedDB 的优势

1. **大容量存储**
   - 通常可存储数百 MB 到数 GB（取决于浏览器和磁盘空间）
   - 远超 localStorage 的 5-10MB 限制

2. **异步操作**
   - 不阻塞主线程
   - 适合大量数据操作

3. **结构化存储**
   - 支持索引查询
   - 支持事务
   - 支持 Blob 存储（适合图像）

4. **持久化**
   - 数据持久保存，不会因刷新丢失
   - 即使配额超限也能继续存储

## 📋 推荐使用场景

### 高优先级（建议立即实施）

1. **图像离线缓存**
   ```typescript
   // 存储已生成的图像，支持离线访问
   - 图像 Blob 存储
   - 图像元数据（URL、时间戳、项目ID）
   - 支持按项目ID、时间范围查询
   - 自动清理过期缓存（如 7 天）
   ```

2. **草稿数据持久化**
   ```typescript
   // 未保存的编辑内容
   - 画布草稿状态
   - 自动保存前的临时数据
   - 防止意外关闭导致数据丢失
   ```

3. **图像历史记录增强**
   ```typescript
   // 当前使用 localStorage，但可能超限
   - 迁移到 IndexedDB
   - 支持存储更多历史记录（如 200+ 条）
   - 支持图像缩略图缓存
   ```

### 中优先级（后续优化）

4. **AI 聊天会话缓存**
   ```typescript
   // 当前部分存储在 localStorage
   - 大型会话数据迁移到 IndexedDB
   - 支持会话搜索和归档
   ```

5. **模板系统扩展**
   ```typescript
   // 已有 IndexedDB 实现，可扩展
   - 支持模板预览图缓存
   - 支持模板分类和标签索引
   ```

6. **3D 模型缓存**
   ```typescript
   // GLB/GLTF 文件可能较大
   - 模型文件本地缓存
   - 减少重复下载
   ```

### 低优先级（可选）

7. **项目快照**
   ```typescript
   // 本地项目快照，用于快速恢复
   - 定期创建项目快照
   - 支持版本对比
   ```

## 🚫 不需要 IndexedDB 的场景

1. **已上传到 OSS 的资源**
   - 云端已有完整备份
   - 只需缓存 URL 和元数据

2. **小量配置数据**
   - UI 状态、用户偏好等
   - localStorage 足够

3. **实时同步数据**
   - 项目内容（已通过自动保存同步到云端）
   - 用户认证信息

## 📐 实施建议

### 阶段一：核心功能（立即实施）

1. **图像离线缓存系统**
   ```typescript
   // 新建：src/services/imageCacheDB.ts
   - 使用 IndexedDB 存储图像 Blob
   - 支持按 imageId、projectId 查询
   - 自动清理策略（LRU + 时间过期）
   - 与现有 imageUrlCache 集成
   ```

2. **草稿数据持久化**
   ```typescript
   // 扩展：src/services/draftDB.ts
   - 存储未保存的画布状态
   - 定期清理已保存的草稿
   - 页面加载时自动恢复
   ```

### 阶段二：优化体验（1-2 周后）

3. **图像历史记录迁移**
   ```typescript
   // 重构：src/stores/imageHistoryStore.ts
   - 从 localStorage 迁移到 IndexedDB
   - 支持更多历史记录
   - 支持缩略图缓存
   ```

### 阶段三：高级功能（后续）

4. **AI 会话缓存优化**
5. **3D 模型缓存**
6. **项目快照系统**

## 🛠️ 技术实现建议

### 推荐库

1. **idb**（推荐）
   ```bash
   npm install idb
   ```
   - Promise-based IndexedDB 封装
   - TypeScript 支持好
   - API 简洁

2. **Dexie.js**（备选）
   ```bash
   npm install dexie
   ```
   - 功能更丰富
   - 支持查询、索引
   - 学习曲线稍陡

### 架构设计

```typescript
// 统一的 IndexedDB 管理器
src/services/indexedDB/
├── manager.ts          // DB 初始化和版本管理
├── imageCache.ts       // 图像缓存服务
├── draftStorage.ts    // 草稿存储服务
└── migrations/         // 数据迁移脚本
```

### 数据清理策略

1. **LRU（最近最少使用）**
   - 限制总存储大小（如 500MB）
   - 自动清理最旧的缓存

2. **时间过期**
   - 图像缓存：7 天
   - 草稿数据：30 天
   - 临时数据：1 天

3. **用户主动清理**
   - 提供清理缓存的功能
   - 显示存储使用情况

## ⚠️ 注意事项

1. **浏览器兼容性**
   - IndexedDB 支持良好，但需要处理降级
   - 提供 localStorage 降级方案

2. **数据迁移**
   - 从 localStorage 迁移到 IndexedDB 需要平滑过渡
   - 保持向后兼容

3. **隐私和清理**
   - 提供清除所有本地数据的功能
   - 符合隐私法规要求

4. **性能监控**
   - 监控 IndexedDB 操作性能
   - 避免阻塞主线程

5. **存储配额管理**
   - 监控存储使用情况
   - 提供存储使用情况展示
   - 超出限制时的处理策略

## 📊 成本效益分析

### 收益

1. **用户体验提升**
   - 离线访问能力
   - 更快的图像加载（本地缓存）
   - 减少数据丢失风险

2. **性能优化**
   - 减少网络请求
   - 更快的应用启动
   - 更好的响应速度

3. **成本降低**
   - 减少 OSS 访问次数
   - 降低带宽成本

### 成本

1. **开发成本**
   - 初期开发：2-3 天
   - 测试和维护：持续

2. **存储成本**
   - 用户本地存储，无服务器成本
   - 但需要管理存储配额

## 🎯 结论

### **建议：分阶段实施 IndexedDB**

**立即实施（高优先级）：**
- ✅ 图像离线缓存系统
- ✅ 草稿数据持久化

**短期优化（1-2 周）：**
- ✅ 图像历史记录迁移

**长期优化（后续）：**
- 其他功能按需实施

### 理由

1. **当前 localStorage 方案存在风险**
   - 配额限制可能导致数据丢失
   - 降级到内存存储不可靠

2. **项目特点适合 IndexedDB**
   - 大量图像数据
   - 需要离线访问
   - 需要大容量存储

3. **技术成熟度高**
   - IndexedDB 支持良好
   - 有成熟的封装库
   - 实施风险低

4. **收益明显**
   - 显著提升用户体验
   - 减少数据丢失风险
   - 性能优化

---

**最后更新**: 2025-01-XX  
**分析人**: AI Assistant  
**项目**: Tanva - 专业绘图与AI创作平台

