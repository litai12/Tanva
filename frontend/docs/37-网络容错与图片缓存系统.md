# 网络容错与图片缓存系统 - 解决网络不稳定时图片丢失问题

## 问题背景

用户反馈：在网络不稳定或网络中断的情况下，画布上的图片容易丢失，刷新页面后图片显示异常或完全消失。

**根本原因分析：**
1. **缺乏本地缓存**：图片数据只依赖远程URL，网络中断时无法加载
2. **无网络状态感知**：系统无法感知网络状态变化，无法在网络恢复时自动重试
3. **容错机制不完善**：图片加载失败后没有有效的备用方案

## 解决方案总览

### 🗄️ IndexedDB Blob缓存系统 (`imageBlobCache.ts`)
- **存储图片二进制数据**到本地IndexedDB
- **自动缓存**新上传的图片
- **智能清理**过期和超限的缓存
- **离线访问**支持

### 📡 网络状态监听 (`networkMonitor.ts`)
- **实时监控**网络连接状态
- **自动重试**网络恢复后的图片加载
- **智能调度**根据网络质量调整加载策略

### 🚀 递延加载策略 (`progressiveImageLoader.ts`)
- **优先级加载**可见区域图片优先
- **网络感知**慢速网络下降低并发
- **智能重试**指数退避重试机制

## 核心组件详解

### 1. ImageBlobCache - 图片二进制数据缓存

```typescript
import { imageBlobCache } from '@/services/imageBlobCache';

// 存储图片Blob
await imageBlobCache.storeBlob('image123', blob, {
  url: 'https://example.com/image.png',
  projectId: 'project1',
  fileName: 'image.png',
  width: 1024,
  height: 768
});

// 获取缓存的图片
const dataUrl = await imageBlobCache.getDataUrl('image123');
if (dataUrl) {
  // 使用缓存的数据URL创建图片
  const img = new Image();
  img.src = dataUrl;
}
```

**特性：**
- ✅ 500MB存储上限，LRU清理策略
- ✅ 7天默认过期时间
- ✅ 自动清理过期数据（每小时）
- ✅ 存储使用情况监控

### 2. NetworkMonitor - 网络状态监听

```typescript
import { networkMonitor } from '@/services/networkMonitor';

// 监听网络状态变化
networkMonitor.setEventHandlers({
  onOnline: () => {
    console.log('网络已恢复');
    // 触发图片重新加载
  },
  onOffline: () => {
    console.log('网络已断开');
    // 暂停非必要加载
  },
  onConnectionChange: (status) => {
    console.log('连接类型:', status.effectiveType);
    // 调整加载策略
  }
});

// 获取当前状态
const status = networkMonitor.getStatus();
if (!status.isOnline) {
  // 处理离线状态
}
```

**特性：**
- ✅ 监听在线/离线事件
- ✅ 检测连接类型和速度
- ✅ 网络恢复时自动触发重试
- ✅ 兼容性处理（降级到基本监听）

### 3. ProgressiveImageLoader - 递延加载管理器

```typescript
import { progressiveImageLoader } from '@/services/progressiveImageLoader';

// 添加图片加载任务
progressiveImageLoader.addTask(
  'image123',
  'https://example.com/image.png',
  'high', // 优先级：high | medium | low
  0 // 视口距离（越小越优先）
);

// 更新优先级（图片进入视口时）
progressiveImageLoader.updateTaskPriority('image123', 'high');

// 取消加载任务
progressiveImageLoader.cancelTask('image123');
```

**特性：**
- ✅ 基于优先级的智能排序
- ✅ 网络感知的并发控制
- ✅ 自动重试机制（指数退避）
- ✅ 视口距离优化

## 工作流程

### 正常网络情况
```
1. 用户上传图片 → 存储到OSS
2. 图片加载成功 → 自动缓存Blob到IndexedDB
3. 页面刷新 → 从IndexedDB恢复图片（秒开）
```

### 网络中断情况
```
1. 图片加载失败 → 标记为失败状态
2. 尝试从IndexedDB缓存恢复
3. 网络恢复 → 自动重新加载失败的图片
```

### 慢速网络情况
```
1. 检测到慢速网络 → 降低并发加载数
2. 优先加载可见区域图片
3. 延迟加载非可见区域图片
```

## 集成方式

### 在ImageLoadingService中的集成

```typescript
// 优先从Blob缓存获取备用数据
const cachedDataUrl = await imageBlobCache.getDataUrl(imageId, projectId);
if (cachedDataUrl) {
  // 使用缓存的数据
  raster.source = cachedDataUrl;
}
```

### 在Paper.js Raster中的容错处理

```typescript
raster.onError = async (error) => {
  // 1. 尝试从Blob缓存恢复
  const cached = await imageBlobCache.getDataUrl(imageId);

  // 2. 如果缓存失败，等待网络恢复后重试
  if (!networkMonitor.getStatus().isOnline) {
    window.addEventListener('networkRecovered', () => {
      raster.source = originalUrl; // 重试原始URL
    });
  }
};
```

### 在Canvas组件中的递延加载

```typescript
// 图片进入视口时提高优先级
const handleImageInViewport = (imageId: string) => {
  progressiveImageLoader.updateTaskPriority(imageId, 'high');
};

// 图片离开视口时降低优先级
const handleImageOutOfViewport = (imageId: string) => {
  progressiveImageLoader.updateTaskPriority(imageId, 'low');
};
```

## 性能优化

### 缓存策略
- **内存缓存**：5分钟TTL，最大20个条目（快速访问）
- **IndexedDB缓存**：7天TTL，500MB上限（持久存储）
- **LRU清理**：定期清理最少使用的缓存

### 网络优化
- **并发控制**：根据网络速度调整并发加载数
- **智能重试**：指数退避算法，避免网络风暴
- **超时控制**：15秒加载超时，20秒重连超时

### 存储优化
- **Blob存储**：直接存储二进制数据，避免base64膨胀
- **元数据索引**：按项目ID、时间戳等建立索引
- **空间管理**：自动清理过期和超限数据

## 兼容性处理

### IndexedDB不可用时
```typescript
if (typeof indexedDB === 'undefined') {
  console.warn('IndexedDB not supported, falling back to localStorage');
  // 降级到localStorage策略
}
```

### 网络API不可用时
```typescript
// 降级到基本的事件监听
window.addEventListener('online', handleOnline);
window.addEventListener('offline', handleOffline);
```

## 监控与调试

### 缓存统计信息
```typescript
const stats = imageBlobCache.getStats();
console.log('缓存统计:', {
  总大小: `${(stats.totalSize / 1024 / 1024).toFixed(1)}MB`,
  条目数: stats.entryCount,
  命中率: `${(stats.hitRate * 100).toFixed(1)}%`
});
```

### 加载队列状态
```typescript
const queueStatus = progressiveImageLoader.getQueueStatus();
console.log('加载队列:', {
  队列长度: queueStatus.queueLength,
  活跃加载: queueStatus.activeLoads,
  最大并发: queueStatus.maxConcurrent
});
```

### 网络状态监控
```typescript
const networkStatus = networkMonitor.getStatus();
console.log('网络状态:', {
  在线: networkStatus.isOnline,
  连接类型: networkStatus.connectionType,
  有效类型: networkStatus.effectiveType
});
```

## 测试验证

### 功能测试
1. **正常加载测试**：验证图片正常加载和缓存
2. **网络中断测试**：断开网络，验证缓存恢复
3. **网络恢复测试**：恢复网络，验证自动重试
4. **慢速网络测试**：模拟慢速网络，验证递延加载

### 性能测试
1. **缓存命中率测试**：统计缓存命中率
2. **加载时间测试**：对比有缓存和无缓存的加载时间
3. **内存使用测试**：监控内存和存储使用情况

### 兼容性测试
1. **浏览器兼容性**：测试不同浏览器的支持情况
2. **存储配额测试**：测试存储空间不足的情况
3. **网络条件测试**：测试各种网络条件下的表现

## 部署注意事项

### 依赖管理
- 确保所有新服务正确导入和初始化
- 检查循环依赖问题
- 验证服务销毁时的清理逻辑

### 错误处理
- 添加适当的错误边界
- 实现降级策略
- 提供用户友好的错误提示

### 监控告警
- 监控缓存命中率
- 监控加载失败率
- 监控存储使用情况

## 后续优化方向

### 短期优化（1-2周）
- [ ] 添加更精细的缓存策略
- [ ] 优化递延加载算法
- [ ] 增加更多监控指标

### 中期优化（1个月）
- [ ] 支持图片预加载
- [ ] 实现更智能的网络质量检测
- [ ] 添加缓存预热机制

### 长期优化（持续）
- [ ] 支持WebP等现代图片格式
- [ ] 实现分布式缓存
- [ ] 添加机器学习优化加载顺序

---

**实施日期**: 2025-01-XX
**预期效果**: 显著提升网络不稳定环境下的图片加载成功率和用户体验




