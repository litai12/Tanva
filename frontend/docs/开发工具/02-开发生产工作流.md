# ðŸš€ å¼€å‘-ç”Ÿäº§åˆ†ç¦»å·¥ä½œæµå®Œæ•´æŒ‡å—

## æž¶æž„æ¦‚è§ˆ

```
æœ¬åœ°å¼€å‘çŽ¯å¢ƒ (ä½ çš„ç”µè„‘)
â”œâ”€ å‰ç«¯: http://localhost:5173
â”œâ”€ åŽç«¯: http://localhost:4000
â””â”€ æ•°æ®åº“: PostgreSQL local

        â†“ git push

GitHub/GitLab ä»£ç ä»“åº“
â”œâ”€ åˆ†æ”¯: main (ç”Ÿäº§)
â”œâ”€ åˆ†æ”¯: dev (å¼€å‘)
â””â”€ åˆ†æ”¯: feature/* (åŠŸèƒ½åˆ†æ”¯)

        â†“ éƒ¨ç½²è„šæœ¬ (æ‰‹åŠ¨æˆ–è‡ªåŠ¨)

Aliyun ç”Ÿäº§çŽ¯å¢ƒ
â”œâ”€ å‰ç«¯: https://tai.tanva.tgtai.com
â”œâ”€ åŽç«¯ API: https://tai.tanva.tgtai.com/api
â”œâ”€ æ•°æ®åº“: RDS PostgreSQL
â””â”€ CDN: Aliyun OSS + CDN
```

---

## ç¬¬ä¸€æ­¥: å‡†å¤‡å·¥ä½œ (æœ¬å‘¨å®Œæˆ)

### 1.1 é…ç½® Git åˆ†æ”¯ç­–ç•¥

```bash
# åˆ›å»ºå¼€å‘åˆ†æ”¯
git branch dev
git branch -a  # æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯

# é…ç½®è¿œç¨‹åˆ†æ”¯
git push -u origin dev
git push -u origin main

# è®¾ç½®é»˜è®¤åˆ†æ”¯
# GitHub/GitLab ç½‘é¡µæŽ§åˆ¶å° â†’ Settings â†’ Default branch â†’ è®¾ä¸º main
```

### 1.2 åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶

**å‰ç«¯çŽ¯å¢ƒå˜é‡** - `.env.development`
```env
# å¼€å‘çŽ¯å¢ƒ
VITE_AI_LANGUAGE=zh
VITE_AUTH_MODE=server
VITE_API_BASE_URL=http://localhost:4000
# å¯é€‰ï¼šå¼€å‘çŽ¯å¢ƒä½¿ç”¨ localhost
VITE_DEV_SERVER=http://localhost:5173
```

**å‰ç«¯çŽ¯å¢ƒå˜é‡** - `.env.production`
```env
# ç”Ÿäº§çŽ¯å¢ƒ
VITE_AI_LANGUAGE=zh
VITE_AUTH_MODE=server
VITE_API_BASE_URL=https://your-backend-domain.com
```

**åŽç«¯çŽ¯å¢ƒå˜é‡** - `server/.env.development`
```env
# å¼€å‘çŽ¯å¢ƒ
PORT=4000
HOST=0.0.0.0
NODE_ENV=development

DATABASE_URL="postgresql://litai@localhost:5432/tanva?schema=public"
CORS_ORIGIN=http://localhost:5173,http://localhost:3000,http://192.168.2.115:5173,http://192.168.2.115:3000

# AIé…ç½®
DEFAULT_AI_PROVIDER=gemini
GOOGLE_GEMINI_API_KEY=your_dev_key

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=debug
```

**åŽç«¯çŽ¯å¢ƒå˜é‡** - `server/.env.production`
```env
# ç”Ÿäº§çŽ¯å¢ƒ
PORT=4000
HOST=0.0.0.0
NODE_ENV=production

DATABASE_URL="postgresql://tanva_user:strong_password@aliyun-rds-host:5432/tanva?schema=public"
CORS_ORIGIN=https://tai.tanva.tgtai.com

# AIé…ç½®
DEFAULT_AI_PROVIDER=gemini
GOOGLE_GEMINI_API_KEY=your_prod_key

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=info
```

### 1.3 é…ç½® .gitignore

```
# çŽ¯å¢ƒæ–‡ä»¶ - ä¸æäº¤åˆ°ä»“åº“
.env.local
.env.development.local
.env.production.local
.env.test.local

# ä¾èµ–
node_modules/
dist/
build/

# æ—¥å¿—
*.log
logs/

# ç³»ç»Ÿæ–‡ä»¶
.DS_Store
.vscode/settings.json
```

---

## ç¬¬äºŒæ­¥: æœ¬åœ°å¼€å‘æµç¨‹ (æ—¥å¸¸å·¥ä½œ)

### 2.1 å¼€å§‹æ–°åŠŸèƒ½å¼€å‘

```bash
# ä»Ž dev åˆ†æ”¯æ‹‰å–æœ€æ–°ä»£ç 
git checkout dev
git pull origin dev

# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/ai-chat-improvements

# å¼€å‘å’Œæäº¤
git add .
git commit -m "feat: æ”¹è¿›AIå¯¹è¯åŠŸèƒ½"

# æŽ¨é€åˆ°è¿œç¨‹
git push -u origin feature/ai-chat-improvements
```

### 2.2 æœ¬åœ°æµ‹è¯•

```bash
# ç»ˆç«¯1: å¯åŠ¨åŽç«¯ (å¼€å‘æ¨¡å¼)
cd server
npm install  # å¦‚æžœä¾èµ–æœ‰æ›´æ–°
npm run dev  # ä½¿ç”¨ .env.development

# ç»ˆç«¯2: å¯åŠ¨å‰ç«¯ (å¼€å‘æ¨¡å¼)
npm install  # å¦‚æžœä¾èµ–æœ‰æ›´æ–°
npm run dev  # è‡ªåŠ¨ä½¿ç”¨ .env.development
```

### 2.3 æœ¬åœ°ç½‘ç»œæµ‹è¯•

```bash
# å…¶ä»–PCè®¿é—®
http://192.168.2.115:5173

# æˆ–ä½¿ç”¨Cloudflare Tunnelå¿«é€Ÿæµ‹è¯•
bash setup-cloudflare-tunnel.sh
```

---

## ç¬¬ä¸‰æ­¥: ä»£ç å®¡æŸ¥å’Œåˆå¹¶ (å‘å¸ƒå‰)

### 3.1 åˆ›å»º Pull Request

```bash
# æŽ¨é€åŠŸèƒ½åˆ†æ”¯åŽï¼Œåœ¨GitHubåˆ›å»ºPR
# 1. è®¿é—® https://github.com/ä½ çš„ç”¨æˆ·å/Tanva
# 2. ç‚¹å‡» "Compare & pull request"
# 3. è®¾ç½®:
#    - Base: dev
#    - Compare: feature/ä½ çš„åŠŸèƒ½åˆ†æ”¯
# 4. æ·»åŠ æè¿°
# 5. è¯·æ±‚ä»£ç å®¡æŸ¥
```

**PR æè¿°æ¨¡æ¿**:
```markdown
## æè¿°
åšäº†ä»€ä¹ˆæ”¹å˜ï¼Ÿ

## ç±»åž‹
- [ ] æ–°åŠŸèƒ½
- [ ] é”™è¯¯ä¿®å¤
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£æ›´æ–°

## æµ‹è¯•æ¸…å•
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] æ²¡æœ‰æ–°çš„è­¦å‘Š
- [ ] ç›¸å…³æ–‡æ¡£å·²æ›´æ–°

## æˆªå›¾
(å¦‚æžœæœ‰UIå˜åŒ–)
```

### 3.2 ä»£ç å®¡æŸ¥

```bash
# å®¡æŸ¥è€…å®¡æŸ¥ä»£ç åŽ
# 1. å¦‚æžœéœ€è¦ä¿®æ”¹ï¼Œç»§ç»­åœ¨åŠŸèƒ½åˆ†æ”¯ä¸Šæäº¤
# 2. è‡ªåŠ¨åŒæ­¥åˆ°PR
# 3. é€šè¿‡å®¡æŸ¥åŽï¼Œåˆå¹¶åˆ° dev
```

---

## ç¬¬å››æ­¥: æµ‹è¯•çŽ¯å¢ƒéªŒè¯ (å¯é€‰)

### 4.1 éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ

```bash
# åœ¨ Aliyun åˆ›å»ºæµ‹è¯•å®žä¾‹
# æˆ–ä½¿ç”¨ Cloudflare Tunnel ä½œä¸ºä¸´æ—¶æµ‹è¯•çŽ¯å¢ƒ

# æµ‹è¯•çŽ¯å¢ƒå˜é‡ (.env.staging)
DATABASE_URL="postgresql://user@test-rds:5432/tanva_test"
CORS_ORIGIN=https://test.tai.tanva.tgtai.com
LOG_LEVEL=info
```

---

## ç¬¬äº”æ­¥: å‘å¸ƒåˆ°ç”Ÿäº§çŽ¯å¢ƒ

### 5.1 åˆå¹¶åˆ° main åˆ†æ”¯

```bash
# ç¡®ä¿ dev åˆ†æ”¯å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•
git checkout dev
git pull origin dev

# åˆ›å»ºå‘å¸ƒåˆ†æ”¯
git checkout -b release/v1.0.0

# æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼‰
# package.json: "version": "1.0.0"

# æäº¤ç‰ˆæœ¬æ›´æ–°
git add .
git commit -m "chore: bump version to 1.0.0"

# åˆ›å»º PR: release/v1.0.0 â†’ main
# åˆå¹¶åŽï¼Œmain åˆ†æ”¯å°±æ˜¯ç”Ÿäº§ç‰ˆæœ¬
```

### 5.2 æ ‡è®°å‘å¸ƒç‰ˆæœ¬ (å¯é€‰)

```bash
# åˆå¹¶åˆ° main åŽ
git checkout main
git pull origin main

# åˆ›å»º Git tag
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# åœ¨ GitHub åˆ›å»º Release
# https://github.com/ä½ çš„ç”¨æˆ·å/Tanva/releases/new
```

### 5.3 éƒ¨ç½²åˆ° Aliyun

#### æ–¹æ¡ˆA: æ‰‹åŠ¨éƒ¨ç½² (ç®€å•)

```bash
# SSH è¿žæŽ¥åˆ° Aliyun æœåŠ¡å™¨
ssh -i /path/to/key.pem ubuntu@ä½ çš„æœåŠ¡å™¨IP

# åœ¨æœåŠ¡å™¨ä¸Š
cd /opt/Tanva

# èŽ·å–æœ€æ–°ä»£ç 
git fetch origin
git checkout main
git pull origin main

# å®‰è£…ä¾èµ–
npm install --production

# å‰ç«¯æž„å»º
npm run build

# åŽç«¯å¯åŠ¨
cd server
npm install --production
pm2 restart tanva-backend

# æ£€æŸ¥çŠ¶æ€
pm2 status
```

#### æ–¹æ¡ˆB: è‡ªåŠ¨åŒ–éƒ¨ç½² (æŽ¨è) - GitHub Actions

åˆ›å»º `.github/workflows/deploy-prod.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install
        cd server && npm install && cd ..

    - name: Build frontend
      run: npm run build

    - name: Deploy to Aliyun
      env:
        ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
        ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
        ALIYUN_KEY: ${{ secrets.ALIYUN_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$ALIYUN_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $ALIYUN_USER@$ALIYUN_HOST << 'EOF'
          cd /opt/Tanva
          git fetch origin
          git checkout main
          git pull origin main
          npm install --production
          cd server
          npm install --production
          pm2 restart tanva-backend
        EOF

    - name: Run smoke tests
      run: npm run test:smoke
```

é…ç½® GitHub Secrets:
```bash
# GitHub Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
ALIYUN_HOST: your.aliyun.ip
ALIYUN_USER: ubuntu
ALIYUN_KEY: (ä½ çš„SSHç§é’¥å†…å®¹)
```

### 5.4 éªŒè¯ç”Ÿäº§çŽ¯å¢ƒ

```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
curl https://tai.tanva.tgtai.com/api/public/ai/providers

# æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥
curl https://tai.tanva.tgtai.com/api/health/db

# è®¿é—®å‰ç«¯
https://tai.tanva.tgtai.com
```

---

## å·¥ä½œæµå®Œæ•´ç¤ºä¾‹

### å‘¨ä¸€: å¼€å§‹æ–°åŠŸèƒ½

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git checkout dev
git pull origin dev

# 2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/image-enhancement

# 3. å¼€å‘å¹¶æäº¤
# ... å¼€å‘ä¸­ ...
git add src/components/ImageEditor.tsx
git commit -m "feat: æ·»åŠ å›¾åƒç¼–è¾‘å™¨å¢žå¼ºåŠŸèƒ½"
```

### å‘¨äºŒ-å‘¨å››: æœ¬åœ°æµ‹è¯•

```bash
# è¿è¡Œå¼€å‘æœåŠ¡å™¨
npm run dev

# åœ¨ http://localhost:5173 æµ‹è¯•
# åœ¨ http://192.168.2.115:5173 å›¢é˜Ÿæµ‹è¯•
```

### å‘¨äº”: ä»£ç å®¡æŸ¥

```bash
# æŽ¨é€åˆ°è¿œç¨‹
git push origin feature/image-enhancement

# GitHub åˆ›å»º PR
# - Title: feat: æ·»åŠ å›¾åƒç¼–è¾‘å™¨å¢žå¼ºåŠŸèƒ½
# - Description: è¯¦ç»†æè¿°æ”¹è¿›å†…å®¹
# - Reviewers: æŒ‡å®šå®¡æŸ¥äººå‘˜
```

### å‘¨äº”ä¸‹åˆ: åˆå¹¶åˆ° dev

```bash
# PR é€šè¿‡å®¡æŸ¥åŽï¼Œç‚¹å‡» "Merge pull request"
# é€‰æ‹© "Squash and merge" ä¿æŒæäº¤åŽ†å²å¹²å‡€
```

### ä¸‹å‘¨ä¸€: å‘å¸ƒåˆ°ç”Ÿäº§

```bash
# 1. åˆ›å»ºå‘å¸ƒåˆ†æ”¯
git checkout dev
git pull origin dev
git checkout -b release/v1.1.0

# 2. æ›´æ–°ç‰ˆæœ¬å’Œæ–‡æ¡£
# ... æ›´æ–°ç‰ˆæœ¬å· ...
git add .
git commit -m "chore: release v1.1.0"

# 3. åˆ›å»º PR: release/v1.1.0 â†’ main

# 4. åˆå¹¶åŽè‡ªåŠ¨éƒ¨ç½² (å¦‚æžœé…ç½®äº†GitHub Actions)

# 5. éªŒè¯ç”Ÿäº§çŽ¯å¢ƒ
https://tai.tanva.tgtai.com
```

---

## æœ€ä½³å®žè·µ

### âœ… å¼€å‘åˆ†æ”¯å‘½åè§„èŒƒ

```
feature/xxx       - æ–°åŠŸèƒ½
bugfix/xxx        - é”™è¯¯ä¿®å¤
hotfix/xxx        - ç´§æ€¥ä¿®å¤ (ä»Žmainåˆ†å‡º)
refactor/xxx      - é‡æž„
docs/xxx          - æ–‡æ¡£æ›´æ–°
perf/xxx          - æ€§èƒ½ä¼˜åŒ–
```

### âœ… æäº¤ä¿¡æ¯è§„èŒƒ

```
feat: æ–°å¢žåŠŸèƒ½è¯´æ˜Ž
fix: ä¿®å¤é”™è¯¯è¯´æ˜Ž
docs: æ–‡æ¡£æ›´æ–°è¯´æ˜Ž
style: ä»£ç é£Žæ ¼è°ƒæ•´
refactor: é‡æž„è¯´æ˜Ž
perf: æ€§èƒ½ä¼˜åŒ–è¯´æ˜Ž
test: æµ‹è¯•æ·»åŠ è¯´æ˜Ž
chore: æž„å»ºæˆ–ä¾èµ–æ›´æ–°
```

### âœ… å‘å¸ƒæ¸…å•

```
éƒ¨ç½²å‰æ£€æŸ¥:
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ²¡æœ‰æŽ§åˆ¶å°é”™è¯¯
- [ ] æ€§èƒ½æŒ‡æ ‡è‰¯å¥½
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] ç‰ˆæœ¬å·å·²æ›´æ–°
- [ ] å¤‡ä»½å·²åˆ›å»º
- [ ] å›žæ»šè®¡åˆ’å·²åˆ¶å®š

éƒ¨ç½²åŽæ£€æŸ¥:
- [ ] åº”ç”¨å¯æ­£å¸¸è®¿é—®
- [ ] æ•°æ®åº“è¿žæŽ¥æ­£å¸¸
- [ ] æ—¥å¿—æ— å¼‚å¸¸
- [ ] ç”¨æˆ·åé¦ˆæ­£å¸¸
```

---

## æ•…éšœæ¢å¤

### å¿«é€Ÿå›žæ»š

```bash
# å¦‚æžœç”Ÿäº§çŽ¯å¢ƒå‡ºçŽ°é—®é¢˜
ssh -i /path/to/key.pem ubuntu@ä½ çš„æœåŠ¡å™¨IP

# å›žåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
cd /opt/Tanva
git checkout HEAD~1
npm install --production
cd server && npm install --production
pm2 restart tanva-backend

# æˆ–ä½¿ç”¨å¤‡ä»½
git tag v1.0.1-backup  # åˆ›å»ºå¤‡ä»½
git checkout v1.0.0     # å›žåˆ°ä¸Šä¸€ç‰ˆæœ¬
```

### ç›‘æŽ§ç”Ÿäº§çŽ¯å¢ƒ

```bash
# SSH è¿žæŽ¥åŽ
pm2 logs tanva-backend        # æŸ¥çœ‹æ—¥å¿—
pm2 status                     # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
top -p $(pgrep -d ',' node)   # æŸ¥çœ‹èµ„æºä½¿ç”¨
```

---

## å¼€å‘ vs ç”Ÿäº§å¯¹æ¯”

| é¡¹ç›® | å¼€å‘çŽ¯å¢ƒ | ç”Ÿäº§çŽ¯å¢ƒ |
|------|---------|---------|
| æ•°æ®åº“ | æœ¬åœ° PostgreSQL | Aliyun RDS |
| å‰ç«¯åœ°å€ | http://localhost:5173 | https://tai.tanva.tgtai.com |
| åŽç«¯åœ°å€ | http://localhost:4000 | https://tai.tanva.tgtai.com/api |
| æ—¥å¿—çº§åˆ« | debug | info |
| CORS | localhost + æœ¬åœ°IP | ä»…ç”Ÿäº§åŸŸå |
| ç¼“å­˜ | ç¦ç”¨ | å¯ç”¨ |
| é”™è¯¯å¤„ç† | è¯¦ç»† | å®‰å…¨ |
| ç›‘æŽ§ | åŸºç¡€ | å®Œæ•´ |
| å¤‡ä»½ | æ—  | æ¯å¤© |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç¬¬ä¸€å‘¨ (æœ¬å‘¨)
1. âœ… åˆ›å»º dev åˆ†æ”¯
2. âœ… é…ç½®çŽ¯å¢ƒæ–‡ä»¶ (.env.development, .env.production)
3. âœ… è®¾ç½® .gitignore
4. âœ… æœ¬åœ°éªŒè¯å·¥ä½œæµ

### ç¬¬äºŒå‘¨
1. âœ… éƒ¨ç½²ç¬¬ä¸€ç‰ˆæœ¬åˆ° Aliyun
2. âœ… é…ç½® GitHub Actions (å¯é€‰)
3. âœ… è®¾ç½®ç›‘æŽ§å’Œå‘Šè­¦
4. âœ… åˆ›å»ºå›žæ»šè®¡åˆ’

### ç¬¬ä¸‰å‘¨åŠä»¥åŽ
1. âœ… æŒç»­å¼€å‘æ–°åŠŸèƒ½
2. âœ… å®šæœŸå‘å¸ƒåˆ°ç”Ÿäº§
3. âœ… ç›‘æŽ§ç”¨æˆ·åé¦ˆ
4. âœ… ä¼˜åŒ–éƒ¨ç½²æµç¨‹
