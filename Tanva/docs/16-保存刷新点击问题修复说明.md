# 保存刷新后图片无法点击问题修复说明

## 背景
在画布保存后刷新页面时，已存在的图片无法通过鼠标点击选中或拖拽，严重影响项目继续编辑的体验。该问题在 AI 生成图片、新建上传图片、历史项目导入等多种场景下都会出现。

## 受影响范围
- AI 图片新建显示逻辑：`src/hooks/useAIImageDisplay.ts`
- 画布项目重建逻辑：`src/components/canvas/DrawingController.tsx`
- 画布图片辅助元素工具（新增）：`src/utils/paperImageGroup.ts`

## 根因分析
1. **Raster 尚未完成加载**  
   Paper.js 在反序列化项目时会先创建 `Raster` 对象，但此时图像像素还没加载完，`raster.bounds` 返回 `0 × 0`。原有重建流程会立刻使用这个零尺寸去生成透明点击区域和 React 侧的 `imageInstances`。
2. **点击检测依赖有效的透明矩形**  
   选择工具的点击检测需要透明矩形 (`image-selection-area`) 提供命中区域。一旦初始 bounds 为 `0 × 0`，透明矩形退化成一个点，命中检测始终失败，导致后续点击无效。
3. **重复逻辑导致状态不一致**  
   新建与重建分别维护了一套不同的辅助元素创建逻辑，一旦其中某个流程忘记同步更新（例如 metadata、控制点顺序），就会出现行为不一致的问题。

## 解决方案
1. **抽出辅助结构工具**  
   新增 `ensureImageGroupStructure`，统一负责设置：
   - `raster.data` 元信息（`imageId`、原始尺寸、上传方式等）
   - 透明点击区域与选择高亮框
   - 四角缩放控制点  
   新建与重建流程均调用该工具，避免重复实现。

2. **区分加载阶段**  
   - 在重建时先检查 `raster.bounds` 是否有效，若尚未加载完则只登记一个占位实例，同时挂接 `raster.onLoad`。  
   - 图像加载完成后回调中重新计算真实 bounds，并再次调用共享工具补齐辅助元素，随后更新 React 状态。

3. **合并历史状态**  
   重建结束后对 `imageInstances` 做一次合并：优先使用已有实例中已知的真实尺寸，确保 UI 层不会因为重建覆盖而退化为 0 尺寸。

## 成果
- 保存 → 刷新后，所有图片都能正常点击、选中、拖动和调整大小。
- 新建与重建的辅助元素结构保持一致，后续维护更易于扩展。
- 解决了随机丢失 `raster.onLoad` 回调导致的数据遗漏问题。

## 验证建议
1. 新建图片（AI 或上传），保存项目 → 刷新 → 点击并拖动该图片，确认交互正常。
2. 对旧项目执行同样的流程，确保历史数据恢复后辅助元素齐全。
3. 如果存在自动化回归测试，建议同步执行（例如 E2E 场景覆盖）。

## 后续注意事项
- 其他依赖辅助元素的功能若有新增，也应优先调用 `ensureImageGroupStructure`。
- 若需要扩展 metadata（如新增标签、缩放锁定等），可在工具函数中统一处理，避免散落式修改。

