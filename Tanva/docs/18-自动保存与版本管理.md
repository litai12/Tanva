# 自动保存与版本管理

本篇说明前端自动保存管线、版本策略与相关调试工具。

## 架构与职责

- 入口组件：`src/components/autosave/ProjectAutosaveManager.tsx`
  - 切换项目时：清理跨项目缓存、加载后端内容、恢复 Paper.js、同步层与画布状态
  - 订阅层与画布变更：合并到 `projectContentStore` 中并标记 `dirty`
  - `beforeunload`：若存在未保存变更，阻止关闭并提示
  - 挂载自动保存 Hook：`useProjectAutosave(projectId)`

- 序列化/反序列化：`src/services/paperSaveService.ts`
  - `serializePaperProject()`：将当前 Paper.js 项目转为 `paperJson`
  - `deserializePaperProject(json)`：从内容恢复画布对象
  - `clearProject()` 与 `cancelPending()`：切换项目/卸载时清理

- 自动保存钩子：`src/hooks/useProjectAutosave.ts`
  - 监听 `projectContentStore` 的 `dirty` 与节流/去抖策略
  - 调用 `projectApi.saveContent()` 持久化，服务端递增 `version`

- 状态与调试 UI：
  - `AutosaveStatus`：显示状态（已保存/保存中/有变更/错误）
  - `ManualSaveButton`：手动触发保存
  - `SaveDebugPanel`：显示最近操作日志，基于 `src/utils/saveMonitor.ts`

## 典型流程

1) 进入 `/app?projectId=...` → `ProjectAutosaveManager` 根据 `projectId` 拉取内容并 hydrate
2) Paper.js 准备完成后反序列化 `paperJson` 恢复视觉内容
3) 对层、画布或 AI 会话的变更写入 `projectContentStore` 并标记 `dirty`
4) 定时或条件触发的自动保存合并 `paperJson` → `PUT /api/projects/:id/content`
5) 服务端返回新的 `version` 与 `updatedAt`，前端清除 `dirty` 并更新状态

## 注意事项

- 切换项目会清空跨项目缓存（如 AI 上下文图片缓存），避免“继承隐藏状态”。
- 图片历史默认保留跨文件，便于查看；如需隔离可在切换时清空历史。
- 若加载失败且后端提示“项目不存在”，前端会清理无效 `projectId` 并弹出项目管理器以便重新选择。

