# Sealos 部署前检查清单

## 📋 预部署检查

### 1. 环境准备
- [ ] 已注册 Sealos 账户（https://cloud.sealos.io）
- [ ] 账户已实名认证
- [ ] 账户余额 ≥ ¥50（用于测试）
- [ ] Git 仓库已创建（GitHub/GitLab）
- [ ] 项目代码已提交到主分支

### 2. 代码质量检查
- [ ] 前端构建成功：`npm run build`（在根目录）
- [ ] 后端构建成功：`cd server && npm run build`
- [ ] TypeScript 编译无错误：`npx tsc -b`
- [ ] ESLint 检查通过：`npx eslint .`
- [ ] 没有未提交的关键文件（`.env` 等）
- [ ] `.gitignore` 已正确配置，敏感文件已排除

### 3. Docker 镜像测试
- [ ] Docker Desktop 已启动
- [ ] 前端 Dockerfile 构建成功：
  ```bash
  docker build -f Dockerfile.frontend -t tanva-frontend:test .
  ```
- [ ] 后端 Dockerfile 构建成功：
  ```bash
  docker build -f server/Dockerfile -t tanva-backend:test .
  ```
- [ ] docker-compose 可正常启动：
  ```bash
  docker-compose up -d
  docker-compose logs -f  # 检查无错误
  docker-compose down
  ```

### 4. 文件准备确认
- [ ] `Dockerfile.frontend` 已创建
- [ ] `server/Dockerfile` 已创建
- [ ] `nginx.conf` 已创建
- [ ] `docker-compose.yml` 已创建
- [ ] `.dockerignore` 已创建

### 5. 密钥和敏感信息
- [ ] `.env` 文件已从 Git 中移除
- [ ] `.env.example` 包含示例值（不含真实密钥）
- [ ] 已准备强随机密钥（用于 JWT、Cookie 等）
- [ ] OSS 密钥信息已准备（如使用 OSS）
- [ ] Google API 密钥已准备（如使用视频生成功能）

### 6. 数据库准备
- [ ] PostgreSQL 版本 ≥ 15
- [ ] Prisma schema 正确无误
- [ ] 迁移文件已创建：
  ```bash
  cd server && npx prisma migrate dev --name init
  ```
- [ ] Prisma client 可正常生成：
  ```bash
  cd server && npx prisma generate
  ```

### 7. 网络和 API 配置
- [ ] 后端服务正确监听 `0.0.0.0:4000`
- [ ] 前端反向代理配置正确（nginx.conf）
- [ ] CORS 设置已准备（后端）
- [ ] 健康检查端点已实现：
  - `GET /api/health`
  - `GET /api/health/db`（可选）

### 8. 域名准备
- [ ] 已计划使用 Sealos 自动分配的 `.sealos.app` 域名 或
- [ ] 已准备自定义域名并计划 DNS 配置

### 9. 监控和日志
- [ ] 应用日志格式清晰，方便调试
- [ ] 后端配置 JSON 日志格式（可选但推荐）
- [ ] 前端控制台错误不会堆积

### 10. 性能和资源
- [ ] 前端构建产物大小合理（< 10MB）
- [ ] 后端依赖已优化（移除不必要的包）
- [ ] 数据库查询已有基本优化
- [ ] 大文件上传配置正确（Nginx `client_max_body_size`）

---

## 🚀 部署步骤检查

### Sealos 部署流程

#### 步骤 1：部署 PostgreSQL
- [ ] 登录 Sealos 控制台
- [ ] 进入应用商店
- [ ] 搜索并安装 PostgreSQL
- [ ] 配置：
  - [ ] 应用名称：`tanva-db`
  - [ ] 密码：已生成并保存
  - [ ] 存储：50GB
- [ ] 等待状态为 Running

#### 步骤 2：部署后端
- [ ] 应用 → 创建应用 → 从 Git 仓库
- [ ] 配置基本信息：
  - [ ] 名称：`tanva-backend`
  - [ ] Git 仓库：正确的 URL
  - [ ] 分支：main
  - [ ] Dockerfile 路径：`server/Dockerfile`
  - [ ] 容器端口：4000
  - [ ] 副本数：2
- [ ] 配置环境变量：
  - [ ] `DATABASE_URL`：正确指向 PostgreSQL
  - [ ] `JWT_ACCESS_SECRET`：强随机值
  - [ ] `JWT_REFRESH_SECRET`：强随机值
  - [ ] `COOKIE_SECRET`：强随机值
  - [ ] `COOKIE_SECURE`：true（生产）
  - [ ] `COOKIE_DOMAIN`：正确的域名
  - [ ] `CORS_ORIGIN`：前端域名
  - [ ] 所有 OSS 配置（如使用）
- [ ] 部署并等待运行

#### 步骤 3：部署前端
- [ ] 应用 → 创建应用 → 从 Git 仓库
- [ ] 配置基本信息：
  - [ ] 名称：`tanva-frontend`
  - [ ] Git 仓库：正确的 URL
  - [ ] 分支：main
  - [ ] Dockerfile 路径：`Dockerfile.frontend`
  - [ ] 容器端口：80
  - [ ] 副本数：2
- [ ] 配置环境变量（Build time）：
  - [ ] `VITE_ENV`：production
  - [ ] `VITE_GOOGLE_GEMINI_API_KEY`：有效的 API 密钥（或占位符）
  - [ ] 其他 VITE_* 变量正确
- [ ] 部署并等待运行

#### 步骤 4：初始化数据库
- [ ] 进入后端容器或使用本地环境
- [ ] 运行迁移：
  ```bash
  npx prisma migrate deploy
  ```
- [ ] 验证数据库表已创建
- [ ] 检查 Prisma schema 和实际表结构一致

---

## ✅ 部署后验证

### 功能测试

#### 健康检查
- [ ] 后端健康检查通过：
  ```bash
  curl https://[backend-url]/api/health
  ```
- [ ] 数据库连接检查：
  ```bash
  curl https://[backend-url]/api/health/db
  ```

#### 前端
- [ ] 前端可在浏览器打开：`https://[frontend-url]`
- [ ] 页面加载无 404 或 5xx 错误
- [ ] 开发者工具中没有 CORS 错误
- [ ] 前端与后端通信正常

#### 用户认证（如启用）
- [ ] 用户注册流程正常
- [ ] 用户登录流程正常
- [ ] JWT token 正确生成和验证
- [ ] Cookie 正确设置和发送

#### 数据操作
- [ ] 创建项目成功
- [ ] 获取项目列表成功
- [ ] 更新项目成功
- [ ] 删除项目成功

#### API 文档（如启用 Swagger）
- [ ] Swagger UI 可访问：`https://[backend-url]/api/docs`
- [ ] API 文档完整且准确

### 性能和监控
- [ ] 应用响应时间 < 1s
- [ ] 数据库查询时间合理
- [ ] 没有明显的内存泄漏
- [ ] 容器 CPU 使用率 < 50%
- [ ] 容器内存使用率 < 70%

### 日志检查
- [ ] 后端日志无错误堆积
- [ ] 数据库连接日志正常
- [ ] 前端资源加载成功
- [ ] 没有 500 级错误

---

## 🔒 安全检查

- [ ] HTTPS 已启用（Sealos 自动签发 SSL）
- [ ] HTTP 自动跳转 HTTPS
- [ ] Cookie 的 Secure 标志已设置（生产环境）
- [ ] CORS 仅允许特定来源
- [ ] 敏感信息（密钥、密码）不在代码中
- [ ] 数据库密码强度足够（> 12 字符）
- [ ] JWT 密钥长度足够（> 32 字符）
- [ ] 没有公开暴露的调试端点

---

## 📊 资源和成本

- [ ] 数据库 Pod 资源合理（256Mi - 512Mi）
- [ ] 后端 Pod 资源合理（256Mi - 512Mi）
- [ ] 前端 Pod 资源合理（128Mi - 256Mi）
- [ ] 副本数设置合理（2 以上用于高可用）
- [ ] 自动扩展规则已配置（可选）
- [ ] 月成本估算在预算范围内

---

## 🔄 备份和恢复

- [ ] 数据库备份已启用（Sealos 自动备份）
- [ ] 备份频率合理（至少每日一次）
- [ ] 备份保留期足够（7-30 天）
- [ ] 测试过恢复流程（可选但推荐）

---

## 📝 文档和知识库

- [ ] 部署文档已完成：`SEALOS_DEPLOYMENT_GUIDE.md`
- [ ] 快速开始指南已完成：`SEALOS_QUICK_START.md`
- [ ] Docker 本地测试指南已完成：`DOCKER_LOCAL_TEST.md`
- [ ] 故障排查文档已准备
- [ ] 环境变量文档已准备：`.env.example`
- [ ] API 文档已准备（Swagger 或类似）

---

## 🎯 上线前最后检查

- [ ] 所有测试通过
- [ ] 代码审查完成
- [ ] 没有已知的 bug
- [ ] 性能测试通过
- [ ] 安全审查通过
- [ ] 团队成员已通知
- [ ] 监控告警已配置
- [ ] 应急预案已准备

---

## 📞 联系方式

遇到问题？

1. **查看官方文档**：https://docs.sealos.io/
2. **搜索已知问题**：Sealos 社区论坛
3. **提交支持工单**：support@sealos.io
4. **GitHub Issues**：你的项目 Issues

---

## 总结

完成以上所有检查项后，你的应用就可以安心部署到 Sealos 了！

**部署时间**：30-60 分钟
**预计成本**：¥75-125/月
**可用性**：99.9% SLA（Sealos 提供）

祝部署顺利！🎉
