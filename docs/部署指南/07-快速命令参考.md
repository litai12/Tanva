# Sealos 部署快速命令参考

## 🚀 本地测试命令

```bash
# 启动完整本地环境（包括 PostgreSQL、后端、前端）
docker-compose up -d

# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs backend
docker-compose logs frontend
docker-compose logs postgres

# 进入后端容器运行迁移
docker-compose exec backend npx prisma migrate deploy

# 进入数据库容器
docker-compose exec postgres psql -U postgres -d tanva

# 停止所有服务
docker-compose down

# 停止并删除所有数据（谨慎！）
docker-compose down -v

# 重启某个服务
docker-compose restart backend
```

## 🐳 Docker 镜像构建和测试

```bash
# 构建前端镜像
docker build -f Dockerfile.frontend -t tanva-frontend:latest .

# 构建后端镜像
docker build -f server/Dockerfile -t tanva-backend:latest .

# 构建指定的镜像版本
docker build -f Dockerfile.frontend -t tanva-frontend:v1.0.0 .

# 查看构建的镜像
docker images | grep tanva

# 运行前端容器（本地测试）
docker run -d -p 80:80 --name tanva-frontend tanva-frontend:latest

# 运行后端容器（本地测试）
docker run -d -p 4000:4000 \
  -e DATABASE_URL="postgresql://postgres:pass@localhost:5432/tanva?schema=public" \
  -e JWT_ACCESS_SECRET="dev-secret" \
  --name tanva-backend tanva-backend:latest

# 查看容器状态
docker ps

# 查看容器日志
docker logs tanva-backend
docker logs tanva-frontend

# 进入容器内部
docker exec -it tanva-backend /bin/sh
docker exec -it tanva-frontend /bin/sh

# 停止容器
docker stop tanva-frontend tanva-backend

# 删除容器
docker rm tanva-frontend tanva-backend

# 删除镜像
docker rmi tanva-frontend tanva-backend
```

## 🔑 密钥生成命令

```bash
# 生成 32 字符十六进制随机字符串（用于 JWT 和 Cookie）
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 生成多个密钥（bash）
for i in {1..3}; do
  echo "密钥 $i:"
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
done

# 生成 UUID 格式的密钥
node -e "console.log(require('crypto').randomUUID())"
```

## 📊 数据库操作

```bash
# 连接到本地数据库
psql postgresql://postgres:tanva123456@localhost:5432/tanva

# 初始化 Prisma（创建表）
cd server && npx prisma migrate deploy

# 生成 Prisma Client
cd server && npx prisma generate

# 查看数据库状态
cd server && npx prisma studio

# 重置数据库（删除所有数据）
cd server && npx prisma migrate reset

# 创建新迁移（开发时）
cd server && npx prisma migrate dev --name migration_name

# 查看所有迁移
cd server && npx prisma migrate status

# 运行特定迁移版本
cd server && npx prisma migrate resolve --rolled-back migration_name
```

## 🔍 网络和端口检查

```bash
# 检查端口是否被占用（macOS/Linux）
lsof -i :4000
lsof -i :5432
lsof -i :80

# 检查端口是否被占用（Windows）
netstat -ano | findstr :4000
netstat -ano | findstr :5432
netstat -ano | findstr :80

# 测试服务是否可访问
curl http://localhost:4000/api/health
curl http://localhost:5432 2>&1 | head -1  # 应该超时或拒绝

# 查看容器 IP 地址
docker inspect tanva-backend | grep IPAddress

# 测试容器之间的网络
docker exec tanva-backend curl http://postgres:5432
```

## 📦 文件操作

```bash
# 查看 Docker 镜像大小
docker images --format "table {{.Repository}}\t{{.Size}}"

# 查看 Docker 系统资源使用
docker system df

# 清理未使用的 Docker 资源
docker system prune

# 清理包括卷的所有未使用资源
docker system prune -a --volumes

# 查看容器内文件
docker exec tanva-backend ls -la /app

# 从容器复制文件到本地
docker cp tanva-backend:/app/dist ./dist-backup

# 从本地复制文件到容器
docker cp ./file.txt tanva-backend:/app/
```

## 🔐 Sealos 命令（如使用 CLI）

```bash
# 登录 Sealos
sealos login --username your-username --password your-password

# 获取所有应用
sealos get apps

# 查看特定应用
sealos describe app tanva-backend

# 查看应用日志
sealos logs tanva-backend

# 进入应用容器
sealos exec tanva-backend -- /bin/sh

# 获取应用信息
sealos get services

# 查看 Pod 状态
sealos get pods -n tanva

# 查看存储状态
sealos get pvc -n tanva

# 重启应用
sealos restart tanva-backend
```

## 🚀 GitHub 推送和 CI/CD

```bash
# 初始化 Git（首次）
git init
git add .
git commit -m "Initial commit for Sealos deployment"
git remote add origin https://github.com/your-username/your-repo.git
git branch -M main
git push -u origin main

# 后续推送
git add .
git commit -m "Update deployment configuration"
git push origin main

# 查看 Git 状态
git status

# 查看提交历史
git log --oneline

# 查看 GitHub Actions 状态
# 在 GitHub 仓库 → Actions 标签中查看
```

## 📈 性能测试和监控

```bash
# 测试后端响应时间
time curl http://localhost:4000/api/health

# 并发测试（需要 Apache Bench）
ab -n 100 -c 10 http://localhost:4000/api/health

# 压力测试（需要 wrk）
wrk -t12 -c400 -d30s http://localhost:4000/api/health

# 查看 Node.js 进程内存使用
docker stats tanva-backend

# 查看容器资源使用情况
docker container stats
```

## 🔧 故障排查命令

```bash
# 查看容器详细信息
docker inspect tanva-backend

# 查看容器网络配置
docker network inspect tanva-network

# 验证 Docker Compose 配置文件
docker-compose config

# 测试数据库连接
docker exec tanva-backend curl postgres:5432

# 查看容器进程
docker exec tanva-backend ps aux

# 检查 DNS 解析（容器内）
docker exec tanva-backend cat /etc/resolv.conf

# 测试 API 连接（详细输出）
curl -v http://localhost:4000/api/health

# 显示 HTTP 响应头
curl -i http://localhost:4000/api/health

# POST 请求测试
curl -X POST http://localhost:4000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"Test@123"}'
```

## 🧹 清理和维护

```bash
# 删除所有已停止的容器
docker container prune

# 删除所有未使用的镜像
docker image prune

# 删除所有未使用的网络
docker network prune

# 删除所有未使用的卷
docker volume prune

# 完整系统清理
docker system prune -a --volumes

# 查看 Docker 磁盘使用
du -sh ~/.docker/

# 清理日志（谨慎）
docker logs --tail 1000 tanva-backend > backup.log
docker logs -f --tail 0 tanva-backend  # 只显示新日志
```

## 📝 环境变量验证

```bash
# 检查后端环境变量
docker exec tanva-backend printenv | grep -E "DATABASE_URL|JWT|COOKIE"

# 检查前端构建参数
docker inspect tanva-frontend | grep VITE

# 列出所有环境变量
docker exec tanva-backend printenv | sort
```

## 🐛 常见问题快速修复

```bash
# 问题：容器无法访问 PostgreSQL
# 解决：确保数据库容器运行中
docker ps | grep postgres

# 问题：端口被占用
# 解决：使用不同的端口
docker run -d -p 8000:4000 tanva-backend:latest

# 问题：内存不足
# 解决：查看和限制容器内存
docker stats
docker update --memory=512m tanva-backend

# 问题：镜像构建失败
# 解决：清理并重新构建
docker builder prune
docker build --no-cache -f Dockerfile.frontend -t tanva-frontend:latest .

# 问题：数据库连接超时
# 解决：检查网络连接
docker exec tanva-backend nc -zv postgres 5432
```

## 📚 快速帮助

```bash
# Docker 命令帮助
docker --help
docker run --help
docker-compose --help

# 获取镜像信息
docker inspect tanva-backend:latest | jq '.[0].Config.Env'

# 查看历史命令
history | grep docker
```

---

## 💡 技巧和最佳实践

```bash
# 使用别名简化命令
alias dc='docker-compose'
dc up -d
dc logs -f

# 一次性构建和启动
docker-compose build --no-cache && docker-compose up -d

# 查看全部日志（包括已退出的容器）
docker logs --all tanva-backend

# 使用标准输出而不是日志文件
docker run -it tanva-backend:latest

# 后台启动并保存日志
docker-compose up -d && docker-compose logs -f > deployment.log &

# 定时备份数据库
# 每天自动备份到 backup.sql
docker exec tanva-postgres pg_dump -U postgres tanva > backup-$(date +%Y%m%d).sql
```

---

## 📋 检查清单快速命令

```bash
# 一键检查所有服务状态
docker-compose ps

# 一键检查所有网络连接
docker exec tanva-backend curl -s http://postgres:5432 && echo "DB OK" || echo "DB FAILED"
docker exec tanva-backend curl -s http://localhost:4000/api/health && echo "API OK" || echo "API FAILED"

# 一键测试数据库迁移
docker-compose exec backend npx prisma migrate status

# 一键查看磁盘使用
docker system df
du -sh .
```

---

**提示**：大多数命令都可以别名化以提高效率。例如：
```bash
echo "alias dcup='docker-compose up -d'" >> ~/.bashrc
echo "alias dclogs='docker-compose logs -f'" >> ~/.bashrc
source ~/.bashrc
```

祝你使用愉快！
