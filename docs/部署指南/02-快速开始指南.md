# Sealos 部署 - 快速开始指南

## 🚀 5分钟快速开始

### 前置条件
- Sealos 账户已注册：https://cloud.sealos.io
- 代码已推送到 GitHub/GitLab
- 已安装 Docker（用于本地测试）

---

## 第一步：部署 PostgreSQL 数据库（3分钟）

1. 登录 Sealos 控制台
2. **应用** → **应用商店** → 搜索 **PostgreSQL**
3. 点击 **PostgreSQL**，进入配置页面：

   | 字段 | 值 |
   |------|-----|
   | 应用名称 | `tanva-db` |
   | 初始用户名 | `postgres` |
   | 初始密码 | **点击生成** (保存这个密码！) |
   | 数据库存储 | `50` GB |
   | CPU | `100m` - `500m` |
   | 内存 | `256Mi` - `512Mi` |

4. 点击 **部署** → 等待状态为 **Running**

**保存这些信息**：
```
数据库主机: tanva-db
端口: 5432
用户: postgres
密码: [你的生成密码]
数据库: tanva
```

---

## 第二步：部署后端应用（5分钟）

1. **应用** → **创建应用** → **从 Git 仓库创建**

2. **基本配置**：
   ```
   应用名称: tanva-backend
   Git 仓库: https://github.com/你的账户/你的项目.git
   分支: main
   Dockerfile 路径: server/Dockerfile
   容器端口: 4000
   副本数: 2
   ```

3. **点击「下一步」或「高级配置」** → 添加环境变量：

   **复制粘贴这段内容到"环境变量"输入框**（替换 `[...]` 部分）：
   ```
   PORT=4000
   HOST=0.0.0.0
   DATABASE_URL=postgresql://postgres:[你的密码]@tanva-db:5432/tanva?schema=public
   JWT_ACCESS_SECRET=[生成任意32字符以上字符串，如：aB3cD4eF5gH6iJ7kL8mN9oP0qRsTuVwX]
   JWT_REFRESH_SECRET=[生成任意32字符以上字符串，如：yZ1aB2cD3eF4gH5iJ6kL7mN8oP9qRsTu]
   JWT_ACCESS_TTL=900s
   JWT_REFRESH_TTL=30d
   COOKIE_SECRET=[生成任意32字符以上字符串，如：vWxYzA1bC2dE3fG4hI5jK6lM7nO8pQrS]
   COOKIE_SECURE=true
   COOKIE_SAMESITE=lax
   COOKIE_DOMAIN=.sealos.app
   CORS_ORIGIN=https://tanva-backend-xxx.app
   OSS_REGION=oss-cn-hangzhou
   OSS_BUCKET=[你的bucket名]
   OSS_ACCESS_KEY_ID=[你的key id]
   OSS_ACCESS_KEY_SECRET=[你的key secret]
   ```

   ⚠️ **重要**：
   - `DATABASE_URL` 中将 `[你的密码]` 替换为第一步保存的密码
   - JWT_*_SECRET 和 COOKIE_SECRET 可以使用在线生成器生成：https://www.uuidgenerator.net/

4. **部署**：点击部署按钮

5. **等待**：应用状态变为 **Running**（通常 2-3 分钟）

---

## 第三步：部署前端应用（5分钟）

1. **应用** → **创建应用** → **从 Git 仓库创建**

2. **基本配置**：
   ```
   应用名称: tanva-frontend
   Git 仓库: https://github.com/你的账户/你的项目.git
   分支: main
   Dockerfile 路径: Dockerfile.frontend
   容器端口: 80
   副本数: 2
   ```

3. **环境变量**（构建时）：
   ```
   VITE_ENV=production
   VITE_GOOGLE_GEMINI_API_KEY=[你的 Google API 密钥]
   VITE_VIDEO_DEFAULT_DURATION=8
   VITE_VIDEO_DEFAULT_RESOLUTION=720p
   VITE_VIDEO_POLL_INTERVAL=2000
   VITE_VIDEO_TIMEOUT=300000
   ```

4. **部署** → 等待 **Running**

---

## 第四步：获取访问链接

应用部署完成后，每个应用都会有一个公网地址：

1. 点击 **tanva-backend** 应用卡片
2. 在"网络访问"部分找到外网地址，如：`http://tanva-backend-xxx.sealos.app`
3. 点击 **tanva-frontend** 应用卡片
4. 获取前端的外网地址

---

## 第五步：初始化数据库

打开终端，运行数据库迁移命令。有两种方法：

### 方法A：从本地运行（推荐）

```bash
# 进入项目目录
cd /Users/litai/Documents/Development/dev/Tanva

# 安装后端依赖（如未安装）
cd server && npm install

# 运行迁移
DATABASE_URL="postgresql://postgres:[你的密码]@[tanva-db外网地址或IP]:5432/tanva?schema=public" npx prisma migrate deploy

# 如果出现连接问题，可以尝试生成 Prisma client
DATABASE_URL="postgresql://postgres:[你的密码]@[地址]:5432/tanva?schema=public" npx prisma generate
```

### 方法B：通过 Sealos 终端运行

1. 在 Sealos 控制台点击 **tanva-backend** 应用
2. 找到 Pod 列表，点击某个 Pod 的终端图标
3. 运行：
   ```bash
   npx prisma migrate deploy
   ```

---

## 验证部署

### 测试后端健康状态
```bash
curl https://tanva-backend-xxx.sealos.app/api/health
# 返回：{"status":"ok"} 或类似信息
```

### 测试前端
在浏览器打开：`https://tanva-frontend-xxx.sealos.app`

### 测试注册（可选）
```bash
curl -X POST https://tanva-backend-xxx.sealos.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"Test@123","name":"TestUser"}'
```

---

## 常见问题速查

| 问题 | 解决方案 |
|------|--------|
| 后端容器无法启动 | 检查日志：应用详情 → 日志 → 查看错误信息 |
| 数据库连接失败 | 确保 `DATABASE_URL` 正确，数据库容器运行中 |
| 前端显示 API 错误 | 检查 `CORS_ORIGIN` 是否匹配前端域名 |
| 数据库迁移失败 | 确保 Prisma schema 正确，运行 `npx prisma generate` |
| 500 错误 | 查看后端日志找出具体错误 |

---

## 下一步

- ✅ 部署已完成
- 📚 详细指南见：`SEALOS_DEPLOYMENT_GUIDE.md`
- 🔒 配置自定义域名（可选）
- 📊 启用监控和备份
- 🔄 设置 CI/CD 自动部署

---

## 生成密钥工具

需要生成强随机密钥？使用这些工具：

- **在线工具**：https://www.uuidgenerator.net/ (生成后去掉 `-`)
- **命令行**：
  ```bash
  # macOS/Linux
  openssl rand -hex 32

  # 或使用 node
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
  ```

---

## 成本提醒

- 启用应用后开始计费
- 预估成本：¥75-125/月
- 可随时停止应用停止计费
- 首次注册通常有免费额度

---

## 需要帮助？

1. 查看 Sealos 官方文档：https://docs.sealos.io/
2. 在控制台点击"帮助"获取在线支持
3. 查看应用日志排查问题

