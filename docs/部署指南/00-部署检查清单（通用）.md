# Tanva ECS 部署快速检查清单

## 📝 部署前检查

### 信息准备清单

```
□ 记录ECS公网IP地址: ___________________
□ 获取SSH密钥对文件 (.pem): ___________________
□ 准备好你的域名: ___________________
□ 获取Google Gemini API Key: ___________________
□ GitHub仓库URL: ___________________
```

### 本地代码准备

```bash
# 在本地机器上运行这些命令
cd ~/Documents/Development/dev/Tanva

# 确保所有代码已提交
git status
# 应该显示: nothing to commit, working tree clean

# 推送代码到远程仓库
git push origin oss

# 查看最后的提交
git log --oneline -5
```

检查清单：
```
□ 代码已提交
□ 代码已推送到远程
□ 分支名称: oss 或 main
```

---

## 🚀 部署执行步骤

### 第1步: SSH连接到ECS (5分钟)

**你需要的信息:**
- ECS公网IP: `47.106.140.227`
- 密钥文件位置: `~/.ssh/your-key-pair.pem`

**执行命令:**
```bash
# 将密钥文件放到正确位置
cp ~/Downloads/your-key-pair.pem ~/.ssh/
chmod 600 ~/.ssh/your-key-pair.pem

# SSH连接到ECS
ssh -i ~/.ssh/your-key-pair.pem ubuntu@47.106.140.227
```

**验证连接成功:**
```
□ 看到命令提示符: ubuntu@i-bp1...~$
□ 运行: lsb_release -a (验证Ubuntu版本)
□ 运行: df -h (验证磁盘空间 >20GB)
```

---

### 第2步: 准备部署脚本 (2分钟)

在本地机器上：

```bash
# 进入Tanva目录
cd ~/Documents/Development/dev/Tanva

# 查看部署脚本已创建
ls -la deploy-to-ecs.sh

# 使用SCP上传脚本到ECS
scp -i ~/.ssh/your-key-pair.pem deploy-to-ecs.sh ubuntu@47.106.140.227:~/
```

验证脚本上传成功：
```
□ 看到文件传输完成消息
```

---

### 第3步: 执行自动化部署脚本 (15-20分钟)

在ECS上运行：

```bash
# 执行部署脚本
bash ~/deploy-to-ecs.sh

# 脚本会显示进度信息:
# [1/10] Updating system packages...
# [2/10] Installing Node.js...
# ... 等等
```

**脚本执行完成后，记录以下信息:**

```
数据库信息:
- Database User: tanva_user
- Database Password: _________________ (保存好！)
- Database Name: tanva

输出的说明:
- PostgreSQL已配置
- Nginx已配置
- PM2已启动
```

验证脚本完成：
```
□ 看到 "Deployment Configuration Complete!" 消息
□ 看到完整的"Next Steps"说明
```

---

### 第4步: 配置环境变量 (3分钟)

#### 4a. 编辑服务端环境文件

在ECS上运行：

```bash
sudo nano /home/ubuntu/tanva/server/.env.production
```

**需要修改的部分:**

找到这一行：
```env
DATABASE_URL="postgresql://tanva_user:YOUR_DB_PASSWORD@localhost:5432/tanva?schema=public"
```

替换 `YOUR_DB_PASSWORD` 为脚本输出的密码。

找到这一行：
```env
GOOGLE_GEMINI_API_KEY=your_gemini_api_key_here
```

替换为你的实际API Key。

找到这两行：
```env
CORS_ORIGIN=https://your-domain.com,https://www.your-domain.com
```

替换 `your-domain.com` 为你的实际域名（如: `tai.tanva.tgtai.com`）

**保存文件:**
- 按 `Ctrl + O` (保存)
- 按 `Enter` (确认文件名)
- 按 `Ctrl + X` (退出)

验证：
```bash
cat /home/ubuntu/tanva/server/.env.production
```

检查清单：
```
□ DATABASE_URL 包含正确的密码
□ GOOGLE_GEMINI_API_KEY 包含你的API Key
□ CORS_ORIGIN 包含你的域名
```

#### 4b. 编辑前端环境文件

```bash
sudo nano /home/ubuntu/tanva/.env.production
```

替换所有的 `your-domain.com` 为你的实际域名（如: `tai.tanva.tgtai.com`）

**保存文件:**
- 按 `Ctrl + O`
- 按 `Enter`
- 按 `Ctrl + X`

验证：
```bash
cat /home/ubuntu/tanva/.env.production
```

检查清单：
```
□ VITE_API_BASE 包含正确的域名
□ VITE_API_URL 包含正确的域名
```

---

### 第5步: 更新Nginx配置 (2分钟)

```bash
sudo nano /etc/nginx/sites-available/tanva
```

替换所有的 `your-domain.com` 为你的实际域名。

例如，找到这行：
```nginx
server_name your-domain.com www.your-domain.com;
```

改为：
```nginx
server_name tai.tanva.tgtai.com www.tai.tanva.tgtai.com;
```

**保存文件:**
- 按 `Ctrl + O`
- 按 `Enter`
- 按 `Ctrl + X`

**测试Nginx配置：**
```bash
sudo nginx -t
# 应该看到: nginx: the configuration file syntax is ok
```

检查清单：
```
□ Nginx配置测试通过
□ server_name 已更新为你的域名
```

---

### 第6步: 配置DNS记录 (等待DNS生效 5-30分钟)

登录你的域名服务商控制台（如阿里云域名服务、Cloudflare等），添加以下A记录：

**如果你的域名是 `tai.tanva.tgtai.com`:**

| 主机记录 | 记录值 (公网IP) | 记录类型 | TTL |
|---------|----------------|---------|-----|
| tai | 47.106.140.227 | A | 600 |

或者 (如果使用www)：

| 主机记录 | 记录值 (公网IP) | 记录类型 | TTL |
|---------|----------------|---------|-----|
| www.tai | 47.106.140.227 | A | 600 |

验证DNS生效：
```bash
# 在本地机器上运行（需要等待DNS生效）
nslookup tai.tanva.tgtai.com
# 应该返回: 47.106.140.227
```

检查清单：
```
□ DNS记录已添加到域名服务商
□ DNS已生效（nslookup返回正确IP）
```

---

### 第7步: 启动服务 (2分钟)

在ECS上运行：

```bash
# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 检查PM2是否已运行
pm2 status
# 应该看到: tanva-server ONLINE

# 如果没有运行，启动它
cd /home/ubuntu/tanva/server
pm2 start /home/ubuntu/tanva/ecosystem.config.js
```

检查清单：
```
□ Nginx已启动: sudo systemctl status nginx (active)
□ PM2已启动: pm2 status (tanva-server ONLINE)
□ PostgreSQL已运行: sudo systemctl status postgresql (active)
```

---

### 第8步: 配置SSL证书 (5分钟)

⚠️ **重要:** DNS必须已生效才能执行此步骤！

在ECS上运行：

```bash
# 安装Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取SSL证书（将 tai.tanva.tgtai.com 替换为你的实际域名）
sudo certbot certonly --nginx -d tai.tanva.tgtai.com -d www.tai.tanva.tgtai.com
```

**按照提示：**
1. 输入你的邮箱地址
2. 同意服务条款 (输入: `y`)
3. 是否分享邮箱 (输入: `n` 或 `y`)

**验证证书创建成功：**
```bash
ls -la /etc/letsencrypt/live/tai.tanva.tgtai.com/
# 应该看到: fullchain.pem 和 privkey.pem
```

**更新Nginx配置中的证书路径：**

```bash
sudo nano /etc/nginx/sites-available/tanva
```

找到：
```nginx
ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
```

改为（使用你的实际域名）：
```nginx
ssl_certificate /etc/letsencrypt/live/tai.tanva.tgtai.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/tai.tanva.tgtai.com/privkey.pem;
```

**保存文件并重启Nginx：**
```bash
# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 启用自动续期
sudo systemctl enable certbot.timer
```

检查清单：
```
□ 证书文件已创建
□ Nginx配置已更新
□ Nginx配置测试通过
□ Nginx已重启
```

---

### 第9步: 验证部署 (5分钟)

#### 在ECS上验证服务

```bash
# 检查所有服务状态
pm2 status
sudo systemctl status nginx
sudo systemctl status postgresql

# 测试本地API
curl http://localhost:4000/health
# 应该返回200状态码
```

#### 在本地机器上验证

```bash
# 测试HTTPS连接（替换为你的域名）
curl -v https://tai.tanva.tgtai.com
# 应该看到: < HTTP/2 200

# 或在浏览器中打开
# https://tai.tanva.tgtai.com
# 应该看到:
# ✅ 绿色锁 🔒
# ✅ Tanva应用加载
# ✅ 无HTTPS警告
```

#### 测试API端点

```bash
# 测试工具选择端点
curl -X POST https://tai.tanva.tgtai.com/api/ai/tool-selection \
  -H "Content-Type: application/json" \
  -d '{"prompt": "生成一个美丽的日落"}'

# 应该返回类似:
# {"selectedTool": "generateImage", "parameters": {"prompt": "..."}}
```

检查清单：
```
□ pm2 status 显示 tanva-server ONLINE
□ Nginx 显示 active (running)
□ 浏览器访问应用显示UI
□ HTTPS锁显示绿色
□ API端点返回200状态码
```

---

## ❌ 遇到问题？

### 快速诊断

```bash
# 1. 检查所有服务
pm2 status
sudo systemctl status nginx
sudo systemctl status postgresql

# 2. 查看日志
pm2 logs tanva-server
sudo tail -f /var/log/nginx/error.log

# 3. 测试连接
curl -v http://localhost:4000/health

# 4. 检查配置
cat /home/ubuntu/tanva/server/.env.production
```

### 常见问题

| 问题 | 检查项 | 解决方案 |
|------|--------|--------|
| 502 Bad Gateway | Nginx → 后端 | 检查PM2是否运行, `pm2 restart tanva-server` |
| 无法连接到数据库 | DATABASE_URL | 检查.env文件中密码是否正确 |
| SSL证书错误 | Let's Encrypt | 检查DNS是否生效, 运行 `nslookup` |
| CORS错误 | CORS_ORIGIN | 更新.env中的CORS_ORIGIN, 重启后端 |
| API超时 | 网络 | 检查安全组是否允许443/80端口 |

查看 **ALIYUN_ECS_DEPLOYMENT_GUIDE.md** 的故障排查部分获取更详细的帮助。

---

## ✅ 部署完成标志

当你看到以下情况，说明部署成功：

```
□ 访问 https://tai.tanva.tgtai.com 显示Tanva应用
□ HTTPS锁绿色显示 🔒
□ 控制台没有错误消息
□ AI聊天功能正常
□ pm2 status 显示 ONLINE
□ 响应时间 <2秒
```

---

## 📚 完整文档

- 详细步骤: **ALIYUN_ECS_DEPLOYMENT_GUIDE.md**
- 部署脚本: **deploy-to-ecs.sh**
- 日常维护: **ALIYUN_ECS_DEPLOYMENT_GUIDE.md** 的日常维护部分

---

## 需要帮助?

如果遇到问题，请：

1. 查看对应的故障排查部分
2. 收集日志: `pm2 logs`, `sudo tail -f /var/log/nginx/error.log`
3. 验证所有配置文件中的值
4. 检查安全组规则
5. 确认DNS已生效

**祝部署顺利！** 🚀
