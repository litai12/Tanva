# Tanva 应用 Sealos 部署指南

## 一、可行性分析

✅ **你的应用完全适合在 Sealos 上部署**

### 应用架构梳理
- **前端**：React + TypeScript + Vite（SPA应用）
- **后端**：NestJS + Fastify + Prisma + PostgreSQL
- **存储**：Aliyun OSS（可选）
- **依赖**：Node.js、PostgreSQL

### 为什么选择 Sealos？

| 优势 | 说明 |
|------|------|
| **开箱即用** | 无需复杂的 Kubernetes 配置，提供 Web UI |
| **完整生态** | 内置数据库、存储、应用部署功能 |
| **成本低** | 按需计费，相比 ECS 更经济 |
| **容器化** | 自动处理容器化，支持自动扩展 |
| **全国节点** | 支持多地域部署 |

---

## 二、前置准备

### 2.1 Sealos 账户注册
1. 访问 https://cloud.sealos.io
2. 使用微信/GitHub/邮箱注册
3. 实名认证（获得初始额度）
4. 充值至少 ¥50（用于测试和开发）

### 2.2 本地工具准备
```bash
# 安装 docker（如未安装）
# macOS
brew install docker

# 启动 docker desktop
```

### 2.3 代码准备
```bash
# 确保代码已提交到 Git（GitHub/GitLab）
git add .
git commit -m "prepare for sealos deployment"
git push origin main
```

---

## 三、部署架构设计

```
┌─────────────────────────────────────┐
│      Sealos Cloud Platform          │
├─────────────────────────────────────┤
│  Frontend Pod                       │
│  - React SPA (Nginx)                │
│  - Port: 80, 443                    │
│  - Auto-scaling: 1-3 replicas       │
├─────────────────────────────────────┤
│  Backend Pod                        │
│  - NestJS App                       │
│  - Port: 4000                       │
│  - Auto-scaling: 1-3 replicas       │
├─────────────────────────────────────┤
│  Database Service                   │
│  - PostgreSQL 15+                   │
│  - Persistent Volume (50GB)         │
│  - Managed backup                   │
├─────────────────────────────────────┤
│  Object Storage (Optional)          │
│  - Sealos OSS 或 Aliyun OSS        │
└─────────────────────────────────────┘
```

---

## 四、准备 Dockerfile

### 4.1 前端 Dockerfile
在项目根目录创建 `Dockerfile.frontend`：

```dockerfile
# Build stage
FROM node:20-alpine as builder

WORKDIR /app

# 复制 package files
COPY package.json package-lock.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建
RUN npm run build

# Production stage
FROM nginx:alpine

# 复制 nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 暴露端口
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 4.2 后端 Dockerfile
在 `server` 目录创建 `Dockerfile`：

```dockerfile
# Build stage
FROM node:20-alpine as builder

WORKDIR /app

# 复制 package files
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建
RUN npm run build

# Production stage
FROM node:20-alpine

WORKDIR /app

# 安装 dumb-init（处理信号转发）
RUN apk add --no-cache dumb-init

# 复制 package files
COPY package*.json ./

# 安装生产依赖
RUN npm ci --omit=dev

# 复制构建产物
COPY --from=builder /app/dist ./dist

# 暴露端口
EXPOSE 4000

# 使用 dumb-init 启动应用
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "dist/main.js"]
```

### 4.3 Nginx 配置
创建 `nginx.conf`：

```nginx
server {
    listen 80;
    server_name _;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css text/javascript application/json;
    gzip_min_length 1024;

    # 静态文件
    location / {
        root /usr/share/nginx/html;
        index index.html;
        # SPA 路由处理
        try_files $uri $uri/ /index.html;

        # 缓存策略
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # 反向代理到后端
    location /api/ {
        proxy_pass http://tanva-backend:4000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

---

## 五、在 Sealos 中部署

### 方法一：使用 Sealos App Store（推荐 - 最简单）

#### 步骤1：部署 PostgreSQL
1. 登录 Sealos 控制台
2. 点击「应用」→「应用商店」
3. 搜索「PostgreSQL」
4. 点击安装
   - **应用名称**：tanva-postgres
   - **用户名**：postgres
   - **密码**：生成强密码，务必保存
   - **存储大小**：50GB（初期可选）
   - **副本数**：1

5. 点击「部署」，等待运行（约2分钟）

#### 步骤2：部署后端
1. 点击「应用」→「创建应用」
2. 选择「从 git repo 创建」
3. 填写：
   - **应用名称**：tanva-backend
   - **Git 仓库**：你的后端 repo URL
   - **分支**：main
   - **Dockerfile 路径**：server/Dockerfile
   - **容器镜像暴露端口**：4000

4. 设置环境变量：
```
PORT=4000
HOST=0.0.0.0
DATABASE_URL=postgresql://postgres:你的密码@tanva-postgres:5432/tanva?schema=public
JWT_ACCESS_SECRET=生成随机字符串
JWT_REFRESH_SECRET=生成随机字符串
JWT_ACCESS_TTL=900s
JWT_REFRESH_TTL=30d
COOKIE_SECRET=生成随机字符串
COOKIE_SECURE=true
COOKIE_SAMESITE=lax
COOKIE_DOMAIN=你的域名.sealos.app
CORS_ORIGIN=https://你的域名.sealos.app
OSS_REGION=oss-cn-hangzhou
OSS_BUCKET=your-oss-bucket
OSS_ACCESS_KEY_ID=your-akid
OSS_ACCESS_KEY_SECRET=your-aksecret
OSS_CDN_HOST=your-cdn-host
OSS_ENDPOINT=your-endpoint
```

5. 点击「部署」

#### 步骤3：部署前端
1. 点击「应用」→「创建应用」
2. 选择「从 git repo 创建」
3. 填充：
   - **应用名称**：tanva-frontend
   - **Git 仓库**：你的前端 repo URL
   - **分支**：main
   - **Dockerfile 路径**：Dockerfile.frontend
   - **容器镜像暴露端口**：80

4. 设置环境变量（build time）：
```
VITE_ENV=production
VITE_GOOGLE_GEMINI_API_KEY=你的API密钥
VITE_VIDEO_DEFAULT_DURATION=8
VITE_VIDEO_DEFAULT_RESOLUTION=720p
VITE_VIDEO_POLL_INTERVAL=2000
VITE_VIDEO_TIMEOUT=300000
```

5. 点击「部署」

### 方法二：使用 Sealos API（高级）

#### 创建部署 YAML
```yaml
# tanva-deployment.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: tanva

---
# PostgreSQL 持久化存储
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: tanva
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi

---
# PostgreSQL 部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tanva-postgres
  namespace: tanva
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tanva-postgres
  template:
    metadata:
      labels:
        app: tanva-postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        - name: POSTGRES_DB
          value: "tanva"
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          exec:
            command: ["pg_isready", "-U", "postgres"]
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc

---
# PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
  name: tanva-postgres
  namespace: tanva
spec:
  selector:
    app: tanva-postgres
  ports:
  - port: 5432
    targetPort: 5432
  type: ClusterIP

---
# 后端部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tanva-backend
  namespace: tanva
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tanva-backend
  template:
    metadata:
      labels:
        app: tanva-backend
    spec:
      containers:
      - name: backend
        image: your-registry/tanva-backend:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 4000
        env:
        - name: PORT
          value: "4000"
        - name: HOST
          value: "0.0.0.0"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: database-url
        - name: JWT_ACCESS_SECRET
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: jwt-access-secret
        - name: JWT_REFRESH_SECRET
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: jwt-refresh-secret
        - name: COOKIE_SECRET
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: cookie-secret
        - name: COOKIE_SECURE
          value: "true"
        - name: COOKIE_SAMESITE
          value: "lax"
        - name: COOKIE_DOMAIN
          value: "your-domain.sealos.app"
        - name: CORS_ORIGIN
          value: "https://your-domain.sealos.app"
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 4000
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /api/health
            port: 4000
          initialDelaySeconds: 5
          periodSeconds: 10

---
# 后端 Service
apiVersion: v1
kind: Service
metadata:
  name: tanva-backend
  namespace: tanva
spec:
  selector:
    app: tanva-backend
  ports:
  - port: 4000
    targetPort: 4000
  type: ClusterIP

---
# 前端部署
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tanva-frontend
  namespace: tanva
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tanva-frontend
  template:
    metadata:
      labels:
        app: tanva-frontend
    spec:
      containers:
      - name: frontend
        image: your-registry/tanva-frontend:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10

---
# 前端 Service
apiVersion: v1
kind: Service
metadata:
  name: tanva-frontend
  namespace: tanva
spec:
  selector:
    app: tanva-frontend
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP

---
# Ingress（暴露到公网）
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tanva-ingress
  namespace: tanva
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - your-domain.sealos.app
    secretName: tanva-tls
  rules:
  - host: your-domain.sealos.app
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: tanva-frontend
            port:
              number: 80
      - path: /api/
        pathType: Prefix
        backend:
          service:
            name: tanva-backend
            port:
              number: 4000
```

---

## 六、详细步骤（Web UI 方式）

### 步骤 1：创建数据库

1. **登录 Sealos**：进入 https://cloud.sealos.io
2. **进入应用**：左侧菜单 → 应用 → 应用商店
3. **搜索数据库**：搜索 "PostgreSQL"
4. **配置参数**：
   - 应用名称：`tanva-db`
   - 初始用户名：`postgres`
   - 初始密码：复制生成的密码（**很重要！**）
   - 数据库存储：50GB（可根据需要调整）

5. **部署**：点击部署按钮，等待 2-3 分钟

6. **验证**：应用状态为 Running

**保存数据库信息**：
```
主机: tanva-db  (内部连接)
端口: 5432
用户: postgres
密码: [你的密码]
数据库: tanva
```

---

### 步骤 2：创建后端应用

1. **创建应用**：应用 → 创建应用
2. **选择源**：Git 仓库
3. **填写信息**：
   ```
   应用名称: tanva-backend
   Git 仓库: https://github.com/你的用户名/你的项目.git
   分支: main
   Dockerfile: server/Dockerfile
   容器端口: 4000
   副本数: 2
   ```

4. **配置环境变量**（点击 "高级配置"）：

```bash
# 数据库
DATABASE_URL=postgresql://postgres:你的密码@tanva-db:5432/tanva?schema=public

# 服务器
PORT=4000
HOST=0.0.0.0

# JWT（生成强随机字符串）
JWT_ACCESS_SECRET=生成32个字符以上的随机字符串_访问令牌
JWT_REFRESH_SECRET=生成32个字符以上的随机字符串_刷新令牌
JWT_ACCESS_TTL=900s
JWT_REFRESH_TTL=30d

# Cookie
COOKIE_SECRET=生成32个字符以上的随机字符串_cookie
COOKIE_SECURE=true
COOKIE_SAMESITE=lax
COOKIE_DOMAIN=.你的子域.sealos.app

# CORS
CORS_ORIGIN=https://你的子域.sealos.app

# OSS（如果使用）
OSS_REGION=oss-cn-hangzhou
OSS_BUCKET=你的bucket名称
OSS_ACCESS_KEY_ID=你的访问密钥ID
OSS_ACCESS_KEY_SECRET=你的访问密钥
OSS_CDN_HOST=你的CDN地址（可选）
OSS_ENDPOINT=你的endpoint（可选）
```

5. **资源配置**：
   ```
   内存：256Mi ~ 512Mi
   CPU：100m ~ 500m
   ```

6. **健康检查**（可选）：
   - 存活探针：`GET /api/health` (15s延迟，20s周期)
   - 就绪探针：`GET /api/health/db` (5s延迟，10s周期)

7. **部署**：点击部署

---

### 步骤 3：创建前端应用

1. **创建应用**：应用 → 创建应用
2. **选择源**：Git 仓库
3. **填写信息**：
   ```
   应用名称: tanva-frontend
   Git 仓库: https://github.com/你的用户名/你的项目.git
   分支: main
   Dockerfile: Dockerfile.frontend
   容器端口: 80
   副本数: 2
   ```

4. **配置环境变量**（Build 时变量）：
```bash
VITE_ENV=production
VITE_GOOGLE_GEMINI_API_KEY=你的Google API密钥
VITE_VIDEO_DEFAULT_DURATION=8
VITE_VIDEO_DEFAULT_RESOLUTION=720p
```

5. **资源配置**：
   ```
   内存：128Mi ~ 256Mi
   CPU：50m ~ 200m
   ```

6. **部署**：点击部署

---

### 步骤 4：配置域名和 HTTPS

1. **获取外网 IP/域名**：
   - 在应用详情页，查看 "网络访问"
   - Sealos 会自动分配一个 `.sealos.app` 的子域名

2. **HTTPS 配置**：Sealos 自动为 `.sealos.app` 域名签发 SSL 证书

3. **自定义域名**（可选）：
   - 在 Sealos 控制台配置自定义域名
   - 更新你的域名 DNS：CNAME 指向 Sealos 分配的地址

---

### 步骤 5：初始化数据库

1. **连接到 PostgreSQL**：
```bash
# 从本地连接（需要 Sealos VPN 或通过应用访问）
psql postgresql://postgres:你的密码@tanva-db.sealos.app:5432/tanva
```

2. **运行 Prisma 迁移**：
```bash
# 本地运行（在你的项目目录）
DATABASE_URL="postgresql://postgres:你的密码@tanva-db.sealos.app:5432/tanva" npx prisma migrate deploy
```

或在后端容器中运行：
```bash
# 进入后端 Pod 的终端
npx prisma migrate deploy
```

---

## 七、测试部署

### 7.1 验证后端
```bash
# 替换为你的实际域名/IP
curl https://you-domain.sealos.app/api/health
# 期望响应：{"status": "ok"}

curl https://你的域名.sealos.app/api/health/db
# 期望响应：{"status": "ok", "db": "connected"}
```

### 7.2 验证前端
在浏览器访问：`https://你的域名.sealos.app`

### 7.3 测试用户注册
```bash
curl -X POST https://你的域名.sealos.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"test123","name":"test"}'
```

---

## 八、生产优化

### 8.1 自动扩展
1. 应用详情 → 自动扩展
2. 配置：
   ```
   最小副本: 2
   最大副本: 5
   CPU 使用率阈值: 70%
   内存使用率阈值: 80%
   ```

### 8.2 监控告警
1. 左侧菜单 → 监控
2. 创建告警规则：
   - 后端容器 CPU 使用率 > 80%
   - 数据库连接数 > 90
   - 前端错误率 > 5%

### 8.3 日志查看
1. 应用详情 → 日志
2. 实时查看应用输出
3. 支持日志导出

### 8.4 备份策略
1. 数据库 → 备份设置
2. 启用自动备份（每日）
3. 保留 7-30 天备份

---

## 九、成本估算

| 资源 | 配置 | 月成本（估计） |
|------|------|-----------|
| PostgreSQL | 50GB 存储 + 512Mi内存 | ¥30-50 |
| 后端 API | 256Mi × 2副本 | ¥30-50 |
| 前端 Web | 128Mi × 2副本 | ¥15-25 |
| **总计** | | **¥75-125/月** |

**对比**：
- 阿里云 ECS：¥100-200/月（单实例）
- Sealos：¥75-125/月（含数据库 + 自动扩展）

---

## 十、故障排查

### 问题 1：后端无法连接数据库
```bash
# 检查环境变量
echo $DATABASE_URL

# 验证数据库服务
curl tanva-db:5432  # 应该超时（证明可达）
```

**解决**：
- 确保 DATABASE_URL 格式正确
- 检查数据库容器是否运行
- 确认网络连接

### 问题 2：前端无法访问后端 API
**Nginx 配置问题**：
- 检查 `/api/` 反向代理配置
- 确保后端服务名正确：`tanva-backend:4000`

### 问题 3：CORS 错误
**解决**：
- 后端 `CORS_ORIGIN` 必须匹配前端域名
- 确保 `COOKIE_SECURE=true` 和 `COOKIE_SAMESITE=lax`

### 问题 4：容器重启循环
```bash
# 查看日志
# 应用详情 → 日志

# 常见原因：
# 1. 数据库连接失败
# 2. 环境变量缺失
# 3. Prisma 迁移失败
```

---

## 十一、进阶：CI/CD 自动部署

### 使用 GitHub Actions 自动构建和推送镜像

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to Sealos

on:
  push:
    branches: [main]

env:
  REGISTRY: registry.sealos.app
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.SEALOS_USERNAME }}
        password: ${{ secrets.SEALOS_PASSWORD }}

    # 构建和推送后端镜像
    - name: Build and push backend
      uses: docker/build-push-action@v4
      with:
        context: ./server
        file: ./server/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/tanva-backend:latest

    # 构建和推送前端镜像
    - name: Build and push frontend
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile.frontend
        push: true
        tags: ${{ env.REGISTRY }}/tanva-frontend:latest

    # 使用 Sealos CLI 更新部署（可选）
    - name: Update deployment
      run: |
        # 这里可以调用 Sealos API 自动更新应用
        echo "Deployment updated"
```

---

## 十二、快速检查清单

部署前请确认：

- [ ] 前端 Dockerfile.frontend 已创建
- [ ] 后端 server/Dockerfile 已创建
- [ ] nginx.conf 已创建
- [ ] 项目已提交到 Git
- [ ] Sealos 账户已注册并充值
- [ ] 所有敏感信息（密码、密钥）已从代码中移除
- [ ] .env.example 中的示例值已更新
- [ ] package.json 中的 build 脚本可以正常运行
- [ ] 本地构建测试通过：`docker build .`
- [ ] 数据库迁移脚本已准备

---

## 十三、联系支持

- **Sealos 官网**：https://www.sealos.io/
- **文档**：https://docs.sealos.io/
- **社区**：https://forum.sealos.io/
- **技术支持**：support@sealos.io

---

## 总结

✅ **Tanva 在 Sealos 上的部署完全可行**

**核心优势**：
1. 无需自管 Kubernetes，开箱即用
2. 自动化部署、扩展、备份
3. 相比 ECS 更经济、更便捷
4. 内置监控告警
5. 支持一键回滚

**推荐流程**：
1. 在 Sealos 创建 PostgreSQL
2. 推送代码，创建后端应用
3. 创建前端应用
4. 配置域名和 HTTPS
5. 初始化数据库并测试

**预计部署时间**：30-60 分钟（首次）
