# Sealos 部署快速参考卡

## 🎯 3 种部署方式选择

### ✅ 我想快速上线（推荐首选）
```
1. 注册 Sealos：https://cloud.sealos.io
2. 创建 PostgreSQL（3分钟）
3. 创建后端应用（5分钟）
4. 创建前端应用（5分钟）
5. 初始化数据库
6. 完成！总共 20 分钟 ✨

📖 参考：SEALOS_QUICK_START.md
```

### 🐳 我想先本地验证（最安全）
```
1. docker-compose up -d
2. docker-compose logs -f
3. 验证 http://localhost
4. 本地测试通过后再上线 Sealos
5. docker-compose down

📖 参考：DOCKER_LOCAL_TEST.md
⏱️  时间：30-60 分钟
```

### 🚀 我需要完全自动化部署（企业级）
```
1. 学习 Kubernetes YAML 部分
2. 配置 GitHub Actions CI/CD
3. 每次 push 自动部署
4. 监控和告警配置

📖 参考：SEALOS_DEPLOYMENT_GUIDE.md
⏱️  时间：2-3 小时
```

---

## 📝 5 分钟快速部署步骤

### 第 1 步：准备密钥
```bash
# 生成 JWT 密钥（用任意一个）
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 或在线生成
# https://www.uuidgenerator.net/
# （生成后去掉所有 "-" 符号）

# 需要生成 3 个：
# - JWT_ACCESS_SECRET
# - JWT_REFRESH_SECRET
# - COOKIE_SECRET
```

### 第 2 步：创建数据库（3分钟）
```
Sealos 控制台：
  应用 → 应用商店 → PostgreSQL → 安装

配置：
  应用名称：tanva-db
  用户：postgres
  密码：[点击生成]  ← 保存这个！
  存储：50 GB
  部署

⏳ 等待 Running...
```

### 第 3 步：创建后端（5分钟）
```
Sealos 控制台：
  应用 → 创建应用 → 从 Git 仓库

基本配置：
  应用名称：tanva-backend
  Git 仓库：https://github.com/你的/项目.git
  分支：main
  Dockerfile：server/Dockerfile
  容器端口：4000

环境变量（复制粘贴）：
  PORT=4000
  HOST=0.0.0.0
  DATABASE_URL=postgresql://postgres:[数据库密码]@tanva-db:5432/tanva?schema=public
  JWT_ACCESS_SECRET=[你的第1个密钥]
  JWT_REFRESH_SECRET=[你的第2个密钥]
  JWT_ACCESS_TTL=900s
  JWT_REFRESH_TTL=30d
  COOKIE_SECRET=[你的第3个密钥]
  COOKIE_SECURE=true
  COOKIE_SAMESITE=lax
  COOKIE_DOMAIN=.sealos.app
  CORS_ORIGIN=https://tanva-frontend-xxx.sealos.app
  OSS_REGION=oss-cn-hangzhou
  OSS_BUCKET=你的bucket
  OSS_ACCESS_KEY_ID=你的key
  OSS_ACCESS_KEY_SECRET=你的secret

部署 → ⏳ 等待 Running...
```

### 第 4 步：创建前端（5分钟）
```
Sealos 控制台：
  应用 → 创建应用 → 从 Git 仓库

基本配置：
  应用名称：tanva-frontend
  Git 仓库：https://github.com/你的/项目.git
  分支：main
  Dockerfile：Dockerfile.frontend
  容器端口：80

环境变量：
  VITE_ENV=production
  VITE_GOOGLE_GEMINI_API_KEY=你的API密钥
  VITE_VIDEO_DEFAULT_DURATION=8
  VITE_VIDEO_DEFAULT_RESOLUTION=720p

部署 → ⏳ 等待 Running...
```

### 第 5 步：初始化数据库（5分钟）
```bash
# 方法1：本地运行（推荐）
cd server
DATABASE_URL="postgresql://postgres:[密码]@tanva-db.sealos.app:5432/tanva?schema=public" npx prisma migrate deploy

# 方法2：进入容器运行
# 在 Sealos 控制台 → tanva-backend → 终端
npx prisma migrate deploy
```

### 完成！🎉
```
访问你的应用：
  前端：https://tanva-frontend-xxx.sealos.app
  后端 API：https://tanva-backend-xxx.sealos.app/api/health
```

---

## 🐛 常见问题快速修复

| 问题 | 症状 | 解决方案 |
|------|------|--------|
| 数据库连接失败 | 后端无法启动 | 检查 DATABASE_URL 是否正确，tanva-db 是否正在运行 |
| CORS 错误 | 前端调用后端报 CORS 错误 | 更新 CORS_ORIGIN 为正确的前端域名 |
| 404 错误 | 访问前端 API 返回 404 | 检查 nginx.conf 中的反向代理配置 |
| 500 错误 | 前端可访问但报 500 | 查看后端日志：应用详情 → 日志 |
| 容器无法启动 | 应用卡在"启动中" | 检查容器日志找出错误信息 |
| 静态文件 404 | 刷新页面显示 404 | nginx.conf 中的 try_files 配置有问题 |

---

## 📊 监控关键指标

部署后定期检查：

```
✅ 应用状态：所有 Pod 显示 Running
✅ 响应时间：< 1000ms
✅ CPU 使用：< 50%
✅ 内存使用：< 70%
✅ 错误日志：每小时 < 10 条错误
✅ 数据库：连接正常，查询快速
```

---

## 🔑 环境变量完整参考

### 后端必需
```
PORT=4000
DATABASE_URL=postgresql://postgres:password@host:5432/db?schema=public
JWT_ACCESS_SECRET=xxxxx（32字符以上）
JWT_REFRESH_SECRET=xxxxx（32字符以上）
COOKIE_SECRET=xxxxx（32字符以上）
```

### 后端可选
```
COOKIE_SECURE=true/false
COOKIE_SAMESITE=lax/strict/none
COOKIE_DOMAIN=.example.com
CORS_ORIGIN=https://example.com
```

### 后端 OSS（如使用）
```
OSS_REGION=oss-cn-hangzhou
OSS_BUCKET=bucket-name
OSS_ACCESS_KEY_ID=xxxx
OSS_ACCESS_KEY_SECRET=xxxx
OSS_CDN_HOST=xxxx（可选）
OSS_ENDPOINT=xxxx（可选）
```

### 前端必需
```
VITE_ENV=production
VITE_GOOGLE_GEMINI_API_KEY=your-api-key
```

### 前端可选
```
VITE_VIDEO_DEFAULT_DURATION=8
VITE_VIDEO_DEFAULT_RESOLUTION=720p
VITE_VIDEO_POLL_INTERVAL=2000
VITE_VIDEO_TIMEOUT=300000
```

---

## 🔒 安全清单

```
前部署：
☐ .env 已从 Git 中移除
☐ 密钥已生成（> 32字符）
☐ 数据库密码已生成（> 12字符）
☐ 所有敏感信息已从代码中移除

部署中：
☐ 所有环境变量在 Sealos 中正确配置
☐ COOKIE_SECURE=true（生产环境）
☐ HTTPS 已启用
☐ CORS 仅允许特定域名

部署后：
☐ 没有在日志中暴露密钥
☐ 健康检查端点工作正常
☐ SSL 证书有效
☐ 定期轮换密钥
```

---

## 💰 成本预估

```
按需付费模式：

数据库（PostgreSQL）
  50GB 存储 + 512Mi 内存：¥30-50/月

后端服务
  256Mi × 2副本：¥30-50/月

前端服务
  128Mi × 2副本：¥15-25/月

总计：¥75-125/月

💡 首次注册通常有免费额度（¥300-1000）
```

---

## 📚 查看完整文档

| 需求 | 文档 |
|------|------|
| 5分钟快速上线 | `SEALOS_QUICK_START.md` |
| 本地 Docker 测试 | `DOCKER_LOCAL_TEST.md` |
| 完整部署指南 | `SEALOS_DEPLOYMENT_GUIDE.md` |
| 部署前检查清单 | `DEPLOYMENT_CHECKLIST_SEALOS.md` |
| 这个快速参考 | `SEALOS_QUICK_REFERENCE.md` |

---

## 🎓 有用的链接

- Sealos 官网：https://www.sealos.io/
- Sealos 文档：https://docs.sealos.io/
- Docker 文档：https://docs.docker.com/
- NestJS 文档：https://docs.nestjs.com/
- React 文档：https://react.dev/
- Prisma 文档：https://www.prisma.io/docs/

---

## 🚀 下一步

```
右现在：
  1️⃣  决定部署方式（快速 vs 完整）
  2️⃣  生成所需的密钥

在 5 分钟内：
  3️⃣  创建 PostgreSQL
  4️⃣  创建后端应用
  5️⃣  创建前端应用

10 分钟后：
  6️⃣  初始化数据库
  7️⃣  验证应用正常运行

你就完成了！🎉
```

---

## 📞 遇到问题？

1. **查看日志**：应用详情 → 日志
2. **阅读指南**：`SEALOS_DEPLOYMENT_GUIDE.md` 的故障排查部分
3. **本地测试**：用 `docker-compose` 在本地重现问题
4. **查看错误**：检查部署清单 `DEPLOYMENT_CHECKLIST_SEALOS.md`

---

**祝你部署顺利！🚀**

版本：1.0 | 更新：2025-10-23
