# 本地文件系统访问功能设计文档

## 1. 需求概述

### 1.1 背景
用户希望 AI 能够持续访问本地电脑上的文档，作为对话的上下文参考，而无需每次都手动上传文件。

### 1.2 目标
- 用户授权后，AI 可以读取指定本地目录中的文档
- 文档内容自动作为 AI 对话的上下文
- 提供独立的侧边栏面板管理本地文档

### 1.3 支持的文件类型
| 类型 | 扩展名 |
|------|--------|
| 文本 | `.txt`, `.md`, `.json`, `.csv`, `.xml`, `.yaml`, `.yml` |
| 代码 | `.js`, `.ts`, `.jsx`, `.tsx`, `.py`, `.html`, `.css`, `.scss` |
| 配置 | `.env.example`, `.gitignore`, `.prettierrc` |

---

## 2. 技术方案

### 2.1 核心技术：File System Access API

这是一个现代浏览器原生 API，允许网页在用户授权后访问本地文件系统。

**浏览器支持情况：**
| 浏览器 | 支持版本 | 状态 |
|--------|----------|------|
| Chrome | 86+ | ✅ 完全支持 |
| Edge | 86+ | ✅ 完全支持 |
| Opera | 72+ | ✅ 完全支持 |
| Safari | - | ❌ 不支持 |
| Firefox | - | ❌ 不支持 |

### 2.2 API 核心方法

```typescript
// 选择目录
const dirHandle = await window.showDirectoryPicker();

// 列出目录内容
for await (const [name, handle] of dirHandle.entries()) {
  console.log(name, handle.kind); // 'file' 或 'directory'
}

// 读取文件
const fileHandle = await dirHandle.getFileHandle('example.txt');
const file = await fileHandle.getFile();
const content = await file.text();
```

---

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │ LocalDocsPanel  │  │        AIChatDialog             │  │
│  │   (侧边栏面板)   │  │    (AI 对话自动获取上下文)       │  │
│  └────────┬────────┘  └────────────────┬────────────────┘  │
└───────────┼────────────────────────────┼────────────────────┘
            │                            │
┌───────────┼────────────────────────────┼────────────────────┐
│           ▼                            ▼     状态管理层      │
│  ┌─────────────────┐          ┌─────────────────┐          │
│  │  localDocsStore │◄────────►│  contextManager │          │
│  │   (文档状态)     │          │   (上下文管理)   │          │
│  └────────┬────────┘          └─────────────────┘          │
└───────────┼─────────────────────────────────────────────────┘
            │
┌───────────┼─────────────────────────────────────────────────┐
│           ▼                              服务层              │
│  ┌──────────────────────────┐                               │
│  │ localFileSystemService   │                               │
│  │  (File System Access API │                               │
│  │   封装)                   │                               │
│  └──────────────────────────┘                               │
└─────────────────────────────────────────────────────────────┘
            │
            ▼
    ┌───────────────┐
    │   本地文件系统  │
    └───────────────┘
```

### 3.2 数据流

```
1. 用户点击"选择文件夹"
        ↓
2. localFileSystemService.pickDirectory()
        ↓
3. 浏览器弹出目录选择器，用户授权
        ↓
4. localDocsStore 存储目录句柄
        ↓
5. 自动扫描并读取支持的文档
        ↓
6. contextManager 缓存文档内容
        ↓
7. 用户发送 AI 消息时
        ↓
8. contextManager.buildContextWithLocalDocs()
        ↓
9. 文档内容作为上下文发送给 AI
```

---

## 4. 详细设计

### 4.1 localFileSystemService.ts

**文件路径**: `frontend/src/services/localFileSystemService.ts`

**核心功能：**

```typescript
// 检测浏览器支持
function isSupported(): boolean

// 选择并授权目录
async function pickDirectory(): Promise<FileSystemDirectoryHandle>

// 列出目录内容
async function listDirectory(handle: FileSystemDirectoryHandle): Promise<DirectoryEntry[]>

// 读取单个文件
async function readFile(handle: FileSystemFileHandle): Promise<LocalFile>

// 批量读取文本文件
async function readTextFiles(
  dirHandle: FileSystemDirectoryHandle,
  options?: { maxFiles?: number; maxSize?: number }
): Promise<LocalFile[]>

// 检查权限状态
async function checkPermission(handle: FileSystemHandle): Promise<PermissionState>

// 请求权限
async function requestPermission(handle: FileSystemHandle): Promise<boolean>
```

### 4.2 localDocsStore.ts

**文件路径**: `frontend/src/stores/localDocsStore.ts`

**状态结构：**

```typescript
interface LocalDocsState {
  // 状态
  isSupported: boolean;
  directoryHandle: FileSystemDirectoryHandle | null;
  directoryPath: string | null;
  documents: LocalDocument[];
  isLoading: boolean;
  error: string | null;
  totalSize: number;

  // 操作
  authorizeDirectory: () => Promise<boolean>;
  refreshDocuments: () => Promise<void>;
  removeDocument: (path: string) => void;
  clearAll: () => void;
  getDocumentContent: (path: string) => string | null;
}

interface LocalDocument {
  name: string;
  path: string;
  size: number;
  type: 'text' | 'code' | 'config' | 'other';
  content: string;
  lastModified: number;
}
```

### 4.3 LocalDocsPanel.tsx

**文件路径**: `frontend/src/components/panels/LocalDocsPanel.tsx`

**UI 结构：**

```
┌─────────────────────────────────┐
│  本地文档                    ✕  │
├─────────────────────────────────┤
│  [📁 选择文件夹]  [🔄 刷新]     │
├─────────────────────────────────┤
│  📂 /Users/xxx/Documents        │
│  ├── 📄 readme.md (2.3KB)       │
│  ├── 📄 config.json (1.1KB)     │
│  ├── 📄 notes.txt (856B)        │
│  └── 📄 api.ts (3.2KB)          │
├─────────────────────────────────┤
│  共 4 个文档，总计 7.4KB        │
└─────────────────────────────────┘
```

**功能列表：**
1. 浏览器支持检测和提示
2. 选择文件夹按钮
3. 刷新按钮
4. 当前目录路径显示
5. 文档列表（显示名称、大小、类型图标）
6. 单个文档删除
7. 统计信息（文档数量、总大小）

### 4.4 contextManager.ts 扩展

**新增属性：**

```typescript
private localDocuments: Map<string, string> = new Map();
private localDocsEnabled: boolean = false;
```

**新增方法：**

```typescript
// 设置本地文档
setLocalDocuments(docs: Array<{ path: string; content: string }>): void

// 清除本地文档
clearLocalDocuments(): void

// 启用/禁用本地文档上下文
setLocalDocsEnabled(enabled: boolean): void

// 构建包含本地文档的上下文
buildContextWithLocalDocs(userInput: string): string
```

**上下文构建逻辑：**

```typescript
buildContextWithLocalDocs(userInput: string): string {
  let contextPrompt = this.buildContextPrompt(userInput);

  if (this.localDocsEnabled && this.localDocuments.size > 0) {
    contextPrompt += '\n\n--- 本地参考文档 ---\n';

    for (const [path, content] of this.localDocuments) {
      // 限制单个文档长度
      const truncated = content.length > 2000
        ? content.substring(0, 2000) + '...(已截断)'
        : content;
      contextPrompt += `\n[${path}]\n${truncated}\n`;
    }
  }

  return contextPrompt;
}
```

---

## 5. 文件修改清单

| 文件路径 | 操作 | 说明 |
|----------|------|------|
| `frontend/src/services/localFileSystemService.ts` | 新建 | File System Access API 封装 |
| `frontend/src/stores/localDocsStore.ts` | 新建 | 本地文档状态管理 |
| `frontend/src/components/panels/LocalDocsPanel.tsx` | 新建 | 侧边栏文档管理面板 |
| `frontend/src/types/localDocs.ts` | 新建 | TypeScript 类型定义 |
| `frontend/src/stores/uiStore.ts` | 修改 | 添加 `showLocalDocsPanel` 状态 |
| `frontend/src/services/contextManager.ts` | 修改 | 添加本地文档上下文支持 |

---

## 6. 安全考虑

### 6.1 权限控制
- 用户必须主动点击按钮触发授权
- 每次浏览器会话需要重新授权
- 只请求只读权限，不写入用户文件

### 6.2 文件过滤
自动跳过以下敏感文件：
- `.env` 环境变量文件
- `credentials.json` 凭证文件
- `*.key`, `*.pem` 密钥文件
- `node_modules/` 目录
- `.git/` 目录

### 6.3 大小限制
- 单个文件最大：1MB
- 总文档大小最大：5MB
- 超出限制时显示警告

---

## 7. 降级方案

对于不支持 File System Access API 的浏览器（Safari、Firefox）：

1. 检测到不支持时，显示友好提示
2. 建议用户使用 Chrome 或 Edge 浏览器
3. 提供传统文件上传作为替代方案

**提示信息示例：**
```
您的浏览器不支持本地文件夹访问功能。
请使用 Chrome 86+ 或 Edge 86+ 浏览器，
或使用传统的文件上传方式。
```

---

## 8. 使用流程

### 8.1 首次使用
1. 用户点击侧边栏"本地文档"图标
2. 面板显示，点击"选择文件夹"
3. 浏览器弹出目录选择器
4. 用户选择包含文档的目录
5. 系统自动扫描并加载支持的文档
6. 文档列表显示在面板中

### 8.2 日常使用
1. 打开本地文档面板
2. 确认文档已加载（或点击刷新）
3. 在 AI 对话中提问
4. AI 自动参考本地文档内容回答

### 8.3 更新文档
1. 在本地修改文档内容
2. 点击面板中的"刷新"按钮
3. 系统重新读取最新内容

---

## 9. 后续扩展

### 9.1 可能的增强功能
- [ ] 支持子目录递归扫描
- [ ] 文档内容搜索
- [ ] 文档预览功能
- [ ] 多目录支持
- [ ] 文档变化自动检测
- [ ] PDF 文档支持（需要额外解析库）

### 9.2 性能优化
- [ ] 大文件分块读取
- [ ] 文档内容缓存
- [ ] 懒加载文档内容
