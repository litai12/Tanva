# 图像历史与缓存系统

本篇介绍图像历史记录、AI 上下文图片缓存与智能放置策略。

## 组件与服务

- 历史服务：`src/services/imageHistoryService.ts`
  - `recordImageHistoryEntry()`：将 base64 先入历史，再后台上传至 OSS，成功后回填远程 URL
  - `migrateImageHistoryToRemote()`：批量迁移历史中仍为 base64 的项
- 历史 Store：`src/stores/imageHistoryStore.ts`（图片项、去重/更新/清空等）
- 上下文管理：`src/services/contextManager.ts`
  - 维护最近一次图片缓存（ID、中心点、提示词、最近模式）
  - 提供“是否为迭代操作”的判断与上下文 Prompt 构建
- 调试面板：`src/components/debug/CachedImageDebug.tsx`

## 智能放置策略（摘要）

- 基于最近缓存的中心点 `(cx, cy)` 与操作模式 `generate|edit|blend|analyze|chat`
- 新图像放置：
  - 生成（generate）：默认在缓存中心点右侧偏移约 522px
  - 编辑（edit）：默认在缓存中心点下方偏移约 522px
- 若无缓存中心点：回退到画布默认中心位置 `(0, 0)`

相关变更参见：`docs/06-变更日志.md`

## 与自动保存的关系

- 历史记录本身不强制触发保存，但图片作为画布对象/层变化被收敛到项目内容中
- 切换项目时默认不清理历史，以便跨文件查看；如需隔离可在切换时清空

## 最佳实践

- 在批量生成或频繁编辑时，定期迁移 base64 → 远程 URL，减少本地内存
- 对关键图像使用清晰的 `title` 与分目录 `dir` 便于归档

