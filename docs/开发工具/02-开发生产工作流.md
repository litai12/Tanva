# 🚀 开发-生产分离工作流完整指南

## 架构概览

```
本地开发环境 (你的电脑)
├─ 前端: http://localhost:5173
├─ 后端: http://localhost:4000
└─ 数据库: PostgreSQL local

        ↓ git push

GitHub/GitLab 代码仓库
├─ 分支: main (生产)
├─ 分支: dev (开发)
└─ 分支: feature/* (功能分支)

        ↓ 部署脚本 (手动或自动)

Aliyun 生产环境
├─ 前端: https://tai.tanva.tgtai.com
├─ 后端 API: https://tai.tanva.tgtai.com/api
├─ 数据库: RDS PostgreSQL
└─ CDN: Aliyun OSS + CDN
```

---

## 第一步: 准备工作 (本周完成)

### 1.1 配置 Git 分支策略

```bash
# 创建开发分支
git branch dev
git branch -a  # 查看所有分支

# 配置远程分支
git push -u origin dev
git push -u origin main

# 设置默认分支
# GitHub/GitLab 网页控制台 → Settings → Default branch → 设为 main
```

### 1.2 创建环境配置文件

**前端环境变量** - `.env.development`
```env
# 开发环境
VITE_AI_LANGUAGE=zh
VITE_AUTH_MODE=server
VITE_API_BASE=/api
# 开发环境使用 localhost
VITE_DEV_SERVER=http://localhost:5173
```

**前端环境变量** - `.env.production`
```env
# 生产环境
VITE_AI_LANGUAGE=zh
VITE_AUTH_MODE=server
VITE_API_BASE=https://tai.tanva.tgtai.com/api
# 生产环境使用 Aliyun 域名
VITE_API_URL=https://tai.tanva.tgtai.com
```

**后端环境变量** - `server/.env.development`
```env
# 开发环境
PORT=4000
HOST=0.0.0.0
NODE_ENV=development

DATABASE_URL="postgresql://litai@localhost:5432/tanva?schema=public"
CORS_ORIGIN=http://localhost:5173,http://localhost:3000,http://192.168.2.115:5173,http://192.168.2.115:3000

# AI配置
DEFAULT_AI_PROVIDER=gemini
GOOGLE_GEMINI_API_KEY=your_dev_key

# 日志级别
LOG_LEVEL=debug
```

**后端环境变量** - `server/.env.production`
```env
# 生产环境
PORT=4000
HOST=0.0.0.0
NODE_ENV=production

DATABASE_URL="postgresql://tanva_user:strong_password@aliyun-rds-host:5432/tanva?schema=public"
CORS_ORIGIN=https://tai.tanva.tgtai.com

# AI配置
DEFAULT_AI_PROVIDER=gemini
GOOGLE_GEMINI_API_KEY=your_prod_key

# 日志级别
LOG_LEVEL=info
```

### 1.3 配置 .gitignore

```
# 环境文件 - 不提交到仓库
.env.local
.env.development.local
.env.production.local
.env.test.local

# 依赖
node_modules/
dist/
build/

# 日志
*.log
logs/

# 系统文件
.DS_Store
.vscode/settings.json
```

---

## 第二步: 本地开发流程 (日常工作)

### 2.1 开始新功能开发

```bash
# 从 dev 分支拉取最新代码
git checkout dev
git pull origin dev

# 创建功能分支
git checkout -b feature/ai-chat-improvements

# 开发和提交
git add .
git commit -m "feat: 改进AI对话功能"

# 推送到远程
git push -u origin feature/ai-chat-improvements
```

### 2.2 本地测试

```bash
# 终端1: 启动后端 (开发模式)
cd server
npm install  # 如果依赖有更新
npm run dev  # 使用 .env.development

# 终端2: 启动前端 (开发模式)
npm install  # 如果依赖有更新
npm run dev  # 自动使用 .env.development
```

### 2.3 本地网络测试

```bash
# 其他PC访问
http://192.168.2.115:5173

# 或使用Cloudflare Tunnel快速测试
bash setup-cloudflare-tunnel.sh
```

---

## 第三步: 代码审查和合并 (发布前)

### 3.1 创建 Pull Request

```bash
# 推送功能分支后，在GitHub创建PR
# 1. 访问 https://github.com/你的用户名/Tanva
# 2. 点击 "Compare & pull request"
# 3. 设置:
#    - Base: dev
#    - Compare: feature/你的功能分支
# 4. 添加描述
# 5. 请求代码审查
```

**PR 描述模板**:
```markdown
## 描述
做了什么改变？

## 类型
- [ ] 新功能
- [ ] 错误修复
- [ ] 性能优化
- [ ] 文档更新

## 测试清单
- [ ] 本地测试通过
- [ ] 没有新的警告
- [ ] 相关文档已更新

## 截图
(如果有UI变化)
```

### 3.2 代码审查

```bash
# 审查者审查代码后
# 1. 如果需要修改，继续在功能分支上提交
# 2. 自动同步到PR
# 3. 通过审查后，合并到 dev
```

---

## 第四步: 测试环境验证 (可选)

### 4.1 部署到测试环境

```bash
# 在 Aliyun 创建测试实例
# 或使用 Cloudflare Tunnel 作为临时测试环境

# 测试环境变量 (.env.staging)
DATABASE_URL="postgresql://user@test-rds:5432/tanva_test"
CORS_ORIGIN=https://test.tai.tanva.tgtai.com
LOG_LEVEL=info
```

---

## 第五步: 发布到生产环境

### 5.1 合并到 main 分支

```bash
# 确保 dev 分支已通过所有测试
git checkout dev
git pull origin dev

# 创建发布分支
git checkout -b release/v1.0.0

# 更新版本号（可选）
# package.json: "version": "1.0.0"

# 提交版本更新
git add .
git commit -m "chore: bump version to 1.0.0"

# 创建 PR: release/v1.0.0 → main
# 合并后，main 分支就是生产版本
```

### 5.2 标记发布版本 (可选)

```bash
# 合并到 main 后
git checkout main
git pull origin main

# 创建 Git tag
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# 在 GitHub 创建 Release
# https://github.com/你的用户名/Tanva/releases/new
```

### 5.3 部署到 Aliyun

#### 方案A: 手动部署 (简单)

```bash
# SSH 连接到 Aliyun 服务器
ssh -i /path/to/key.pem ubuntu@你的服务器IP

# 在服务器上
cd /opt/Tanva

# 获取最新代码
git fetch origin
git checkout main
git pull origin main

# 安装依赖
npm install --production

# 前端构建
npm run build

# 后端启动
cd server
npm install --production
pm2 restart tanva-backend

# 检查状态
pm2 status
```

#### 方案B: 自动化部署 (推荐) - GitHub Actions

创建 `.github/workflows/deploy-prod.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install
        cd server && npm install && cd ..

    - name: Build frontend
      run: npm run build

    - name: Deploy to Aliyun
      env:
        ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
        ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
        ALIYUN_KEY: ${{ secrets.ALIYUN_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$ALIYUN_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $ALIYUN_USER@$ALIYUN_HOST << 'EOF'
          cd /opt/Tanva
          git fetch origin
          git checkout main
          git pull origin main
          npm install --production
          cd server
          npm install --production
          pm2 restart tanva-backend
        EOF

    - name: Run smoke tests
      run: npm run test:smoke
```

配置 GitHub Secrets:
```bash
# GitHub Settings → Secrets and variables → Actions → New repository secret
ALIYUN_HOST: your.aliyun.ip
ALIYUN_USER: ubuntu
ALIYUN_KEY: (你的SSH私钥内容)
```

### 5.4 验证生产环境

```bash
# 检查应用是否正常运行
curl https://tai.tanva.tgtai.com/api/public/ai/providers

# 检查数据库连接
curl https://tai.tanva.tgtai.com/api/health/db

# 访问前端
https://tai.tanva.tgtai.com
```

---

## 工作流完整示例

### 周一: 开始新功能

```bash
# 1. 拉取最新代码
git checkout dev
git pull origin dev

# 2. 创建功能分支
git checkout -b feature/image-enhancement

# 3. 开发并提交
# ... 开发中 ...
git add src/components/ImageEditor.tsx
git commit -m "feat: 添加图像编辑器增强功能"
```

### 周二-周四: 本地测试

```bash
# 运行开发服务器
npm run dev

# 在 http://localhost:5173 测试
# 在 http://192.168.2.115:5173 团队测试
```

### 周五: 代码审查

```bash
# 推送到远程
git push origin feature/image-enhancement

# GitHub 创建 PR
# - Title: feat: 添加图像编辑器增强功能
# - Description: 详细描述改进内容
# - Reviewers: 指定审查人员
```

### 周五下午: 合并到 dev

```bash
# PR 通过审查后，点击 "Merge pull request"
# 选择 "Squash and merge" 保持提交历史干净
```

### 下周一: 发布到生产

```bash
# 1. 创建发布分支
git checkout dev
git pull origin dev
git checkout -b release/v1.1.0

# 2. 更新版本和文档
# ... 更新版本号 ...
git add .
git commit -m "chore: release v1.1.0"

# 3. 创建 PR: release/v1.1.0 → main

# 4. 合并后自动部署 (如果配置了GitHub Actions)

# 5. 验证生产环境
https://tai.tanva.tgtai.com
```

---

## 最佳实践

### ✅ 开发分支命名规范

```
feature/xxx       - 新功能
bugfix/xxx        - 错误修复
hotfix/xxx        - 紧急修复 (从main分出)
refactor/xxx      - 重构
docs/xxx          - 文档更新
perf/xxx          - 性能优化
```

### ✅ 提交信息规范

```
feat: 新增功能说明
fix: 修复错误说明
docs: 文档更新说明
style: 代码风格调整
refactor: 重构说明
perf: 性能优化说明
test: 测试添加说明
chore: 构建或依赖更新
```

### ✅ 发布清单

```
部署前检查:
- [ ] 所有测试通过
- [ ] 没有控制台错误
- [ ] 性能指标良好
- [ ] 文档已更新
- [ ] 版本号已更新
- [ ] 备份已创建
- [ ] 回滚计划已制定

部署后检查:
- [ ] 应用可正常访问
- [ ] 数据库连接正常
- [ ] 日志无异常
- [ ] 用户反馈正常
```

---

## 故障恢复

### 快速回滚

```bash
# 如果生产环境出现问题
ssh -i /path/to/key.pem ubuntu@你的服务器IP

# 回到上一个版本
cd /opt/Tanva
git checkout HEAD~1
npm install --production
cd server && npm install --production
pm2 restart tanva-backend

# 或使用备份
git tag v1.0.1-backup  # 创建备份
git checkout v1.0.0     # 回到上一版本
```

### 监控生产环境

```bash
# SSH 连接后
pm2 logs tanva-backend        # 查看日志
pm2 status                     # 查看运行状态
top -p $(pgrep -d ',' node)   # 查看资源使用
```

---

## 开发 vs 生产对比

| 项目 | 开发环境 | 生产环境 |
|------|---------|---------|
| 数据库 | 本地 PostgreSQL | Aliyun RDS |
| 前端地址 | http://localhost:5173 | https://tai.tanva.tgtai.com |
| 后端地址 | http://localhost:4000 | https://tai.tanva.tgtai.com/api |
| 日志级别 | debug | info |
| CORS | localhost + 本地IP | 仅生产域名 |
| 缓存 | 禁用 | 启用 |
| 错误处理 | 详细 | 安全 |
| 监控 | 基础 | 完整 |
| 备份 | 无 | 每天 |

---

## 下一步行动

### 第一周 (本周)
1. ✅ 创建 dev 分支
2. ✅ 配置环境文件 (.env.development, .env.production)
3. ✅ 设置 .gitignore
4. ✅ 本地验证工作流

### 第二周
1. ✅ 部署第一版本到 Aliyun
2. ✅ 配置 GitHub Actions (可选)
3. ✅ 设置监控和告警
4. ✅ 创建回滚计划

### 第三周及以后
1. ✅ 持续开发新功能
2. ✅ 定期发布到生产
3. ✅ 监控用户反馈
4. ✅ 优化部署流程

