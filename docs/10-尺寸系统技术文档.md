# 2025-08-14 尺寸系统详细技术文档

## 概述

本文档详细分析智绘画板应用的尺寸系统实现，包括单位转换、比例尺渲染、坐标系统统一、状态管理等核心技术细节。

## 尺寸系统核心实现

### 1. 单位转换系统 (lib/unitUtils.ts)

#### 支持的单位类型
```typescript
export type Unit = 'mm' | 'cm' | 'm' | 'km';
```

#### 单位转换映射表
```typescript
// unitUtils.ts:6-11
const UNIT_TO_METERS = {
  'mm': 0.001,    // 1毫米 = 0.001米
  'cm': 0.01,     // 1厘米 = 0.01米
  'm': 1,         // 1米 = 1米
  'km': 1000,     // 1千米 = 1000米
};
```

#### 核心转换函数

**pixelsToUnit**: 像素到指定单位的精确转换
```typescript
// unitUtils.ts:16-25
export function pixelsToUnit(
  pixels: number, 
  scaleRatio: number, 
  targetUnit: Unit = 'm'
): number {
  // scaleRatio: 1像素对应多少米
  const meters = pixels * scaleRatio;
  const factor = UNIT_TO_METERS[targetUnit];
  return meters / factor;
}
```

**getUnitDisplayName**: 单位显示名称映射
```typescript
// unitUtils.ts:27-32
export function getUnitDisplayName(unit: Unit): string {
  const names = { 'mm': '毫米', 'cm': '厘米', 'm': '米', 'km': '千米' };
  return names[unit];
}
```

#### 智能格式化系统

**formatUnitValue**: 自适应精度格式化
```typescript
// unitUtils.ts:37-52
export function formatUnitValue(value: number, unit: Unit): string {
  // 根据单位类型确定小数位数
  const decimals = unit === 'mm' ? 1 : 
                   unit === 'cm' ? 2 : 
                   unit === 'm' ? 3 : 4; // km
  
  const formatted = value.toFixed(decimals);
  const trimmed = formatted.replace(/\.?0+$/, ''); // 去除尾随零
  return `${trimmed}${unit}`;
}
```

### 2. 智能比例尺算法

#### 合适刻度计算
```typescript
// unitUtils.ts:64-87
export function calculateScaleBarLength(
  scaleRatio: number, 
  targetUnit: Unit = 'm'
): { pixelLength: number; unitValue: number; displayText: string } {
  
  const preferredScales = getPreferredScales(targetUnit);
  
  // 寻找最适合的刻度值 (目标像素长度: 80-200px)
  for (const scale of preferredScales) {
    const pixelLength = scale / UNIT_TO_METERS[targetUnit] / scaleRatio;
    
    if (pixelLength >= 80 && pixelLength <= 200) {
      return {
        pixelLength: Math.round(pixelLength),
        unitValue: scale,
        displayText: formatUnitValue(scale, targetUnit)
      };
    }
  }
  
  // 回退方案
  return { pixelLength: 100, unitValue: 1, displayText: '1m' };
}
```

#### 分级刻度策略
```typescript
// unitUtils.ts:89-103
const getPreferredScales = (unit: Unit): number[] => {
  const bases = [1, 2, 5];  // 标准刻度基数
  const powers = unit === 'km' ? [0, 1, 2, 3] :      // 1km, 10km, 100km, 1000km
                 unit === 'm' ? [-1, 0, 1, 2] :      // 0.1m, 1m, 10m, 100m
                 unit === 'cm' ? [-2, -1, 0, 1] :    // 0.01m, 0.1m, 1m, 10m
                 [-3, -2, -1, 0];                     // mm: 0.001m, 0.01m, 0.1m, 1m
  
  return bases.flatMap(base => 
    powers.map(power => base * Math.pow(10, power))
  ).sort((a, b) => a - b);
};
```

#### 比例文本生成
```typescript
// unitUtils.ts:105-114
export function getScaleRatioText(scaleRatio: number, unit: Unit): string {
  const unitName = getUnitDisplayName(unit);
  
  if (scaleRatio >= 1) {
    return `1像素 = ${formatUnitValue(scaleRatio, unit)}`;
  } else {
    const pixelsPerUnit = Math.round(1 / scaleRatio);
    return `1${unitName} = ${pixelsPerUnit}像素`;
  }
}
```

### 3. 状态管理系统 (stores/canvasStore.ts)

#### 尺寸相关状态定义
```typescript
// canvasStore.ts:16-20
interface CanvasState {
  units: Unit;                // 当前显示单位
  scaleRatio: number;         // 1像素对应多少米
  showScaleBar: boolean;      // 显示比例尺开关
}
```

#### 类型安全的状态操作
```typescript
// canvasStore.ts:59-71
setUnits: (units) => {
  if (!isValidUnit(units)) {
    console.warn(`Invalid unit: ${units}. Falling back to 'm'.`);
    return set({ units: 'm' });
  }
  set({ units });
},

setScaleRatio: (ratio) => {
  const validRatio = Math.max(0.001, Math.min(1000, ratio)); // 限制范围
  set({ scaleRatio: validRatio });
},

toggleScaleBar: () => set((state) => ({ showScaleBar: !state.showScaleBar })),
```

#### 持久化配置
```typescript
// canvasStore.ts:74-82
{
  name: 'canvas-settings',
  partialize: (state) => ({
    gridSize: state.gridSize,
    units: state.units,
    scaleRatio: state.scaleRatio,
    showScaleBar: state.showScaleBar,
    // 注意: 不持久化视口状态 (zoom, panX, panY)
  }),
}
```

### 4. 比例尺渲染系统 (ScaleBarRenderer.tsx)

#### 坐标系统统一
```typescript
// ScaleBarRenderer.tsx:21-26
const createScaleBar = useCallback(() => {
  if (!paper.project || !paper.view) return;
  
  // 使用世界坐标获取画布边界
  const bounds = paper.view.bounds;
  const { pixelLength, displayText } = calculateScaleBarLength(
    scaleRatio / zoom, units  // 考虑缩放级别的实际比例
  );
```

#### 精确定位算法
```typescript
// ScaleBarRenderer.tsx:28-32
// 计算右下角精确定位
const rightMargin = 65;
const bottomMargin = 50;
const scaleBarRight = bounds.right - rightMargin;
const scaleBarBottom = bounds.bottom - bottomMargin;
```

#### Paper.js渲染实现
```typescript
// ScaleBarRenderer.tsx:34-44
// 创建比例尺主线
const scaleLine = new paper.Path.Line({
  from: [scaleBarRight - pixelLength, scaleBarBottom],
  to: [scaleBarRight, scaleBarBottom],
  strokeColor: 'black',
  strokeWidth: 1.5,
  data: { isScaleBar: true }
});

// 创建比例尺文本
const scaleText = new paper.PointText({
  point: [scaleBarRight - pixelLength / 2, scaleBarBottom - 8],
  content: displayText,
  fontSize: 12,
  fillColor: 'black',
  justification: 'center'
});
```

#### 图层管理策略
```typescript
// ScaleBarRenderer.tsx:53-67
// 找到或创建比例尺图层
let scaleLayer = scaleLayerRef.current;
if (!scaleLayer || scaleLayer.isDeleted) {
  scaleLayer = new paper.Layer();
  scaleLayer.name = "scaleBar";
  scaleLayer.bringToFront(); // 确保在最顶层
  scaleLayerRef.current = scaleLayer;
}

// 清空现有比例尺
scaleLayer.removeChildren();
scaleLayer.activate();
```

### 5. 性能优化选择器 (stores/appStore.ts)

#### 复合选择器模式
```typescript
// appStore.ts:22-32
export const useScaleBarState = () => {
  const { scaleRatio, showScaleBar, zoom, units } = useCanvasStore();
  
  return useMemo(() => ({
    scaleRatio,
    showScaleBar,
    zoom,
    units,
  }), [scaleRatio, showScaleBar, zoom, units]);
};
```

#### 统一操作接口
```typescript
// appStore.ts:58-80
export const useCanvasActions = () => {
  const canvasStore = useCanvasStore();
  
  return useMemo(() => ({
    setUnits: canvasStore.setUnits,
    setScaleRatio: canvasStore.setScaleRatio,
    toggleScaleBar: canvasStore.toggleScaleBar,
    // ...其他操作
  }), [canvasStore]);
};
```

### 6. 用户界面集成 (Header.tsx)

#### 单位选择器
```typescript
// Header.tsx:单位选择部分
<Select value={units} onValueChange={setUnits}>
  <SelectTrigger className="w-[80px]">
    <SelectValue />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="mm">mm</SelectItem>
    <SelectItem value="cm">cm</SelectItem>
    <SelectItem value="m">m</SelectItem>
    <SelectItem value="km">km</SelectItem>
  </SelectContent>
</Select>
```

#### 比例尺控制开关
```typescript
// Header.tsx:比例尺开关部分
<div className="flex items-center space-x-2">
  <Switch
    checked={showScaleBar}
    onCheckedChange={toggleScaleBar}
    id="scale-bar"
  />
  <Label htmlFor="scale-bar">比例尺</Label>
</div>
```

#### 实时状态显示
```typescript
// Header.tsx:状态显示部分
<div className="text-xs text-muted-foreground">
  {getScaleRatioText(scaleRatio, units)}
</div>
```

## 坐标系统统一方案

### 1. 问题分析
**原问题**: PaperCanvasManager 使用中心坐标系 (0,0) 在画布中心，而 unitUtils 假设左上角坐标系

### 2. 解决方案
**统一使用世界坐标**: 所有计算基于 Paper.js 的世界坐标系统

```typescript
// ScaleBarRenderer.tsx:坐标统一
const bounds = paper.view.bounds; // 获取当前世界坐标边界
const scaleBarRight = bounds.right - rightMargin; // 基于世界坐标定位
```

### 3. 同步机制
```typescript
// ScaleBarRenderer.tsx:71-74
useEffect(() => {
  if (!isPaperInitialized || !showScaleBar) return;
  createScaleBar(); // 与视口变化同步更新
}, [isPaperInitialized, showScaleBar, scaleRatio, zoom, units, createScaleBar]);
```

## 性能优化策略

### 1. 渲染优化
- **useCallback缓存**: createScaleBar函数避免重复创建
- **精确依赖**: 只在必要状态变化时重新渲染
- **图层分离**: 比例尺独立图层，不影响其他渲染

### 2. 状态优化
- **复合选择器**: 减少组件订阅范围，避免无关更新
- **useMemo缓存**: 状态组合使用useMemo优化
- **类型安全**: 运行时验证防止无效状态

### 3. 计算优化
- **智能算法**: 比例尺长度计算使用最优算法
- **缓存策略**: 格式化结果缓存避免重复计算
- **范围限制**: 数值范围限制避免极端计算

## 扩展性设计

### 1. 新增单位支持
```typescript
// 扩展单位类型
export type Unit = 'mm' | 'cm' | 'm' | 'km' | 'inch' | 'ft';

// 扩展转换映射
const UNIT_TO_METERS = {
  // 现有单位...
  'inch': 0.0254,  // 1英寸 = 0.0254米
  'ft': 0.3048,    // 1英尺 = 0.3048米
};
```

### 2. 比例尺样式自定义
```typescript
// 比例尺配置接口
interface ScaleBarConfig {
  color: string;
  thickness: number;
  position: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right';
  fontSize: number;
}
```

### 3. 高级功能扩展
- **多比例尺**: 同时显示多个单位的比例尺
- **动态刻度**: 根据缩放级别自动调整刻度密度
- **测量工具**: 基于单位系统的距离测量功能

## 使用案例

### 1. 基础用法
```typescript
import { useScaleBarState, useCanvasActions } from '@/stores';

const Component = () => {
  const { scaleRatio, showScaleBar, units } = useScaleBarState();
  const { setUnits, toggleScaleBar } = useCanvasActions();
  
  return (
    <div>
      <button onClick={() => setUnits('cm')}>切换到厘米</button>
      <button onClick={toggleScaleBar}>切换比例尺</button>
      <span>{getScaleRatioText(scaleRatio, units)}</span>
    </div>
  );
};
```

### 2. 单位转换
```typescript
import { pixelsToUnit, formatUnitValue } from '@/lib/unitUtils';

// 计算100像素对应的实际距离
const distance = pixelsToUnit(100, 0.1, 'm'); // 结果: 10
const formatted = formatUnitValue(distance, 'm'); // 结果: "10m"
```

### 3. 自定义比例尺
```typescript
import { calculateScaleBarLength } from '@/lib/unitUtils';

const { pixelLength, unitValue, displayText } = calculateScaleBarLength(0.05, 'cm');
// 结果: { pixelLength: 100, unitValue: 5, displayText: "5cm" }
```

## 代码文件位置索引

- 单位转换工具: `src/lib/unitUtils.ts`
- 比例尺渲染器: `src/components/canvas/ScaleBarRenderer.tsx`
- 画布状态管理: `src/stores/canvasStore.ts` (单位相关部分)
- 性能优化选择器: `src/stores/appStore.ts` (比例尺相关部分)
- 用户界面集成: `src/components/layout/Header.tsx` (尺寸设置部分)

---

*文档生成时间: 2025-08-14*
*最后更新: 2025-08-14*
*基于代码版本: 尺寸系统完整实现*