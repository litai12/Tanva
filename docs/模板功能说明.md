# 模板功能说明（JSON 版）

本文档说明如何以 JSON 文件的方式维护、导入、导出与使用流程模板，涵盖「内置模板」与「用户模板」。

## 总体思路
- 模板统一使用 JSON 作为单一事实来源（Single Source of Truth）。
- 内置模板：随应用打包，放在 `public/templates` 目录，由清单 `index.json` 懒加载。
- 用户模板：运行时保存到浏览器 IndexedDB；导入/导出均为 JSON 文件。
- 插入模板时自动重映射节点 ID、平移到目标位置、恢复连线关系。

## 目录结构
- 清单：`public/templates/index.json`
- 内置模板：`public/templates/core/<template-id>.json`
- 缩略图（可选）：`public/templates/thumbs/<template-id>.png`
- 资源（可选，若不想内联到 JSON）：`public/templates/assets/...`

## index.json（清单）
- 每个模板一条记录，用于懒加载模板文件：
```json
[
  {
    "id": "basic-text-to-image",
    "name": "Prompt → Generate → Image",
    "category": "内置",
    "description": "基础流程：文本提示连接到生成节点，并显示到图像节点",
    "tags": ["basic", "generate"],
    "thumbnail": "/templates/thumbs/basic-text-to-image.png",
    "path": "/templates/core/basic-text-to-image.json"
  }
]
```

字段说明：
- `id`：模板标识（清单层面，不要求与模板文件内部 `id` 完全一致，但建议一致）。
- `name`：展示名称。
- `category`/`tags`/`description`：展示与搜索用。
- `thumbnail`：相对路径或 dataURL（可选）。
- `path`：模板 JSON 文件的相对路径（相对于网站根目录）。

## 模板 JSON 结构（v1）
顶层字段：
```json
{
  "schemaVersion": 1,
  "id": "<template-id>",
  "name": "<模板名称>",
  "category": "内置",
  "description": "可选介绍",
  "tags": ["basic"],
  "thumbnail": "可选，相对路径或 dataURL",
  "nodes": [ /* 节点数组 */ ],
  "edges": [ /* 连线数组 */ ]
}
```

节点（nodes）与连线（edges）：
```ts
// 节点
{
  id: string,
  type: 'textPrompt' | 'generate' | 'image' | 'three' | 'camera',
  position: { x: number, y: number },
  data: any,          // 仅保留配置数据；不要包含运行期字段
  boxW?: number,
  boxH?: number
}

// 连线
{
  id: string,
  source: string,
  target: string,
  sourceHandle?: string,
  targetHandle?: string,
  type?: string // 默认为 'default'
}
```

约定与建议：
- `data` 中不要包含运行时字段：`onRun`、`onSend`、`status`、`error` 等。
- 图片类字段：
  - 体积小：可直接使用 dataURL（`data:image/...;base64,...`）。
  - 体积大：建议设为 `null` 或使用相对资源路径，后续再扩展为 `$asset` 引用策略。
- 位置坐标：无需提前归一化；插入时会按模板内部最小 `x,y` 自动平移到点击位置。

### 最小示例
```json
{
  "schemaVersion": 1,
  "id": "basic-text-to-image",
  "name": "Prompt → Generate → Image",
  "nodes": [
    { "id": "tp1",  "type": "textPrompt", "position": { "x": 0,   "y": 0   }, "data": { "text": "画一只猫" }, "boxW": 240, "boxH": 180 },
    { "id": "gen1", "type": "generate",   "position": { "x": 300, "y": -40 }, "data": { "status": "idle" },            "boxW": 260, "boxH": 200 },
    { "id": "img1", "type": "image",      "position": { "x": 620, "y": -10 }, "data": { "imageData": null },           "boxW": 260, "boxH": 240 }
  ],
  "edges": [
    { "id": "e1", "source": "tp1",  "target": "gen1", "sourceHandle": "text", "targetHandle": "text", "type": "default" },
    { "id": "e2", "source": "gen1", "target": "img1", "sourceHandle": "img",  "targetHandle": "img",  "type": "default" }
  ]
}
```

## 内置模板：手动添加流程
1. 在 `public/templates/core/` 新建你的模板 JSON 文件。
2. 在 `public/templates/index.json` 追加一条清单记录，`path` 指向你的 JSON 文件。
3. （可选）把缩略图放到 `public/templates/thumbs/`，并在清单中填写 `thumbnail` 路径。
4. 重新启动/刷新应用，打开「添加面板 → 模板」页签，即可看到并插入。

## 本地 JSON “上传”为用户模板
无需改动代码，可通过以下方式将任意 JSON 存入用户模板库：
- 在「添加面板」中点击「导入」，选择你的模板 JSON（它会把模板直接放到当前画布）。
- 切换至「模板」页签，点击「保存为模板」。
  - 若当前存在选区，则仅保存选中的节点；否则保存当前画布的所有节点与连线。
- 之后在「我的模板」列表即可看到并随时插入（数据存于 IndexedDB）。

## 使用要点
- 插入位置：在画布上双击打开添加面板，模板会按双击处插入（系统自动平移）。
- ID 冲突：插入时会自动生成新 ID 并重写连线，无需人工处理。
- 体积控制：为确保加载速度，建议避免在模板中内联大体积图片。
- 兼容性：当前 `schemaVersion` 为 1；未来若有字段变更，将通过迁移器兼容旧模板。

## 常见问题
- 模板看不到？请确认 `index.json` 中的 `path` 是否正确、文件是否存在；浏览器刷新后重试。
- 插入后没有图片？如模板中为 `null` 或资源未内联，属预期行为，可在工作流中通过生成或外部输入得到图片。
- 导入失败？请检查 `schemaVersion` 与节点 `type` 是否在当前版本白名单内。

---
如需新增字段或策略（例如变量占位、资源分离 `$asset`、模板间依赖等），建议先更新本说明与模板 JSON 的 schema 版本后再实施。

