# 认证与项目系统

本篇概述前端认证流、受保护路由与项目内容的读写模型，并与后端接口对齐。

## 概览

- 认证形态：Cookie + JWT（访问令牌 + 刷新令牌），详见 `docs/Server-后端功能说明.md`
- 前端模式：`VITE_AUTH_MODE=server`（默认联后端）或 `mock`（本地模拟登录用于纯前端体验）
- 受保护路由：未登录禁止访问 `/workspace`、`/app` 等核心页面
- 项目系统：列表、创建、重命名、删除，内容读写（OSS 为主，DB 为回退）

## 前端认证流

- 存放位置：`src/stores/authStore.ts` + `src/services/authApi.ts`
- 关键点：
  - `authApi.meDetailed()` 会优先请求 `/api/auth/me`，失败尝试 `/api/auth/refresh`，最终回退本地持久化用户。
  - `login / login-sms / register / logout` 与后端接口对应；Mock 模式下走本地存储模拟。
  - 前端会在登录成功后写入本地会话，用于开发场景“刷新不中断”。

常用接口（后端）：
- `POST /api/auth/register`
- `POST /api/auth/login`
- `POST /api/auth/send-sms`
- `POST /api/auth/login-sms`
- `GET /api/auth/me`
- `POST /api/auth/refresh`
- `POST /api/auth/logout`

受保护路由：
- 组件：`src/routes/ProtectedRoute.tsx`
- 逻辑：在路由层检查 `authStore.user` 与 `loading`，未登录跳转 `/auth/login`

## 项目系统（前端）

- 存放位置：`src/services/projectApi.ts` + `src/pages/Workspace.tsx` + `src/stores/projectStore.ts`
- 能力：
  - `list()`：`GET /api/projects`
  - `create()`：`POST /api/projects`（返回 `id`，随即导航到 `/app?projectId=...`）
  - `get()` / `update()` / `remove()`：基础 CRUD
  - `getContent()` / `saveContent()`：项目内容读写，后端负责 OSS 优先、DB 回退与版本号维护

项目内容（概要）：
- 结构在 `src/types/project.ts`，包含 `paperJson`、图层、画布状态、AI 会话等。
- 版本号随每次保存递增，后端返回 `version` 与 `updatedAt`。

## 项目系统（后端）

详见 `docs/Server-后端功能说明.md`：

- `GET /api/projects`：列出我的项目
- `POST /api/projects`：创建（初始化 `ossPrefix/mainKey` 与初始 JSON）
- `GET /api/projects/:id/content`：优先 OSS，失败/缺失回退 DB `contentJson`
- `PUT /api/projects/:id/content`：写 OSS；同时更新 DB 作为回退并递增 `contentVersion`

## 使用流程建议

1) 登录/注册 → 进入 `/workspace`
2) 新建项目 → 导航至 `/app?projectId=...`
3) 在画布与工具中创作（自动保存启用）
4) 需要时手动保存或导出，返回工作台管理项目

